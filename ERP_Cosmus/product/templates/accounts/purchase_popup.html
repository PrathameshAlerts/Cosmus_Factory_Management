{% extends 'misc/navbar_popup.html' %}
{% load static %}
{% block body %}



        <div class="modal-header">
          <h3 class="modal-title" id="exampleModalLabel">Item Name: </h3> 
          <h3 class="modal-title" id="exampleModalLabel">shade Name:</h3>
          
        <div class="">
            <form method="post" id="" enctype="multipart/form-data">
                {% csrf_token %}
                <table class="table table-striped table-hover" id="newTable">
                    <thead>
                        <tr>
                            <th>Godowns</th>
                            <th>Quantity</th>
                            <th>Rate</th>
                            <th>Amount</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody class="mainTableList">
                      
                        {{godown_formsets.management_form}}
                        {% for g_forms in godown_formsets %}
                        <tr>
                            <td><select name="{{g_forms.prefix}}-godown_select" id="{{g_forms.prefix}}-godown_select" class="purchase-input godown-select" value="">
                                {% if g_forms.instance.id %}
                                <option value="{{g_forms.instance.godown_select.id}}">{{g_forms.instance.godown_select.godown_name_raw}}</option>

                                {% for godown in item_godowns_raw %}
                                <option value="{{godown.id}}">{{godown.godown_name_raw}}</option>
                                {% endfor %}


                                {% elif not g_forms.instance.id %}
                                <option value=""></option>
                                {% for godown in item_godowns_raw %}
                                <option value="{{godown.id}}">{{godown.godown_name_raw}}</option>
                                {% endfor %}
                               {% endif %}

                            </select></td>
                            <td><input type="number" name="{{g_forms.prefix}}-quantity" id="{{g_forms.prefix}}-quantity" class="purchase-input godown-quantity" value=""></td>
                            <td><input type="number" name="{{g_forms.prefix}}-rate"  id="{{g_forms.prefix}}-rate" class="purchase-input godown-rate" value="">
                            </td>
                            <td><input type="number" name="{{g_forms.prefix}}-amount"  id="{{g_forms.prefix}}-amount" class="purchase-input godown-amount" value="" readonly>
                            </td>
                            <td><button class="border-0 bg-transparent delete-btn" ><i class="fa-solid fa-trash text-danger px-2"></button></td>
                                <input type="number" class="purchase-amount" name="grand_godown_quantity" id ="grand_godown_quantity" value="" maxlength="50" step=".01">
                                <input type="number" class="purchase-amount" name="grand_godown_rate" id ="grand_godown_rate" value="" maxlength="50" step=".01"  >
                                <input type="number" class="purchase-amount" name="grand_godown_amount" id ="grand_godown_amount" value="" maxlength="50" step=".01"  >
                            </tr>
                            
                        {% endfor %}
                </table>
               <button type="button" class="create-btn" id="addModalButton">Add +</button>
               <input type="submit" class="add_btn">
            </form>
            
        </div>
    
    <script>
        $(document).ready (function(){

            $(document).on('click', '#addModalButton', function() {
        var newTableValue = document.getElementById('id_shade_godown_items_set-TOTAL_FORMS');
        var formsValue = parseInt(newTableValue.value);
        
        var tableClone = $('#exampleModal').find('#newTable tbody tr').last().clone(true);
        
            //update the input name and id for the new row
        const newGodownItem = tableClone.find('select[name^="shade_godown_items_set-"][name$="-godown_select"]');
        newGodownItem.attr('name', 'shade_godown_items_set-' + formsValue + '-godown_select');
        newGodownItem.attr('id', 'id_shade_godown_items_set-' + formsValue + '-godown_select');
        newGodownItem.val('');
      

        const newQuantity = tableClone.find('input[name^="shade_godown_items_set-"][name$="-quantity"]');
        newQuantity.attr('name', 'shade_godown_items_set-' + formsValue + '-quantity');
        newQuantity.attr('id', 'id_shade_godown_items_set-' + formsValue + '-quantity');
        newQuantity.val('');
       

        const newRate = tableClone.find('input[name^="shade_godown_items_set-"][name$="-rate"]');
        newRate.attr('name', 'shade_godown_items_set-' + formsValue + '-rate');
        newRate.attr('id', 'id_shade_godown_items_set-' + formsValue + '-rate');
        newRate.val('');
       

        const newAmount = tableClone.find('input[name^="shade_godown_items_set-"][name$="-amount"]');
        newAmount.attr('name', 'shade_godown_items_set-' + formsValue + '-amount');
        newAmount.attr('id', 'id_shade_godown_items_set-' + formsValue + '-amount');
        newAmount.val('');

        $('#newTable tbody').append(tableClone);

        newTableValue.value = formsValue + 1;

       
        
    });
   // This funcion calculate the amount for each row then set the total amount and total quantity
    function calculateNewRow(row) {
        var inputQty = row.find('.godown-quantity[name^="shade_godown_items_set-"][name$="-quantity"]').val();
        var inputQtyValue = parseInt(inputQty);
        var inputRate = row.find('.godown-rate[name^="shade_godown_items_set-"][name$="-rate"]').val();
        var inputRateValue = parseInt(inputRate);
        var totalAmount = row.find('.godown-amount[name^="shade_godown_items_set-"][name$="-amount"]').val();
    
        // Calculate and set the amount for this row
        var amount = inputQtyValue * inputRateValue;
        
        totalAmount = isNaN(amount) ? '' : amount.toFixed(2);
        row.find('.godown-amount[name^="shade_godown_items_set-"][name$="-amount"]').val(totalAmount);
        
        return amount;
       
    }
    // calculate the total quantity
    function calculateQty(row) {
        var inputQty = row.find('.godown-quantity[name^="shade_godown_items_set-"][name$="-quantity"]').val();
        var inputQtyValue = parseInt(inputQty);
        return inputQtyValue;
      
    }
    function calculateRate(row){
        var inputRate = row.find('.godown-rate[name^="shade_godown_items_set-"][name$="-rate"]').val();
        var inputRateValue = parseInt(inputRate);
        return inputRateValue;
    }
    // Function to calculate total amount
    function calculateGodownAmount() {
        var total = 0;
        var totalRate = 0;
        var totalQty = 0;
        // Iterate over each row in the table body
        $('#newTable tbody tr').each(function() {
        var newAmount = calculateNewRow($(this));
        var newQty = calculateQty($(this));
        var newRate = calculateRate($(this));
        totalQty += newQty;
        totalRate = newRate;
        total += newAmount;
        });
        // Update the total amount field
        $('#grand_godown_amount').val(total);
        $('#grand_godown_quantity').val(totalQty);
        $('#grand_godown_rate').val(totalRate);
    }


    $(document).on('input', '.godown-quantity' &&' .godown-rate', function() {
            //call the calculation function when qunatity and rate is changed   
            calculateGodownAmount();

        })
        
        // Delete row from delete button
       $(document).on('click', '.delete-btn', function(){
        var tableRows = $('#newTable tbody tr');
          if (tableRows.length > 1) { // Check if the table has only one row
        var row = $(this).closest('tr');
        row.remove();
        calculateGodownAmount();

    } else {
        alert('Table must have at least one godown item');
    }
          
        });

        })
    </script>







{% endblock body %}