{% extends 'product/base.html' %} 
{% load static %} 

{% block body %} 
<div>
        <h2>Purchase invoice</h2>
        <form class="mt-5" action="" method="POST">
            {% csrf_token %}
       
        <div class="d-flex mb-3">
            <label for="id_purchase_number"  class="item-form">Purchase No</label>
            <input type="number" class="item-select" name="purchase_number" id ="id_purchase_number" value="{{form.instance.purchase_number}}" maxlength="255" required >
        </div>
        <div class="d-flex mb-3">
            <label for="id_supplier_invoice_number" class="item-form" >Supplier Invoice No</label>
            <input type="number" class="item-select" name="supplier_invoice_number" id ="id_supplier_invoice_number" value="{{form.instance.supplier_invoice_number}}" maxlength="255" required >
        </div>
        <div class="d-flex mb-3">
            <label for="id_ledger_type" class="item-form" >ledger Type</label>
            <input type="text" class="item-select" name="ledger_type" id ="id_ledger_type" value="{{form.instance.ledger_type}}" maxlength="50" default='Purchase' readonly required placeholder="Purchase" >
        </div>
        <div class="d-flex mb-3">
            <label for="id_party_name" class="item-form" >Party A/C Name</label>
            <select class="item-select" name="party_name" required id="id_party_name">
            {% if form.instance.id %}
            {% for x in party_names %}
            <option value="{{x.id}}">{{x.name}}</option>
            {% endfor %}
            {% elif not form.instance.id %}
            <option value=""></option>
            {% endif %}
            {% for x in party_names %}
            <option value="{{x.id}}">{{x.name}}</option>
            {% endfor %}
    
            </select>
        </div>
        
        <button type="button" class="create-btn" id="addRowButton">Add +</button>
    <div class="">
        <table class="table table-striped table-hover table-responsive myTable">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Item Name</th>
                    <th>Colour</th>
                    <th>Shade</th>
                    <th>Quantity</th>
                    <th>Rate</th>
                    <th>Per</th>
                    <th>Amount</th>
                    <th>DELETE</th>
                </tr>
            </thead>
            <tbody>
                {{formset.management_form}}
                {% for forms in formset %}
                {{ shade_form.id }}
                <tr>
                    <td>{{forloop.counter}}</td>
                    <td> 
                        <select name="item_name" class="item-select" placeholder="Item Name" required id="item_name">
                            <option value=""></option>
                            {% for item in items %}
                            <option value="{{item.id}}">{{item.item_name}}</option>
                            {% endfor %}
                          </select>
                    </td>
                    <td>
                        <input type="text" name="item_color" id="item_color" class="item-select readonly">
                    </td>
                    <td>
                        <select name="{{forms.prefix}}-item_shade" class="item-select" placeholder="Item Shades" required id="{{forms.prefix}}-item_shade">
                        </select>
                    </td>
                    <td>
                        <input type="text" id="{{forms.prefix}}-quantity_total" class="purchase-input" name="{{forms.prefix}}-quantity_total" value="{{forms.instance.quantity_total | default_if_none:'' }}">
                    </td>
                    <td>
                        <input type="text" id="{{forms.prefix}}-rate" class="purchase-input" name="{{forms.prefix}}-rate" value="{{forms.instance.rate | default_if_none:''}}">
                    </td>
                    <td>
                        <input type="text" name="item_unit" id="item_unit" class="purchase-input">
                    </td>
                    <td>
                        <input type="text" id="{{forms.prefix}}-amount" class="item-select" name="{{forms.prefix}}-amount" value="{{forms.instance.amount | default_if_none:''}}" style="border: none;">
                    </td>
                    <td>{{ shade_form.DELETE }}</td>
                 </tr>   
            </tbody>
            {% endfor %}
        </table>
    </div>
        

<div class="table-left">
    <div class="d-flex mb-3">
        <label for="id_fright_transport" class="item-form" >Fright & Transport</label>
        <input type="number" class="item-select" name="fright_transport" id ="id_fright_transport" value="{{form.instance.fright_transport}}" maxlength="50" required >

    </div>
    <div class="d-flex mb-3">
        <label for="id_gross_total" class="item-form" >Gross total</label>
        <input type="number" class="item-select" name="gross_total" id ="id_gross_total" value="{{form.instance.gross_total}}" maxlength="50" required > 
    </div>
    <div class="d-flex mb-3">
        <label for="id_gst_rate" class="item-form" >GST
            <select class="" name="gst_rate" required id="id_gst_rate">
                {% if form.instance.id %}
                {% for x in Purchase_gst %}
                <option value="{{x.id}}">{{x.gst_percentage}}</option>
                {% endfor %}
                {% elif not form.instance.id %}
                <option value=""></option>
                {% endif %}
                {% for x in Purchase_gst %}
                <option value="{{x.id}}">{{x.gst_percentage}}</option>
                {% endfor %}
            </select>
        </label>
        <input type="number" class="item-select" name="" value="" id="id_gst" readonly>
    </div>
    <div class="d-flex mb-3">
        <label for="id_grand_total" class="item-form" >Grand total</label>
          <input type="text" class="item-select" name="grand_total" value="{{form.instance.grand_total}}" id="id_grand_total" readonly >
    </div>
</div>

 </form>

 <script>
    $(document).ready(function () { 
        $('#item_name').change(function () {
            var item_value = $(this).val();
            var formSet = $('#id_purchase_voucher_items_set-TOTAL_FORMS');
            var totalForms = parseInt(formSet.val());
            var nextForm = 0;
            
            for (var i = 0; i < totalForms; i++) {
            var itemShadeSelect = $('#purchase_voucher_items_set-' + i + '-item_shade');
            if (itemShadeSelect.length >= 0) {
                nextForm = i;
                console.log(nextForm) ;
                break;
            }
        }

                
            $.ajax({
                url: '/purchasevouchercreate/',
                method: 'GET',
                data: {
                    'item_value': item_value,
                },
                success: function (response) {
                    console.log('Data sent successfully')
                
                    $(itemShadeSelect).empty().append('<option value="">Select Shade</option>');

                    var itemcolorinput = document.querySelector('#item_color');
                    var item_color = response.item_color;
                    var item_shade_response = response.item_shade; 
                
                    var itemperinput = document.querySelector('#item_unit')
                    var itemperinput_response = response.item_per;
            
                    itemcolorinput.value = item_color;
                    itemperinput.value = itemperinput_response;
                   
                    $.each(item_shade_response, function (key, value) {
                        $(itemShadeSelect).append('<option value="' + key + '">' + value + '</option>');
                    });
                    
                },
                
                error: function (xhr, errmsg, err) {
                    console.log('Error sending value to the backend');
                }
               
            });
            
            }
            
        );
        var popupWindow = null; // Variable to hold the reference to the popup window

        $('#shades').change(function () {
            var selectedShade = $(this).val();
            if (selectedShade !== "") {
                if (popupWindow === null || popupWindow.closed) { // Check if no popup is open or the existing one is closed
                    var minWidth = 800;
                    var minHeight = 600;
                    $.ajax({
                        // Use Django URL name to fetch the URL dynamically
                        url: '{% url "purchasevoucher-createpopup-ajax" %}',
                        method: 'GET',
                        data: {
                            'selected_shade': selectedShade
                        },
                         success: function (response) {
                            // Open the dynamic URL received from the server
                            popupWindow = window.open(response.popup_url, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
                        },
                        error: function (xhr, errmsg, err) {
                            console.log('Error getting popup URL');
                        }
                    });
                } else {
                    // If a popup window is already open, notify the user or take appropriate action
                    console.log('A popup window is already open');
                }
            }
        });
    });
</script>





























 <script>
    function calculateTotalAmount() {
        var totalAmount = 0;
        var rows = document.querySelectorAll('table tbody tr');
        rows.forEach(function(row) {
            var quantity = parseFloat(row.querySelector('[name="quantity"]').value);
            var rate = parseFloat(row.querySelector('[name="rate"]').value);
            var total = quantity * rate;
            row.querySelector('.total-amount').innerText = total.toFixed(2); // Display total amount in two decimal places
            totalAmount += total;
        });
        
        // Update gross total
        var grossTotalElement = document.getElementById('grossTotal');
        if (grossTotalElement) {
            grossTotalElement.innerText = totalAmount.toFixed(2);
        }
        // Calculate GST
        var gstAmount = totalAmount * 0.12; // Assuming GST rate is 12%
        var gstAmountElement = document.getElementById('gstAmount');
        if (gstAmountElement) {
            gstAmountElement.innerText = gstAmount.toFixed(2);
        }
        // Update final amount (grand total)
        var finalAmount = totalAmount + gstAmount + 5000; // Adding freight and transport
        var finalAmountElement = document.getElementById('finalAmount');
        if (finalAmountElement) {
            finalAmountElement.innerText = finalAmount.toFixed(2);
        }
    }
  
    // Function to add event listeners to quantity and rate inputs
    function addEventListenersToInputs() {
        var inputs = document.querySelectorAll('table tbody tr input[type="number"]');
        inputs.forEach(function(input) {
            input.addEventListener('input', function() {
                calculateTotalAmount();
            });
        });
    }
  
    // Event listener for the add row button
    document.getElementById('addRowButton').addEventListener('click', function () {
        var newRow = document.querySelector('table tbody tr').cloneNode(true); // Clone the first row of the table
        newRow.querySelector('[name="quantity"]').value = ""; // Clear quantity field
        newRow.querySelector('[name="rate"]').value = ""; // Clear rate field
        document.querySelector('table tbody').appendChild(newRow); // Append the cloned row to the table body
        addEventListenersToInputs(); // Add event listeners to the new row inputs
        calculateTotalAmount(); // Calculate total amount for the new row
    });
  
    // Call function to add event listeners to existing rows' inputs
    addEventListenersToInputs();
    // Call calculateTotalAmount initially to calculate total on page load
    calculateTotalAmount();
  </script>


{% endblock body %}
