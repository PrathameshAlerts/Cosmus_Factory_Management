{% extends 'product/base.html' %} 
{% load static %} 

{% block body %} 
<div>
        <h2>Purchase invoice</h2>
      <form class="mt-5" action="" method="POST">
           {% csrf_token %}
       <div class="d-flex mb-3">
      <label for="" class="form-label px-2">Purchase No:</label>
      <input type="number" class="item-select mx-3" value="" name="" maxlength="50" required id="">
    </div>
    <div class="d-flex mb-3">
        <label for="" class="form-label px-2">Supplier invoice No:</label>
        <input type="number" class="item-select mx-3" value="" name="" maxlength="50" required id="">
      </div>
    <div class="d-flex mb-3">
      <label for="" class="form-label px-2">Purchase Ledger: </label>
      <p>Purchase</p>
    </div>
    <div class="d-flex mb-3">
      <label for="" class="form-label px-2">Party A/C Name: </label>
      <select class="item-select" name="" id="">
        <option value=""></option>
        {% for partyname in party_names %}
        <option value="{{partyname.name}}">{{partyname.name}}</option>
        {% endfor %}
      </select>
    </div>
    <button type="button" class="create-btn" id="addRowButton">Add +</button>
    <div class="">
      <table class="table table-striped table-hover table-responsive myTable">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Colour</th>
            <th>Shade</th>
            <th>Quantity</th>
            <th>Rate</th>
            <th>Per</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <select name="name" class="item-select" placeholder="Item Name" required id="name">
                <option value=""></option>
                {% for item in items %}
                <option value="{{item.id}}">{{item.item_name}}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input type="text" name="color" class="item-select" placeholder="Item Color" required id="color" readonly >
            </td>
            <td>
            <select name="shades" class="item-select" placeholder="Item Shades" required id="shades">
              
            </select>
          </td>
            <td>
              <input type="number" name="quantity" class="item-select" placeholder="Quantity" required id="quantity">
            </td>
            <td>
              <input type="number" name="rate" class="item-select" placeholder="Rate" required id="rate">
            </td>
            <td>
              <input type="text" name="units" class="input_units" id="units" readonly>
            </td>
            <td class="total-amount"></td>
        </tr>
         
        </tbody>
      </table>
      <div class="table-left">
        <div class="d-flex mb-3">
          <p>Frieght & Transport:</p>
          <span id="transportValue" class="fw-bold px-2">5000</span>
      </div>
      <div class="d-flex mb-3">
          <p>Gross Total: </p>
          <span id="grossTotal" class="fw-bold px-2"></span>
      </div>
      <div class="d-flex mb-3">
          <p>GSt 12%:</p>
          <span id="gstAmount" class="fw-bold px-2"></span>
      </div>
      <div class="d-flex mb-3">
          <p>Grand Total RS </p>
          <span id="finalAmount" class="fw-bold px-2"></span>
      </div>
      
      </div>
      
    </div>
    
    <input type="submit" class="product2_btn" name="save" value="Save">
    <!-- <input type="submit" class="create-btn" name="save_and_add_another" value="Save and Add Another">
   <button type="button" class="create-btn"><a  class="text-decoration-none text-white" href="">Return</a></button> -->
  </form>
  </div>
 
  


  <script>
    $(document).ready(function () {
        $('#name').change(function () {
            var item_value = $(this).val();
            $.ajax({
                url: '/purchasevouchercreate/',
                method: 'GET',
                data: {
                    'item_value': item_value,
                },
                success: function (response) {
                    console.log('Data sent successfully')
                    $('#shades').empty().append('<option value="">Select Shade</option>');

                    var itemcolorinput = document.querySelector('#color');
                    var item_color = response.item_color;
                    var item_shade = response.item_shade;

                    itemcolorinput.value = item_color

                    $.each(item_shade, function (key, value) {
                        $('#shades').append('<option value="' + key + '">' + value + '</option>');
                    });
                },
                error: function (xhr, errmsg, err) {
                    console.log('Error sending value to the backend');
                }
            });
        });
        var popupWindow = null; // Variable to hold the reference to the popup window

        $('#shades').change(function () {
            var selectedShade = $(this).val();
            if (selectedShade !== "") {
                if (popupWindow === null || popupWindow.closed) { // Check if no popup is open or the existing one is closed
                    var minWidth = 800;
                    var minHeight = 600;
                    $.ajax({
                        // Use Django URL name to fetch the URL dynamically
                        url: '{% url "purchasevoucher-createpopup-ajax" %}',
                        method: 'GET',
                        data: {
                            'selected_shade': selectedShade
                        },
                        success: function (response) {
                            // Open the dynamic URL received from the server
                            popupWindow = window.open(response.popup_url, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
                        },
                        error: function (xhr, errmsg, err) {
                            console.log('Error getting popup URL');
                        }
                    });
                } else {
                    // If a popup window is already open, notify the user or take appropriate action
                    console.log('A popup window is already open');
                }
            }
        });
    });
</script>
 
  <script>
    function calculateTotalAmount() {
        var totalAmount = 0;
        var rows = document.querySelectorAll('table tbody tr');
        rows.forEach(function(row) {
            var quantity = parseFloat(row.querySelector('[name="quantity"]').value);
            var rate = parseFloat(row.querySelector('[name="rate"]').value);
            var total = quantity * rate;
            row.querySelector('.total-amount').innerText = total.toFixed(2); // Display total amount in two decimal places
            totalAmount += total;
        });
        
        // Update gross total
        var grossTotalElement = document.getElementById('grossTotal');
        if (grossTotalElement) {
            grossTotalElement.innerText = totalAmount.toFixed(2);
        }
        // Calculate GST
        var gstAmount = totalAmount * 0.12; // Assuming GST rate is 12%
        var gstAmountElement = document.getElementById('gstAmount');
        if (gstAmountElement) {
            gstAmountElement.innerText = gstAmount.toFixed(2);
        }
        // Update final amount (grand total)
        var finalAmount = totalAmount + gstAmount + 5000; // Adding freight and transport
        var finalAmountElement = document.getElementById('finalAmount');
        if (finalAmountElement) {
            finalAmountElement.innerText = finalAmount.toFixed(2);
        }
    }
  
    // Function to add event listeners to quantity and rate inputs
    function addEventListenersToInputs() {
        var inputs = document.querySelectorAll('table tbody tr input[type="number"]');
        inputs.forEach(function(input) {
            input.addEventListener('input', function() {
                calculateTotalAmount();
            });
        });
    }
  
    // Event listener for the add row button
    document.getElementById('addRowButton').addEventListener('click', function () {
        var newRow = document.querySelector('table tbody tr').cloneNode(true); // Clone the first row of the table
        newRow.querySelector('[name="quantity"]').value = ""; // Clear quantity field
        newRow.querySelector('[name="rate"]').value = ""; // Clear rate field
        document.querySelector('table tbody').appendChild(newRow); // Append the cloned row to the table body
        addEventListenersToInputs(); // Add event listeners to the new row inputs
        calculateTotalAmount(); // Calculate total amount for the new row
    });
  
    // Call function to add event listeners to existing rows' inputs
    addEventListenersToInputs();
    // Call calculateTotalAmount initially to calculate total on page load
    calculateTotalAmount();
  </script>




{% endblock body %}
