{% extends 'product/base.html' %} 
{% load static %} 

{% block body %} 
<div>
        <h2>Purchase invoice</h2>
        <form class="mt-5" action="" method="POST">
            {% csrf_token %}
       
        <div class="d-flex mb-3">
            <label for="id_purchase_number"  class="item-form">Purchase No</label>
            <input type="number" class="item-select" name="purchase_number" id ="id_purchase_number" value="{{master_form.instance.purchase_number}}" maxlength="255" required >
        </div>
        <div class="d-flex mb-3">
            <label for="id_supplier_invoice_number" class="item-form" >Supplier Invoice No</label>
            <input type="number" class="item-select" name="supplier_invoice_number" id ="id_supplier_invoice_number" value="{{master_form.instance.supplier_invoice_number}}" maxlength="255" required >
        </div>
        <div class="d-flex mb-3">
            <label for="id_ledger_type" class="item-form" >ledger Type</label>
            <input type="text" class="item-select" name="ledger_type" id ="id_ledger_type" value="{{master_form.instance.ledger_type}}" maxlength="50" default='Purchase' readonly required placeholder="Purchase" >
        </div>
        <div class="d-flex mb-3">
            <label for="id_party_name" class="item-form" >Party A/C Name</label>
            <select class="item-select" name="party_name" required id="id_party_name">
            {% if master_form.instance.id %}
            {% for x in party_names %}
            <option value="{{x.id}}">{{x.name}}</option>
            {% endfor %}
            {% elif not master_form.instance.id %}
            <option value=""></option>
            {% endif %}
            {% for x in party_names %}
            <option value="{{x.id}}">{{x.name}}</option>
            {% endfor %}
    
            </select>
        </div>
        
    <div class="">
        <table id="myTable" class="table table-striped table-hover table-responsive">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Item Name</th>
                    <th>Colour</th>
                    <th>Shade</th>
                    <th>Quantity</th>
                    <th>Rate</th>
                    <th>Units</th>
                    <th>Amount</th>
                    <th>DELETE</th>
                </tr>
            </thead>
            <tbody id="tbody">
                {{items_formset.management_form}}
                
                <div id="formset-container">
                    {% for forms in items_formset %}
                        <div class="formset-form">
                            {% if forms.instance.pk %}
                                <!-- For existing instances (update) -->
                                {% for field in form %}
                                    <p>{{ field.label_tag }} {{ field }}</p>

                                {% endfor %}
                            {% else %}
                                <!-- For new instances (create) -->
                                <!-- Render the fields as you normally would for a new instance -->
                                <p> {{ form.item_name }}</p>
                                <p> {{ form.item_color}}</p>
                            {% endif %}
                        </div>
            
                </div>
                {% endfor %} 
            
            
            
            </tbody>
           


        </table>
        <button type="button" class="create-btn" id="add-form">Add +</button>
    </div>

           

<div class="table-left">
    <div class="d-flex mb-3">
        <span class="item-form fw-bold">Fright & Transport</span>
        <input type="number" class="purchase-amount" name="fright_transport" id ="id_fright_transport" value="{{master_form.instance.fright_transport}}" maxlength="50" step=".01" required >

    </div>
    <div class="d-flex mb-3">
        <span  class="item-form fw-bold" >Gross total</span>
        <input type="number" class="purchase-amount" name="gross_total" id ="id_gross_total" value="{{master_form.instance.gross_total}}" maxlength="50" >
    </div>
    <div class="d-flex mb-3">
        <label for="id_gst_rate" class="item-form fw-bold" >GST
            <select class="rounded-1" name="gst_rate" required id="id_gst_rate">
                {% if master_form.instance.id %}
                <option value="{{master_form.instance.gst_rate.id}}">{{master_form.instance.gst_rate.gst_percentage}}</option>
                {% for x in Purchase_gst %}
                <option value="{{x.id}}">{{x.gst_percentage}}</option>
                {% endfor %}
                
                {% elif not master_form.instance.id %}
                <option value=""></option>
                {% for x in Purchase_gst %}
                <option value="{{x.id}}">{{x.gst_percentage}}</option>
                {% endfor %}
                {% endif %}
            </select>
        </label>
        <input type="number" step="0.01" class="purchase-amount" name="" value="" id="id_gst" > 
    </div>
    <div class="d-flex mb-3">
        <label for="id_grand_total" class="item-form fw-bold" >Grand total</label>
          <input type="text" class="purchase-amount" name="grand_total" value="{{master_form.instance.grand_total}}" id="id_grand_total">
    </div>
</div>



<input type="submit" class="add_btn">
 </form>


 <script>
    
    $(document).ready(function () {
        var itemName;
        var lastSelectedItem = '';
        $(document).on('click', 'select[name^="item_name_"]', function () {
        itemName = $(this).closest('tr').find('select[name^="purchase_voucher_items_set-"]').attr('name');
      
    });
     $(document).on('change', 'select[name^="item_name_"]', function () {
            var item_value = $(this).val();          
            $.ajax({
                url: '/purchasevouchercreate/',
                method: 'GET',
                data: {
                    'item_value': item_value,
                },
                success: function (response) {
                    console.log('Data sent successfully')
                    itemrownameid = itemName.split('-')[1];
                 
                    $('#' + itemName).empty().append('<option value="">Select Shade</option>');
                    

                    var itemcolorinput = document.querySelector('#item_color_' +itemrownameid);
                    var item_color = response.item_color;
                 
                    
                    var itemperinput = document.querySelector('#item_per_' +itemrownameid);
                    var itemperinput_response = response.item_per;
                    
                    itemcolorinput.value = item_color;
                    itemperinput.value = itemperinput_response;



                    var item_shade_response = response.item_shade;
                    

                    $.each(item_shade_response, function (key, value) {
                        $('#' + itemName).append('<option value="' + key + '">' + value + '</option>');
                     
                    });
                    
                
                },
                
                error: function (xhr, errmsg, err) {
                    console.log('Error sending value to the backend');
                }
               
            });
            
        });
        $(document).on('change', 'select[name^="purchase_voucher_items_set-"]', function () {
            var selectedItem = $(this).val();
            
            // Toggle the visibility of the shade table
            if (selectedItem === lastSelectedItem) {
                $('#shadeTable').toggle();
            } else {
                $('#shadeTable').show();
                lastSelectedItem = selectedItem; // Update the last selected item
            }
        });
    });
 </script>
 <script>
     document.addEventListener('DOMContentLoaded', function () {
    const addButton = document.getElementById('addRowButton');
    const tableBody = document.querySelector('#myTable tbody');
    let totalForms = tableBody.children.length;
    
    if(addButton && tableBody) {
    addButton.addEventListener('click', function () {
        const formCountInput = document.getElementById("id_purchase_voucher_items_set-TOTAL_FORMS");
        const formCount = parseInt(formCountInput.value);
        console.log(formCount);
        
        const newRow = document.createElement('tr');
       
        newRow.innerHTML = `
           
            <td>${totalForms - 3}</td>
            <td>
                <select name="item_name_${totalForms - 4}" class="item-select item-name"  id="item_name_${totalForms - 4}">
                
                   {% if forms.instance.id %}
                            <option value="{{forms.instance.item_shade.items.id}}">{{forms.instance.item_shade.items.item_name}}</option>
                            
                            {% elif not forms.instance.id %}
                            <option value=""></option>
                            {% endif %}
                            {% for item in items %}
                            <option value="{{item.id}}">{{item.item_name}}</option>
                            {% endfor %}
                    

                </select>
            </td>
            <td>
                <input type="text" name="item_color_${totalForms - 4}" class="purchase-input" readonly value="{% if forms.instance.id %} {{ forms.instance.item_shade.items.Item_Color.color_name }}{% endif %}" id="item_color_${totalForms - 4}" id="item_color_${totalForms - 4}">
            </td>
            <td>
                <select name="purchase_voucher_items_set-${totalForms - 4}-item_shade" class="item-select item-shade" id="purchase_voucher_items_set-${totalForms - 4}-item_shade">
                   
                    {% if forms.instance.id %} 
                             <option value="{{forms.instance.item_shade.id}}">{{forms.instance.item_shade.item_shade_name}}</option>

                             {% elif not forms.instance.id %}
                             <option value=""></option>
                             {% endif %}

                </select>
            </td>
            <td>
                <input type="number" name="purchase_voucher_items_set-${totalForms - 4}-quantity_total" class="purchase-input purchase-qunatity" value="{{forms.instance.quantity_total | default_if_none:'' }}" id="purchase_voucher_items_set-${totalForms - 4}-quantity_total">
            </td>
            <td>
                <input type="number" name="purchase_voucher_items_set-${totalForms - 4}-rate" class="purchase-input purchase-rate" value="{{forms.instance.rate | default_if_none:''}}" id="purchase_voucher_items_set-${totalForms - 4}-rate">
            </td>
            <td>
                <input type="text" name="item_per_${totalForms - 4}" class="purchase-input" value="{% if forms.instance.id %} {{ forms.instance.item_shade.items.unit_name_item.unit_name }}{% endif %}" id="item_per_${totalForms - 4}" readonly>
            </td>
            <td>
                <input type="number" name="purchase_voucher_items_set-${totalForms - 4}-amount" class="total-amount purchase-amount" readonly value="{{forms.instance.amount | default_if_none:''}}" id="purchase_voucher_items_set-${totalForms - 4}-amount" style="border: none">
            </td>
            <td>delete</td>
            <td><input type="hidden" name="purchase_voucher_items_set-${totalForms - 4}-id" value="{{forms.instance.id}}" id="id_purchase_voucher_items_set-${totalForms - 4}-id"></td>
         
        `;
        tableBody.appendChild(newRow);
        
        totalForms++;
        addEventListenersToInputs(newRow);
        calculateTotalAmount();
    });
    
};

    function addEventListenersToInputs() {
        var inputs = document.querySelectorAll('table tbody tr input');
        inputs.forEach(function(input) {
            input.addEventListener('change', function() {
                calculateTotalAmount();
            });
        });
    }
      

    function calculateTotalAmount() {
        var rows = document.querySelectorAll('table tbody tr');
        var totalAmount = 0;
        
        // Iterate through each row
        rows.forEach(function(row) {
            // Find the quantity, rate, and amount input fields for the current row
            
            var quantityInput = row.querySelector('.purchase-qunatity[name^="purchase_voucher_items_set-"]');
            var rateInput = row.querySelector('.purchase-rate[name^="purchase_voucher_items_set-"]');
            var amountInput = row.querySelector('.total-amount[name^="purchase_voucher_items_set-"]');
            
    
            // Get the values of quantity and rate
            var quantity = parseFloat(quantityInput.value);
            var rate = parseFloat(rateInput.value);
         
            // Calculate the amount for the current row

           var amount = quantity * rate;
        
            // Set the calculated amount value to the amount input field
            amountInput.value = isNaN(amount) ? '' : amount.toFixed(2);

            // Add the amount to the total
            totalAmount += amount;
            
            
        });

        // Get the value of the fright & transport
        var frightTransport = parseFloat(document.getElementById('id_fright_transport').value) ;

        // Calculate the gross total by adding the total amount and the fright & transport
        var grossTotal = totalAmount + frightTransport;

        // Set the calculated gross total value to the gross total input field
        document.getElementById('id_gross_total').value = grossTotal.toFixed(2);

        // Get the value of GST rate
        var gstRate = parseFloat(document.getElementById('id_gst_rate').value);

        // Calculate GST amount
        var gstAmount = (grossTotal * gstRate) / 100;

        // Set the calculated GST value to the GST input field
        document.getElementById('id_gst').value = gstAmount.toFixed(2);

        // Calculate grand total by adding gross total and GST amount
        var grandTotal = grossTotal + gstAmount;

        // Set the calculated grand total value to the grand total input field
        document.getElementById('id_grand_total').value = grandTotal.toFixed(2);
    }

    // Call the function initially to calculate total amount, GST, and grand total on page load
    calculateTotalAmount();

    // Add onchange event handler to id_fright_transport
    document.getElementById('id_fright_transport').addEventListener('input', calculateTotalAmount);
   
    // Add onchange event handler to id_gst_rate
    document.getElementById('id_gst_rate').addEventListener('change', calculateTotalAmount);
    // Function to add event listeners to quantity and rate inputs
   
    
});

 </script> 
 <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('add-form').addEventListener('click', function() {
            var formsetContainer = document.getElementById('formset-container');
            var totalFormsField = document.getElementById('id_form-TOTAL_FORMS');
            var totalForms = parseInt(totalFormsField.value);
            var newFormIndex = totalForms;

            // Construct the HTML for the new form fields
            var newFormHTML = `
                <div class="formset-form">
                   
		 <select  name="form-${newFormIndex}-item_name" id="id_form-${newFormIndex}-item_name"></p>

                    
		<input type="text" name="form-${newFormIndex}-item_color" id="id_form-${newFormIndex}-item_color"></p>
                </div>
            `;

            // Append the new form HTML to the formset container
            formsetContainer.insertAdjacentHTML('beforeend', newFormHTML);

            // Increment the total forms count
            totalFormsField.value = totalForms + 1;
        });
    });
</script>





{% endblock body %}