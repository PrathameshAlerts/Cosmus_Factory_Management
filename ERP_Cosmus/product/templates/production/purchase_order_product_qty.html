{% extends 'product/base.html' %}
{% load static %}
{% block body %}

<div class="d-flex mb-3">
    <span>Total Qty : <input class="text-danger purchase-amount border-0 bg-transparent" id="id_total-quantity"value="{{total_quantity}}"> </span>
    <span>Grand Total: <input type="number" class="purchase-amount border-0 bg-transparent" name="grand_quantity" id ="id_grand_quantity" value="" maxlength="50" step=".01"></span>
            
</div>

    

<form method="POST">
    {% csrf_token %}
<div class="row">
    <div class="col-lg-4"> 
        <table class="table table-striped table-hover table-bordered" id="productTable">
            <thead class="name_absolute text-nowrap">
                <tr>
                    <th>Product Sku</th>
                    <th>Color</th>
                    <th>Order Quantity</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody class="mainTableList">
                {{formset.management_form}}
                {% for form in formset %}
                {{form.id}}
                <tr>
                    <td class="text-nowrap">
                        <input type="text" class="item-select border-0 bg-transparent" name="{{form.prefix}}-product_id" value="{{form.instance.product_id.PProduct_SKU | default_if_none:''}}" id="id_{{form.prefix}}-product_id" readonly>
                    </td>
                    <td>
                        <input type="text" class="item-select border-0 bg-transparent" name="{{forloop.counter0}}-product_color" value="{{form.instance.product_id.PProduct_color | default_if_none:''}}" id="id_{{forloop.counter0}}-product_color" readonly>
                    </td>
                    <td>
                        <input type="number" class="purchase-input " name="{{form.prefix}}-order_quantity" value="{{form.instance.order_quantity|default_if_none:'0'}}" id="id_{{form.prefix}}-order_quantity">
                    </td>
                    <td><span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 "><input type="checkbox" class="godown_delete px-2" style="display: none;"   name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value="" ></i></span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>
   
</div>
<button>Return</button>
<input type="submit" class="create-btn mt-4" >
</form>



    

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to update the total quantity and manage the input fields
    function updateTotalQuantity() {
        var totalQuantity = 0;
        var formCount = parseInt(document.getElementById('id_purchase_order_to_product_set-TOTAL_FORMS').value);
        var totalAllowedQuantity = parseFloat(document.getElementById('id_total-quantity').value);
        var grandQuantityElement = document.getElementById('id_grand_quantity');
        var quantities = [];

        // Calculate the total quantity from all form inputs
        for (var i = 0; i < formCount; i++) {
            var quantityElement = document.getElementById('id_purchase_order_to_product_set-' + i + '-order_quantity');
            var quantityValue = parseFloat(quantityElement.value);
            if (!isNaN(quantityValue)) {
                totalQuantity += quantityValue;
            }
            quantities.push({element: quantityElement, value: quantityValue});
        }
        
        // Update the grand total quantity field
        grandQuantityElement.value = totalQuantity;
        console.log('totalQuantity', totalQuantity);
        console.log('totalAllowedQuantity', parseFloat(grandQuantityElement.value));

        // If the total quantity exceeds the allowed quantity, disable the excess input fields
        if (totalQuantity >= totalAllowedQuantity) {
            var runningTotal = 0;
            quantities.forEach(function(q) {
                runningTotal += q.value;
                if (runningTotal > totalAllowedQuantity) {
                    q.element.value = '0'; // Clear the value
                    q.element.readOnly = true; // Disable the input field
                } else {
                    q.element.readOnly = false; // Ensure it's enabled if within the limit
                }
            });
        } else {
            // Enable all input fields if the total quantity is within the allowed limit
            quantities.forEach(function(q) {
                q.element.readOnly = false; // Enable the input field
            });
        }
    }

    // Attach event listeners to the quantity input fields
    var formCount = parseInt(document.getElementById('id_purchase_order_to_product_set-TOTAL_FORMS').value);
    for (var i = 0; i < formCount; i++) {
        var quantityElement = document.getElementById('id_purchase_order_to_product_set-' + i + '-order_quantity');
        quantityElement.addEventListener('input', updateTotalQuantity); // Trigger update on input change
    }

    // Initial calculation on page load
    updateTotalQuantity();
});



    
        //Delete row from delete button click then ajax request sent to backend foe deletion a row from table
        $(document).on('click', '.delete-btn', function() {
            
            var tableRows = $('#productTable tbody tr'); 
            if (tableRows.length > 1) { 
                var row = $(this).closest('tr'); 
               
                var checkbox = row.find('.godown_delete[name^="purchase_order_to_product_set-"][name$="-DELETE"]');
                
                checkbox.prop('checked', true);
                checkbox.val('true');
               
                if(checkbox.val() == 'true'){
    
                row.hide();
                deleteRowCalculate();
                }
                  
            } else {
                alert('The table must have at least one godown item'); 
            }
         
            
            });
    
    </script>

{% endblock %}