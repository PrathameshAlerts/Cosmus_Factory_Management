{% extends 'product/base.html' %}
{% load static %}
{% block body %}

<form method="post" class="mt-2" id="labourWorkInForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-lg-5">
            <h5 class="fw-bold mt-2 text-danger mb-3">Labour Workin Create</h5>
            <span id="labourWorkInError" class="error-messagescuttingCreate"></span>
            <div class="d-flex mb-3">
                <label for="id_voucher_number" class="item-form">GRN No:</label>
                {% if not master_form.instance.id %}
                <input type="number" class="item-select" name="voucher_number" value="{{master_form.voucher_number.initial}}" required id="id_voucher_number">
                {% else %}
                <input type="number" class="item-select" name="voucher_number" value="{{master_form.instance.voucher_number}}" required id="id_voucher_number">
                {% endif %}

            </div>
            <div class="d-flex mb-3">
                <label for="id_labour_name" class="item-form">Labour Name:</label>
                <div class="custom-dropdown-container">
                    <input  type="text" name="labour_name" id="id_labour_name" class="item-select search-input"  placeholder="Labour Name" autocomplete="off" value="{% if master_form.instance.instance.id %}{{master_form.instance.labour_voucher_number.labour_name.name}}{% endif %}"  > 
                    <div name="labour_search" class="item-select item-name s-suggestion-container item-select_input" id="labour_search" style="display: none; height:auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Labour Name" >
                      
                     </div>
                </div>
            </div>
        </div>
    </div>
    <div>
        <span> TESTTT{{labour_workout_instance_dict}}</span>
        <table class="table table-bordered table-hover table-striped" id="tableLabourWorkinId" style="display: none;">
            <thead>
                <tr>
                    <th>Challan No</th>
                    <th>P.O No</th>
                    <th>PO Total QTY</th>
                    <th>Ref No </th>
                    <th>Model Name</th>
                    <th>Issued QTY</th>
                    <th>Rec QTY</th>
                    <th>Balance QTY</th>
                </tr>
            </thead>
            
            <tbody class="mainTableList">
                {% for instance in labour_workout_instance_dict %}
        <tr>
            <td class="challanNo">{{ instance.Challan_No }}</td>
            <td>{{ instance.PO_No }}</td>
            <td>{{ instance.PO_Total_QTY }}</td>
            <td>{{ instance.Ref_No }}</td>
            <td>{{ instance.Model_Name }}</td>
            <td>32</td> <!-- Example static value for Issued QTY -->
            <td>23</td> <!-- Example static value for Rec QTY -->
            <td>23</td> <!-- Example static value for Balance QTY -->
        </tr>
        {% endfor %}
    </tbody>

        </table>
    </div>
    <div class="row" id="labourWorkInFormAfterClick" style="display: none;">
        <div class="col-lg-5">
            <div class="d-flex mb-3">
                <label for="id_challan_no" class="item-form">Challan no:</label>
                {% if not master_form.instance.id %}

                <input type="text" class="item-select" name="challan_no" value="{{master_form.challan_no.initial}}"required id="id_challan_no" readonly style="outline-color: blue;">
                {% else %}

                <input type="text" class="item-select" name="challan_no" value="{{master_form.instance.labour_voucher_number.challan_no}}" required id="id_challan_no" readonly style="outline-color: blue;">
                {% endif %}
            </div>
            <div class="d-flex mb-3">
                <label for="id_purchase_order_no" class="item-form">PO.No:</label>

                {% if not master_form.instance.id %}

                <input type="text" class="item-select" name="purchase_order_no" value="{{master_form.purchase_order_no.initial}}" required id="id_purchase_order_no" readonly style="outline-color: blue;">
                {% else %}
                <input type="text" class="item-select" name="purchase_order_no" value="{{master_form.instance.labour_voucher_number.labour_workout_master_instance.purchase_order_cutting_master.purchase_order_id.purchase_order_number}}" required id="id_purchase_order_no" readonly style="outline-color: blue;">

                {% endif %}
            </div>
            <div class="d-flex mb-3">
                <label for="id_refrence_number" class="item-form">Refrence No:</label>
                {% if not master_form.instance.id %}


                <input type="number" class="item-select" name="refrence_number" value="{{master_form.refrence_number.initial}}" required id="id_refrence_number" readonly style="outline-color: blue;">

                {% else %}
                <input type="number" class="item-select" name="refrence_number" value="{{master_form.instance.labour_voucher_number.labour_workout_master_instance.purchase_order_cutting_master.purchase_order_id.product_reference_number.Product_Refrence_ID}}" required id="id_refrence_number" readonly style="outline-color: blue;">

                {% endif %}

            </div>
            <div class="d-flex mb-3">
                <label for="id_model_name" class="item-form">Model Name:</label>

        {% if not master_form.instance.id %}

    <input type="text" class="item-select" name="model_name" value="{{master_form.model_name.initial}}" required id="id_model_name" readonly style="outline-color: blue;">

    {% else %}
    <input type="text" class="item-select" name="model_name" value="{{master_form.instance.labour_voucher_number.labour_workout_master_instance.purchase_order_cutting_master.purchase_order_id.product_reference_number.Model_Name}}" required id="id_model_name" style="outline-color: blue;">
    
    {% endif %}

    </div>
    <div class="d-flex mb-3">
        <label for="id_total_p_o_qty" class="item-form">Total PO. Qty:</label>
        {% if not master_form.instance.id %}
        <input type="number" class="item-select" name="total_p_o_qty" value="{{master_form.total_p_o_qty.initial}}" id="id_total_p_o_qty" readOnly style="outline-color: blue;">
        {% else %}

        <input type="number" class="item-select" name="total_p_o_qty" value="{{master_form.instance.labour_voucher_number.labour_workout_master_instance.purchase_order_cutting_master.purchase_order_id.number_of_pieces}}" id="id_total_p_o_qty" style="outline-color: blue;"readOnly>

        {% endif %}
    </div>
        <div class="d-flex mb-3">
            <label for="id_labour_workout_qty" class="item-form">Total Issued Qty:</label>

            {% if not master_form.instance.id %}

            <input type="number" class="item-select" name="labour_workout_qty" value="{{master_form.labour_workout_qty.initial}}" required id="id_labour_workout_qty" readonly style="outline-color: blue;">

            {% else %}
            <input type="number" class="item-select" name="labour_workout_qty" value="{{master_form.instance.labour_voucher_number.total_process_pcs}}" required  id="id_labour_workout_qty" readonly style="outline-color: blue;">

            {% endif %}

        </div>
    <div class="d-flex mb-3">
        <label for="id_description" class="item-form">Naration:</label>
    <input type="text" class="item-select" name="description" maxlength="100" value="{{master_form.instance.description | default_if_none:''}}" required id="id_description">
    </div>
        </div>
        
        <div class="col-lg-5">
           
            <table class="table table-striped table-hover table-bordered tables">
                <thead class="name_absolute sticky-top">
                    <tr>
                        <th>Product Sku</th>
                        <th>Color</th>
                        <th>Issue QTY</th>
                        <th>Balance QTY</th>
                        <th>Return QTY</th>
                    </tr>
                </thead>
                <tbody class="mainTableList">
                    {{labour_work_in_product_to_item_formset.management_form}}
                    {% for form in labour_work_in_product_to_item_formset %}
                    {{form.id}}
                    {% if not form.instance.id %}
                    <tr>
                        <td><input type="text"class="productinput" name="{{form.prefix}}-product_sku" value="{{form.initial.product_sku}}" maxlength="100" id="id_{{form.prefix}}-product_sku"></td>
                        <td><input type="text" class="productinput" name="{{form.prefix}}-product_color" value="{{form.initial.product_color}}" maxlength="100" id="id_{{form.prefix}}-product_color"></td>
                        <td><input type="number" class="productorderrawqty-input" name="{{form.prefix}}-L_work_out_pcs" value="{{form.initial.L_work_out_pcs}}" id="id_{{form.prefix}}-L_work_out_pcs"></td>
                        <td><input type="number" class="productorderrawqty-input" name="{{form.prefix}}-pending_to_return_pcs" value="{{form.initial.pending_to_return_pcs}}" id="id_{{form.prefix}}-pending_to_return_pcs"></td>
                        <td><input type="number" class="productorderqty-input" name="{{form.prefix}}-return_pcs" value="{{form.initial.return_pcs}}" id="id_{{form.prefix}}-return_pcs"></td>
                        <input type="hidden" class="productorderrawqty-input" name="{{form.prefix}}-Balance_pending_to_return_pcs" value="{{form.initial.pending_to_return_pcs}}" id="id_{{form.prefix}}-Balance_pending_to_return_pcs" readonly>
                    </tr>
                    {% elif form.instance.id %}
                    <tr>
                        <td><input type="text"class="productinput" name="{{form.prefix}}-product_sku" value="{{form.instance.product_sku}}" maxlength="100" id="id_{{form.prefix}}-product_sku"></td>
                        <td><input type="text" class="productinput" name="{{form.prefix}}-product_color" value="{{form.instance.product_color}}" maxlength="100" id="id_{{form.prefix}}-product_color"></td>
                        <td><input type="number" class="productorderrawqty-input" name="{{form.prefix}}-L_work_out_pcs" value="{{form.instance.L_work_out_pcs}}" id="id_{{form.prefix}}-L_work_out_pcs"></td>
                        <td><input type="number" class="productorderrawqty-input" name="{{form.prefix}}-pending_to_return_pcs" value="{{form.instance.pending_to_return_pcs}}" id="id_{{form.prefix}}-pending_to_return_pcs"></td>
                        <td><input type="number" class="productorderqty-input" name="{{form.prefix}}-return_pcs" value="{{form.instance.return_pcs}}" id="id_{{form.prefix}}-return_pcs"></td>
                    
                        <input type="hidden" class="productorderrawqty-input" name="{{form.prefix}}-Balance_pending_to_return_pcs" value="{{form.instance.pending_to_return_pcs}}" id="id_{{form.prefix}}-Balance_pending_to_return_pcs" readonly>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            <div class="d-flex mb-3">
                <label for="id_pending_pcs" class="item-form">Pending Pcs:</label>

                {% if not master_form.instance.id %}
                <input type="text" class="item-select" name="pending_pcs" value="{{ master_form.pending_pcs.initial }}"  required id="id_pending_pcs" readonly style="outline-color: blue;">

                {% else %}
                <input type="text" class="item-select" name="pending_pcs"
                    value="{{ master_form.instance.labour_voucher_number.labour_workin_pending_pcs }}" required id="id_pending_pcs" readonly style="outline-color: blue;">

                {% endif %}

            </div>
            <div class="d-flex mb-3">
                <label for="id_total_return_pcs" class="item-form">Total Return Pcs:</label>
                <input type="number" class="item-select" name="total_return_pcs" value="{{master_form.instance.total_return_pcs}}" required id="id_total_return_pcs" readonly>
            </div>
            <div class="d-flex mb-3">
                <label for="id_labour_charges" class="item-form">Labour charges:</label>

                {% if not master_form.instance.id %}

                <input type="number" class="item-select" name="labour_charges" step="0.01"value="{{master_form.labour_charges.initial}}" required id="id_labour_charges" >
                {% else %}

                <input type="number" class="item-select" name="labour_charges" step="0.01"
                    value="{{master_form.instance.labour_voucher_number.labour_workout_master_instance.purchase_order_cutting_master.purchase_order_id.product_reference_number.labour_charges}}"
                    id="id_labour_charges">

                {% endif %}
            </div>
            <div class="d-flex mb-3">
                <label for="id_other_charges" class="item-form">Other Charges:</label>
                <input type="number" class="item-select" value="{{master_form.instance.other_charges}}" name="other_charges" step="0.01" required id="id_other_charges">
            </div>
           
        </div>
    </div>
   

    <input type="submit" value="Submit" class="create-btn" id="id_submit" style="display: none;">
</form>
<script>
$(document).ready(function () {
    let enterValue = false;
    let index = 0; //  index outside of the event listener
    let indexbool = false;

    const suggestions = $('#labour_search')
    $(document).on('input','#id_labour_name',function(){

      const nameValue = $(this).val().trim();
     
        if(nameValue === '') {
          suggestions.css('display', 'none');
              $(this).attr('data-key', '');
              return;
        }
          if(!enterValue){             // Show the dropdown only if Enter key was not pressed
            suggestions.css('display', 'block');
            }
            enterValue = false;
    
    if(nameValue.length >= 1){
 
      $.ajax({
            url: '/labourworkinrawcreate/',
            method: 'GET',
            data: {
                'nameValue': nameValue
            },
            success: function (response) {
              const searchData = response.vendor_name_dict;
              function escapeRegExp(string) {
                       return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
               }
               const searchQuery = nameValue.toLowerCase();
               const escapedSearchQuery = escapeRegExp(searchQuery); // Escape special characters in search query
               const regex = new RegExp('(' + escapedSearchQuery + ')', 'gi');

               const filteredOptions = Object.entries(searchData).filter(([key, value]) => value.toLowerCase().includes(searchQuery));
       
                suggestions.empty();
                $.each(filteredOptions, function(index, [key, value]) {
                let highlightedText = value;
        
                if (searchQuery) {
                    highlightedText = value.replace(regex, '<span class="highlight">$1</span>');
                } 
                  suggestions.append(`<div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion " data-key="${key}">${highlightedText}</div>`);
                
                });
              
            },
            error:function(xhr){
            // console.log(xhr.status + ": " + xhr.responseText);
                if (xhr.status === 404 || xhr.status === 400) {
                  suggestions.css('display', 'block');
                  suggestions.empty().append(`<div" class="itemName-div itemName-div-suggestion ">No item found</div>`);
                }
        }
        });
    }else{
        suggestions.empty();
    }
    
        suggestions.on('click', '.itemName-div-suggestion', function() {
       
       $(this).closest('.custom-dropdown-container').find('.search-input').val($(this).text().trim());
       $(this).addClass('selected').siblings().removeClass('selected');
      var buttonClick = $(this).closest('form').find('#tableLabourWorkinId'); 
      console.log(buttonClick);
      buttonClick.css('display', 'block');
       const itemValue = $(this).attr('data-key');
       console.log(itemValue);
       $.ajax({
            url: '/labourworkinrawcreate/',
            method: 'GET',
            data: {
                'itemValue': itemValue
            },
            success: function (response) {
            var challan_instance = response.labour_workout_instance_dict
            console.log('challan_instance',challan_instance)
            },
            error: function (xhr, errmsg, err) {
                console.log('Error sending value to the backend');
            }
        })
        suggestions.css('display', 'none');
   })

    })
    
    
$(document).on('click', '.search-input',function(){
        var selectValue = $(this).next('.s-suggestion-container');
        selectValue.css('display', 'none');
        selectValue.empty();
})

    $(document).on('keydown', '[name^="labour_name"]', function (e) {
        const $inputField = $(this);
        const $dropdownOptions = $inputField.next('.s-suggestion-container');
        const $options = $dropdownOptions.find('.itemName-div');
        const optionsCount = $options.length - 1;
       
        const nameData = $inputField.val().trim();

        if(nameData === ''){
            index = 0;
            indexbool = false;
            return;
        }

        const newHeight = $inputField.offset();
        const windowHeight = $(window).height();
        const availableSpace = windowHeight - newHeight.top - $inputField.outerHeight();
         $dropdownOptions.css({
              'max-height': availableSpace + 'px',
              'overflow-y': 'auto'
         });
       if(e.key=== 'ArrowDown'){
          e.preventDefault();

          if(index <= optionsCount){
            const selectedItem = $options.eq(index);
            const nextItem = selectedItem.next();
            const nameDataKey= selectedItem.text();
            const nameKey = selectedItem.data('key');
                // Remove highlight from previously selected item   
            $options.removeClass('bg-highlight');
            selectedItem.addClass('bg-highlight');
            $inputField.attr('data-key', nameKey);
            $inputField.text(nameDataKey);
           
            const itemOffsetTop = nextItem.position() ? nextItem.position().top : 0;
            const itemHeight = nextItem.outerHeight();
            const selectScrollTop = $dropdownOptions.scrollTop();
            const selectHeight = $dropdownOptions.height();

            if (itemOffsetTop + itemHeight > selectHeight) {
                $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
            } else if (itemOffsetTop < 0) {
                $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
            }
             
          
            if(index !== optionsCount ){
                index += 1; 
             indexbool = true;        
            }     
                
          }else{
            index = 0;
          }
      
        }
          if(e.key === 'ArrowUp'){
            e.preventDefault(); 
            if (index != 0 && indexbool == true)
            {           
                  index = index - 1;
            }
            
            if(index <= selectLength){
          
           const selectedItem = $options.eq(index);
           const prevItem = selectedItem.prev();
           const nameDataKey= selectedItem.text();
           const nameKey = selectedItem.data('key');

            $options.removeClass('bg-highlight');
            selectedItem.addClass('bg-highlight');
            $inputField.attr('data-key', nameKey);
            $inputField.text(nameDataKey);
          
            const itemOffsetTop = prevItem.position() ? prevItem.position().top : 0;
            const itemHeight = prevItem.outerHeight();
            const selectScrollTop = $dropdownOptions.scrollTop();
            const selectHeight = $dropdownOptions.height();

            if (itemOffsetTop < 0) {
                $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
            } else if (itemOffsetTop + itemHeight > selectHeight) {
                $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
            }
              }
              else{
                      index = 0;
              }   
            
          }
          if(e.key === 'Enter'){
          e.preventDefault();
          const commomSugenstionHide = $inputField.closest('.custom-dropdown-container').find(`#labour_search`);
          const nameValues = $inputField.text().trim();
          const itemValue = $inputField.attr('data-key');
          console.log(itemValue);
          const dropdownBtn = $inputField.closest('form').find('#tableLabourWorkinId');
          dropdownBtn.css('display', 'block');
          if ($inputField.length > 0) {
              
            $inputField.val(nameValues);
           
            $.ajax({           // this ajax reuest is to send the data and show the all the option will filed once click on the suggestion on the screen
            url: '/labourworkinrawcreate/',
            method: 'GET',
            data: {
                'itemValue': itemValue
            },
            success: function (response) {
              
              var challan_instance = response.labour_workout_instance_dict
              console.log('challan_instance',challan_instance)
                 
            },
            error: function (xhr, errmsg, err) {
                console.log('Error sending value to the backend');
            }
        }); 
          }
          index = 0;
          indexbool = false;
          enterValue = true; // Set the flag to true when Enter is pressed
          commomSugenstionHide.css('display', 'none'); // Hide the dropdown
          commomSugenstionHide.empty();
        }    
    })
})    
</script>


<script>
    document.addEventListener("DOMContentLoaded", function(){
    //     const targetDate = document.getElementById('id_GRN_Date');
    //     const dates = new Date().toISOString().split('T')[0];
    //     const currentDate = new Date();
    //     const years = currentDate.getFullYear()
    //     const month = String(currentDate.getMonth() + 1).padStart(2, '0');
    //     const day = String(currentDate.getDate()).padStart(2, '0');
    //     const formattedDate = `${years}-${month}-${day}`;
    //     targetDate.setAttribute('min', formattedDate);
    //     targetDate.value = formattedDate;


    //     document.getElementById('id_labour_name').addEventListener('change',function(){
    //       var labourTables = document.getElementById('tableLabourWorkinId');
    //       labourTables.style.display = 'block'; 
    //       console.log(labourTables); 
         
          document.querySelector('.challanNo').addEventListener('click',function(){
            var labourCreateRow = document.getElementById('labourWorkInFormAfterClick');
            console.log(labourCreateRow);
            labourCreateRow.style.display = 'block';
            var tables = $(this).closest('#tableLabourWorkinId');
            console.log(tables);
            tables.css("display" ,"none");
            var submitBtn = document.getElementById('id_submit');
            submitBtn.style.display = 'block';
        })

    //     })

        
     })
   
    
</script>
{% endblock %}
