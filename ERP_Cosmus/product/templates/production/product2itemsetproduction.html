{% extends 'misc/navbar_popup.html' %}
{% load static %}
{% block body %}
<h3 class="mb-3">Add items Product</h3>

   <h5 class="me-5">Product Refrence No : <span class="text-capitalize text-danger">{{product_refrence_no}}</span></h5>
   <form method="post" enctype="multipart/form-data">
 
    {% csrf_token %}
    <table class="table table-responsive table-striped table-bordered" id="mainProductForm">
        <thead>
            <tr>
                <th>No</th>
                <th>Product Sku</th>
                <th>Item Name</th>
                <th>No of Rows</th>
                <th>Remark</th>
                <th>Delete</th>
            </tr>
        </thead>
       
        <tbody class="mainTableList">
            {{formset_single.management_form}}
            {% for form in formset_single %}
            {{ form.id }}
            <tr>
                <td>1</td>
               
                <td>
                    <select class="item-select" name="{{form.prefix}}-PProduct_pk" id="id_{{form.prefix}}-PProduct_pk">
                        <option value="{{form.instance.PProduct_pk.PProduct_SKU}}">{{form.instance.PProduct_pk.PProduct_SKU}}  {{form.instance.PProduct_pk.PProduct_color}}</option>
                        {% for product in Products_all %}
                        <option value="{{product.PProduct_SKU}}">{{product.PProduct_SKU}} - {{product.PProduct_color}}</option>
                        {% endfor %}
                    </select>

                </td>
                <td>
                    <select class="item-select" name="{{form.prefix}}-Item_pk" id="{{form.prefix}}-Item_pk">
                        
                        <option value="{{form.instance.Item_pk.id}}">{{form.instance.Item_pk.item_name}}</option>
                        {% for item in items %}
                        <option value="{{item.id}}">{{item.item_name}}</option>
                        {% endfor %}
                    </select>

                </td>
                <td> <input type="text" class="item-select me-3" name="{{form.prefix}}-no_of_rows" value="{{form.instance.no_of_rows}}" maxlength="255" id="id_{{form.prefix}}-no_of_rows"></td>
                <td> <input type="text" class="item-select me-3" name="{{form.prefix}}-Remark" value="{{form.instance.Remark | default_if_none:''}}"  maxlength="255" id="id_{{form.prefix}}-Remark"></td>
                <td><span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="product_Item_deleteId px-2" style="display: none;"  name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value="" ></i></span></td>
            </tr>
            {% endfor %}
        </tbody>
        
    </table>
    <button type="button" class="add_btn" id="addForm">Add</button>  
    <table class="table table-responsive table-striped table-bordered" id="productForm">
        <thead>
            <tr>
                <th>No</th>
                <th>Item Select</th>
                <th>No of Rows</th>
                <th>Remark</th>
                <th>Delete</th>
            </tr>
        </thead>
       
        <tbody class="mainTableList">
            {% for forms in formset %}
            {{ forms.id }}
            <tr>
                <td>{{forloop.counter}}</td>
                <td>
                    <select class="item-select" name="{{forms.prefix}}-Item_pk" id="{{forms.prefix}}-Item_pk">
                        
                        <option value="{{forms.instance.Item_pk.id}}">{{forms.instance.Item_pk.item_name}}</option>
                        {% for item in items %}
                        <option value="{{item.id}}">{{item.item_name}}</option>
                        {% endfor %}
                    </select>

                </td>
              
                    <td> <input type="text" class="item-select me-3" name="{{forms.prefix}}-product_common_item_name" value="{{forms.instance.Item_pk.item_name}}"  maxlength="255" id="{{forms.prefix}}-product_common_item_name" ></td>
              
                <td> <input type="text" class="item-select me-3" name="{{forms.prefix}}-product_common_item_name" value="{{forms.instance.Item_pk.item_name}}"  maxlength="255" id="{{forms.prefix}}-product_common_item_name" ></td>
                <td><span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="product_Item_deleteId px-2" style="display: none;"  name="{{forms.prefix}}-DELETE" id="id_{{forms.prefix}}-DELETE" value="" ></i></span></td>
            </tr>
            {% endfor %}
        </tbody>
        
    </table>
    
            
<button type="button" class="add_btn" id="addNewRow">Add</button>  
<input type="submit" class="add_btn" >
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addFormButton = document.getElementById('addForm');
        const tableBody = document.querySelector('#mainProductForm tbody');

        if( addFormButton && tableBody) {
        addFormButton.addEventListener('click', function() {
        let lastVisibleRow = null;
        tableBody.querySelectorAll('tr').forEach(row => {
            if (window.getComputedStyle(row).display !== 'none') {
                lastVisibleRow = row;
            }
        });
        if (lastVisibleRow) {
            var forms = document.getElementById('id_product2itemuniqueformset-TOTAL_FORMS');
            var newFormCount = parseInt(forms.value) ;
            console.log(newFormCount);
            var newTable = lastVisibleRow.cloneNode(true);
            newTable.querySelectorAll("input select").forEach(function(e) {
            e.value= "";
          });

    
         
            const newSelectElement = newTable.querySelector('select[name^="product2itemuniqueformset-"][name$="PProduct_pk"]');
            newSelectElement.id = `id_product2itemuniqueformset-${newFormCount}-PProduct_pk`;
            newSelectElement.name = `product2itemuniqueformset-${newFormCount}-PProduct_pk`;
            newSelectElement.value = '';

            const selectValueName = newTable.querySelector('select[name^="product2itemuniqueformset-"][name$="Item_pk"]');
            selectValueName.id = `id_product2itemuniqueformset-${newFormCount}-Item_pk`;
            selectValueName.name = `product2itemuniqueformset-${newFormCount}-Item_pk`;
            selectValueName.value = '';


            const inputElement = newTable.querySelector('input[name^="product2itemuniqueformset-"][name$="no_of_rows"]');
            inputElement.id = `id_product2itemuniqueformset-${newFormCount}-no_of_rows`;
            inputElement.name = `product2itemuniqueformset-${newFormCount}-no_of_rows`;
            inputElement.value = '';

            const inputRemark = newTable.querySelector('input[name^="product2itemuniqueformset-"][name$="Remark"]');
            inputRemark.id = `id_product2itemuniqueformset-${newFormCount}-Remark`;
            inputRemark.name = `product2itemuniqueformset-${newFormCount}-Remark`;
            inputRemark.value = '';


            const deleteElement = newTable.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="DELETE"]');
            deleteElement.id = `id_product2itemuniqueformset-${newFormCount}-DELETE`;
            deleteElement.name = `product2itemuniqueformset-${newFormCount}-DELETE`;
            deleteElement.value = '';
            deleteElement.checked = false;


            forms.value = newFormCount + 1;

            tableBody.appendChild(newTable);
            deleteRow();

        }else {
            console.error("No visible rows found to clone.");
        }   
        });
    }

    function deleteRow(){
// Add click event listener to all delete buttons
document.querySelectorAll('.delete-btn').forEach(function(button) {
    button.addEventListener('click', function() {
        // Find the row containing the clicked delete button
        var row = this.closest('tr');
        console.log("row",row);
        var checkRow = row.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="-DELETE"]');
        if (checkRow) {
            checkRow.checked = true; // Mark as checked
            checkRow.value = 'true'; // Set the value to 'true'

            row.style.display = 'none';

        } else {
            console.error("Checkbox for deletion not found in this row");
        }
    });
});

};
deleteRow();
    });

 

</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addFormButton = document.getElementById('addNewRow');
        const tableBody = document.querySelector('#productForm tbody');

        if( addFormButton && tableBody) {
        addFormButton.addEventListener('click', function() {
        let lastVisibleRow = null;
        tableBody.querySelectorAll('tr').forEach(row => {
            if (window.getComputedStyle(row).display !== 'none') {
                lastVisibleRow = row;
            }
        });
        if (lastVisibleRow) {
            var forms = document.getElementById('id_product_2_item_through_table_set-TOTAL_FORMS');
            var newFormCount = parseInt(forms.value) ;
            var newTable = lastVisibleRow.cloneNode(true);
            newTable.querySelectorAll("input select").forEach(function(e) {
            e.value= "";
          });



            const selectElement = newTable.querySelector('select[name^="product_2_item_through_table_set-"][name$="Item_pk"]');
            selectElement.id = `product_2_item_through_table_set-${newFormCount}-Item_pk`;
            selectElement.name = `product_2_item_through_table_set-${newFormCount}-Item_pk`;
            selectElement.value = '';


            const inputNameValue = newTable.querySelector('input[name^="product_2_item_through_table_set-"][name$="product_common_item_name"]');
            inputNameValue.id = `product_2_item_through_table_set-${newFormCount}-product_common_item_name`;
            inputNameValue.name = `product_2_item_through_table_set-${newFormCount}-product_common_item_name`;
            inputNameValue.value = '';


            const inputElement = newTable.querySelector('input[name^="product_2_item_through_table_set-"][name$="product_common_item_name"]');
            inputElement.id = `product_2_item_through_table_set-${newFormCount}-product_common_item_name`;
            inputElement.name = `product_2_item_through_table_set-${newFormCount}-product_common_item_name`;
            inputElement.value = '';

            const deleteElement = newTable.querySelector('.product_Item_deleteId[name^="product_2_item_through_table_set-"][name$="DELETE"]');
            deleteElement.id = `product_2_item_through_table_set-${newFormCount}-DELETE`;
            deleteElement.name = `product_2_item_through_table_set-${newFormCount}-DELETE`;
            deleteElement.value = '';
            deleteElement.checked = false;


            forms.value = newFormCount + 1;

            tableBody.appendChild(newTable);
            deleteRow();

        }else {
            console.error("No visible rows found to clone.");
        }   
        });
    }

    function deleteRow(){
// Add click event listener to all delete buttons
document.querySelectorAll('.delete-btn').forEach(function(button) {
    button.addEventListener('click', function() {
        // Find the row containing the clicked delete button
        var row = this.closest('tr');
        console.log("row",row);
        var checkRow = row.querySelector('.product_Item_deleteId[name^="product_2_item_through_table_set-"][name$="-DELETE"]');
        if (checkRow) {
            checkRow.checked = true; // Mark as checked
            checkRow.value = 'true'; // Set the value to 'true'

            row.style.display = 'none';

        } else {
            console.error("Checkbox for deletion not found in this row");
        }
    });
});

};
deleteRow();
    });

 

</script>
    {% endblock body %} 