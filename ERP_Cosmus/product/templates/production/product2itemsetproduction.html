{% extends 'misc/navbar_popup.html' %}
{% load static %}
{% block body %}

<h5 class="me-5">Product Refrence No : <span class="text-capitalize text-danger">{{product_refrence_no}}</span></h5>
<form method="post" enctype="multipart/form-data" id="myProductForm" autocomplete="off">
    {% csrf_token %}
    <div class="d-flex">
        <h4 class="mb-3">Add Unique Product</h3>
        <button type="button" class="add_btn mb-3" id="itemCreate" onclick="openItemCreatePopup()">Add Item</button>
    </div>
 
        <div class="">
         
            <table class="table table-striped table-bordered" id="mainProductForm">
                <thead class="text-nowrap name_absolute">
                    <tr>
                        <th>No</th>
                        <th>Product Sku</th>
                        <th>Item Name</th>
                        <th>Rows</th>
                        <th>Total</th>
                        <th>Remark</th>
                        <th>Delete</th>
                        <th>Add Row</th>
                    </tr>
                </thead>
        
                <tbody class="mainTableList">
                   
                    {{formset_single.management_form}}
                    
                    {% for form in formset_single %}
            
                    <tr>
                        {{ form.id }}
                        <td> <input type="hidden"  id="id_{{form.prefix}}-row_number" name="{{form.prefix}}-row_number" class="Serial_no" value="{{forloop.counter}}" readonly>
                            <input type="number"  id="id_serial_no_unique-{{forloop.counter0}}" class="Serial_no" value="{{forloop.counter}}" readonly>
                        </td>
            
                        <td>
                            <select class=" productSelect" name="{{form.prefix}}-PProduct_pk"
                                id="id_{{form.prefix}}-PProduct_pk">
                                <option value="{{form.instance.PProduct_pk.PProduct_SKU}}">
                                    {{form.instance.PProduct_pk.PProduct_SKU}} &nbsp; &nbsp;
                                    {{form.instance.PProduct_pk.PProduct_color}}</option>
                                {% for product in Products_all %}
                                <option value="{{product.PProduct_SKU}}">{{product.PProduct_SKU}} &nbsp;
                                    &nbsp;{{product.PProduct_color}}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <span id="uniqueError" class="error-messagesorderCreate"></span>
                            <div class="custom-dropdown-container">
                                <input type="hidden" name="{{form.prefix}}-Item_pk" id="id_{{form.prefix}}-Item_pk" class="product2Select input_hidden-value" value="{% if form.instance.id %}{{ form.instance.Item_pk.id }}{% endif %}">
                                <input type="text" name="{{form.prefix}}-Item_pks" id="id_{{form.prefix}}-Item_pks" class="product2Select input_text search-input" placeholder="Item Name" autocomplete="off" value="{% if form.instance.id %}{{ form.instance.Item_pk.item_name }}{% endif %}">
                                <div name="itemName_{{forloop.counter0}}" id="id_itemName_{{forloop.counter0}}" class="item-select item-name s-suggestion-container" style="display: none; height: auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Item Name">
                                </div>
                            </div>
                        </td>
                        <td><input type="text" class="product_row" name="{{form.prefix}}-no_of_rows" required value="{{form.instance.no_of_rows}}" maxlength="255" id="id_{{form.prefix}}-no_of_rows"></td>
                        <td><input type="number" class="product_remark" name="{{form.prefix}}-grand_total" value="{{form.instance.grand_total | default_if_none:''}}" maxlength="255" id="id_{{form.prefix}}-grand_total" readonly></td>
                        <td><input type="text" class="product_remark" name="{{form.prefix}}-Remark" value="{{form.instance.Remark | default_if_none:''}}" maxlength="255" id="id_{{form.prefix}}-Remark"></td>
                        <td><span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="product_Item_deleteId px-2" style="display: none;" name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value=""></i></span></td>
                        <td><input type="button" class="add_btn mb-3 add_btn_row" name="{{form.prefix}}-add_btn" id="id_{{form.prefix}}-add_btn" value="+" style="display: none;" ></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <input type="number" class="product_row" name="productNoRow" id="id_productNoRow" value="1">
        <button type="button" class="add_btn mb-4" id="addForm">Add</button>
        
        <div>
            
                <h4 class="mb-3">Add common Items</h3>
                <table class="table table-responsive table-striped table-bordered" id="myProduct">
                    <thead class="text-nowrap name_absolute">
                        <tr>
                            <th>No</th>
                            <th>Item Name</th>
                            <th>Rows</th>
                            <th>Total</th>
                            <th>Remark</th>
                            <th>Delete</th>
                            <th>Add Row</th>
                        </tr>
                    </thead>
                    <tbody class="mainTable">
                        {{formset_common.management_form}}
                        {% for forms in formset_common %}
                  
                        <tr>
                            {{ forms.id }}
                            <td><input type="number"  id="id_serial_no-{{forloop.counter0}}" class="Serial_no" value="{{forloop.counter}}">
                                <input type="hidden"  id="id_{{forms.prefix}}-row_number" name="{{forms.prefix}}-row_number" class="Serial_no" value="{{forloop.counter}}">
                            </td>
                            
                            <td>
                                <span id="purchaseCreateError" class="error-messagesorderCreate"></span>
                                <div class="custom-dropdown-container">
                                    <input type="hidden" name="{{forms.prefix}}-Item_pk" id="id_{{forms.prefix}}-Item_pk" class="product2Select commom_item_hidden" value="{% if forms.instance.id %}{{ forms.instance.Item_pk.id }}{% endif %}">
                                    <input type="text" name="{{forms.prefix}}-Item_pks" id="id_{{forms.prefix}}-Item_pks" class="product2Select commom_item search-input" placeholder="Item Name" autocomplete="off" value="{% if forms.instance.id %}{{ forms.instance.Item_pk.item_name}}{% endif %}" data-key="">
                                    <div name="item_input_Name_{{forloop.counter0}}" id="id_item_input_Name_{{forloop.counter0}}" class="item-select item-name s-suggestion-container" style="display: none; height: auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Item Name">
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="product_row" name="{{forms.prefix}}-no_of_rows" required value="{{forms.instance.no_of_rows}}" maxlength="255"id="id_{{forms.prefix}}-no_of_rows"></td>
                            <td><input type="number" class="product_remark" name="{{forms.prefix}}-grand_total" value="{{forms.instance.grand_total | default_if_none:''}}" maxlength="255" id="id_{{forms.prefix}}-grand_total" readonly></td>
                            <td><input type="text" class="product_remark" name="{{forms.prefix}}-Remark" value="{{forms.instance.Remarks}}" maxlength="255" id="id_{{forms.prefix}}-Remark"></td>
                            <td><span class="deleteButton border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="product_deleteId px-2" style="display: none;" name="{{forms.prefix}}-DELETE" id="id_{{forms.prefix}}-DELETE"value=""></i></span></td>
                            <td><input type="button" class="add_btn add_btn_CommonForm mb-3" name="{{forms.prefix}}-add_btns" id="id_{{forms.prefix}}-add_btns" value="+" style="display: none;"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <input type="number" class="product_row" name="commonNoRow" id="id_commonNoRow" value="1">
                <button type="button" class="add_btn mb-3" id="addNewRow">Add</button>
        </div>
        <input type="submit" class="create-btn" id="id_submitForms">
    </form>


<script>
    let formSubmitted = false;
    var newPopupWindow = null;
    document.getElementById('myProductForm').addEventListener('submit', function() {
    formSubmitted = true;
  });

  function openItemCreatePopup(button){
    openItem(button, '{% url "item-create-popup" %}');
  }

  function openItem(button,url){
    if (newPopupWindow === null || newPopupWindow.closed) {
    newItemwindow(button, url);
  } else {
  
    newPopupWindow.focus();
  }
  }

  function newItemwindow(button, path){
    // Specify minimum height and width
  var minWidth = 800; // minimum width
  var minHeight = 700; // minimum height

  // Open new page with specified dimensions
  newPopupWindow = window.open(path, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
    // Ensure only one event listener is attached
   
}

 // Handle the case when the window is closed without form submission
    window.addEventListener('beforeunload', function (event) {
        if (!formSubmitted) {
            const data = { message: 'close' };
            window.opener.postMessage(data, '*');
        }
    });


    $(document).ready(function () {
        let newValueKey;
        let enterValue = false;
        let index = 0; //  index outside of the event listener
        let indexbool = false;
        let purchaseData;
        let enterPressed = false;

        //this ajax reuest to product to uniuque item list and search the item and display in the dropdown
        $(document).on('input ', 'input[name^="product2itemuniqueformset-"][name$="Item_pks"]', function () {
            newValueKey = $(this).attr('name').split('-')[1];
            const nameValue = $(this).val().trim();
            const suggestionsContainerUniqueId = $(`#id_itemName_${newValueKey}`);
            const selectValue = $(this).next('.s-suggestion-container');
            const selectedItem = $(this).find('.s-suggestion-container').find(`#itemName-div_${index}`);

            if (nameValue === '') {
                suggestionsContainerUniqueId.css('display', 'none');
                var errorForm = $(this).closest('tr').find('.error-messagesorderCreate');
                errorForm.hide();
                $(this).attr('data-key', '');
                return;
            }
            if (!enterValue) {             // Show the dropdown only if Enter key was not pressed
                suggestionsContainerUniqueId.css('display', 'block');
            }
            enterValue = false;

            if (nameValue.length >= 1) {
                $.ajax({
                    url: '/itemdynamicsearchajax/',
                    method: 'GET',
                    data: {
                        'nameValue': nameValue
                    },
                    success: function (response) {
                        // Function to escape special characters in the search query
                        function escapeRegExp(string) {
                            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        }
                        const searchData = response.searched_item_name_dict;
                        const searchQuery = nameValue.toLowerCase();
                        const escapedSearchQuery = escapeRegExp(searchQuery); // Escape special characters in search query
                        const regex = new RegExp('(' + escapedSearchQuery + ')', 'gi');
                        const filteredOptions = Object.entries(searchData).filter(([key, value]) => value.toLowerCase().includes(searchQuery));

                        suggestionsContainerUniqueId.empty();

                        $.each(filteredOptions, function (index, [key, value]) {       // Display suggestions
                            let highlightedText = value;
                            if (searchQuery) {
                                highlightedText = value.replace(regex, '<span class="highlight">$1</span>');
                            }

                            suggestionsContainerUniqueId.append(`<div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion " data-key="${key}">${highlightedText}</div>`);
                        });
                    },
                    error: function (xhr) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        if (xhr.status === 404 || xhr.status === 400) {
                            suggestionsContainerUniqueId.css('display', 'block');
                            suggestionsContainerUniqueId.empty();
                            suggestionsContainerUniqueId.append(`<div" class="itemName-div itemName-div-suggestion ">No item found</div>`);
                        }
                    }
                })
            } else {
                suggestionsContainerUniqueId.empty();
            }

            suggestionsContainerUniqueId.on('click', '.itemName-div-suggestion', function () {
                const currentRowValue = $(this).closest('tr');
                const dataKey = $(this).attr('data-key');
                const nameData = $(this).closest('.custom-dropdown-container').find('.input_hidden-value').val(dataKey);
                const errorForms = currentRowValue.find('.error-messagesorderCreate');
                const uniuqueRow = currentRowValue.find('input[name^="product2itemuniqueformset-"][name$="Item_pks"]')
                const submitValue = $(this).closest('form').find('#id_submitForms');
              
                const prodcutData = currentRowValue.find('[name$="-PProduct_pk"]').val();
           
                $(this).closest('.custom-dropdown-container').find('.input_text').val($(this).text().trim());
                $(this).addClass('selected').siblings().removeClass('selected');
                const itemProduct = $(this).closest('form').find('[name$="-PProduct_pk"]').not(currentRowValue.find('[name$="-PProduct_pk"]'));
                let isDuplicates = false;
                itemProduct.each(function(){
                    const productValues = $(this).val();
                    if(productValues === prodcutData){
                        const formsSet = $(this).closest('form').find('[name$="Item_pk"]').not(currentRowValue.find('[name$="Item_pk"]'));
                            formsSet.each(function(){
                                const dataNameValue = $(this).val();
                  
                                    if(dataNameValue === dataKey){
                                        errorForms.text('Item already exists');
                                        errorForms.show();
                                        submitValue.prop('disabled', true);
                                        uniuqueRow.css('border', '1px solid red');
                                        isDuplicates = true;
                                        nameData.val('');
                                        return false; 
                                    }else{
                                        submitValue.prop('disabled', false);
                                        uniuqueRow.css('border', '1px solid #ced4da');
                                        errorForms.text('');
                                        errorForms.hide();
                                        nameData.val(dataKey);
                                    }
                            })

                    }
                })
                if(!isDuplicates){
                    submitValue.prop('disabled', false);
                    uniuqueRow.css('border', '1px solid #ced4da');
                    errorForms.text('');
                    errorForms.hide();
                    nameData.val(dataKey);
                }
                if(dataKey){
                    suggestionsContainerUniqueId.css('display', 'none');
                }
                
                
            })
        })

        $(document).on('keydown', 'input[name^="product2itemuniqueformset-"][name$="Item_pks"]', function (e) {
            const $inputField = $(this);
            const $dropdownOptions = $inputField.next('.s-suggestion-container');
            const $options = $dropdownOptions.find('.itemName-div');
            const optionsCount = $options.length - 1;
            const suggestionHide = $inputField.closest('.custom-dropdown-container').find('#id_itemName_' + newValueKey);
            const nameData = $inputField.val().trim();
            if (nameData === '') {
                suggestionHide.css('display', 'none');
                suggestionHide.empty();
                index = 0;
                indexbool = false;
                return;
            }

            // Calculate available space and set max height
            const inputOffset = $inputField.offset();
            const windowHeight = $(window).height();
            const inputHeight = $inputField.outerHeight();
            const inputBottomOffset = inputOffset.top + inputHeight;
            const availableSpaceBelow = windowHeight - inputBottomOffset;
            const maxHeight = Math.max(availableSpaceBelow, 200);

            $dropdownOptions.css({
                'max-height': maxHeight + 'px',
                'overflow-y': 'auto'
            });


            if (e.key === 'ArrowDown') {

                e.preventDefault();

                if (index <= optionsCount) {

                    const selectedItem = $options.eq(index);
                    const nextItem = selectedItem.next();
                    const nameDataKey = selectedItem.text();
                    const nameKey = selectedItem.data('key');

                    $inputField.closest('.custom-dropdown-container').find('.input_hidden-value').val(nameKey);
                    $inputField.text(nameDataKey);
                    $options.removeClass('bg-highlight');
                    selectedItem.addClass("bg-highlight");

                    const itemOffsetTop = nextItem.position() ? nextItem.position().top : 0;
                    const itemHeight = nextItem.outerHeight();
                    const selectScrollTop = $dropdownOptions.scrollTop();
                    const selectHeight = $dropdownOptions.height();

                    if (itemOffsetTop + itemHeight > selectHeight) {
                        $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                    } else if (itemOffsetTop < 0) {
                        $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                    }

                    if (index !== optionsCount) {
                        index += 1;
                        indexbool = true;
                    }

                } else {
                    index = 0;
                }

            }
            if (e.key === 'ArrowUp') {
                event.preventDefault();
                if (index != 0 && indexbool == true) {
                    index = index - 1;
                }

                if (index <= optionsCount) {
                    const selectedItem = $options.eq(index);
                    const prevItem = selectedItem.prev();
                    const nameDataKey = selectedItem.text();
                    const nameKey = selectedItem.data('key');

                    $inputField.closest('.custom-dropdown-container').find('.input_hidden-value').val(nameKey);
                    $inputField.text(nameDataKey);
                    $options.removeClass('bg-highlight');
                    selectedItem.addClass("bg-highlight");

                    const itemOffsetTop = prevItem.position() ? prevItem.position().top : 0;
                    const itemHeight = prevItem.outerHeight();
                    const selectScrollTop = $dropdownOptions.scrollTop();
                    const selectHeight = $dropdownOptions.height();

                    if (itemOffsetTop < 0) {
                        $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                    } else if (itemOffsetTop + itemHeight > selectHeight) {
                        $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                    }
                }
                else {
                    index = 0;
                }
            }
            if (e.key === 'Enter') {
                e.preventDefault();
                const nameKeyValue = $inputField.attr('data-key');
                const nameValues = $inputField.text().trim();
                // const currentRowData = $(this).closest('tr');
                // console.log(currentRowData);
                
                // const errorForm = currentRowData.find('.error-messagesorderCreate');
                // const uniuqueRow = currentRowData.find('input[name^="product2itemuniqueformset-"][name$="Item_pks"]')
                // const submitValue = $inputField.closest('form').find('#id_submitForms');
                // const nameData = $inputField.closest('.custom-dropdown-container').find('.input_hidden-value')
                // const prodcutData = currentRowData.find('[name$="-PProduct_pk"]').val();
                
                //console.log('nameKeyValue',nameKeyValue);
               
                if ($inputField.length > 0) {
                    $inputField.closest('.custom-dropdown-container').find('.input_hidden-value').val();
                    $inputField.val(nameValues);
                    index = 0;
                    indexbool = false;
                    suggestionHide.css('display', 'none')
                }

                // const itemProduct = $inputField.closest('form').find('[name$="-PProduct_pk"]').not(currentRowData.find('[name$="-PProduct_pk"]'));
                // let isDuplicates = false;
                // itemProduct.each(function(){
                //     const productValues = $(this).val();
                //     if(productValues === prodcutData){
                //         const formsSet = $(this).closest('form').find('[name$="Item_pk"]').not(currentRowData.find('[name$="Item_pk"]'));
                //             formsSet.each(function(){
                //                 const dataNameValue = $(this).val();
                            
                //                     console.log('dataNameValue', dataNameValue);
                //                     if(dataNameValue === nameKeyValue){
                //                         errorForm.text('Item already exists');
                //                         errorForm.show();
                //                         submitValue.prop('disabled', true);
                //                         uniuqueRow.css('border', '1px solid red');
                //                         isDuplicates = true;
                //                         $inputField.closest('.custom-dropdown-container').find('.input_hidden-value').val('');
                //                         return false; 
                //                     }
                //             })

                //     }
                // })
                // if(!isDuplicates){
                //     submitValue.prop('disabled', false);
                //     uniuqueRow.css('border', '1px solid #ced4da');
                //     errorForms.text('');
                //     errorForms.hide();
                //     nameData.val(nameKeyValue);
                // }
              
                enterValue = true; // Set the flag to true when Enter is pressed

            }

        })

      
      
        $(document).on('input', '[name^="product2itemcommonformset-"][name$="Item_pks"]', function () {
        
            purchaseData = $(this).attr('name').split('-')[1]; // Extract the numeric value from the input name
            const nameValue = $(this).val().trim();
            const suggestionsContainerCommon = $(`#id_item_input_Name_${purchaseData}`);
            if (nameValue === '') {
                suggestionsContainerCommon.css('display', 'none');
                $(this).attr('data-key', '');
                var errorForm = $(this).closest('tr').find('.error-messagesorderCreate');
                errorForm.hide();
                return;
            }
            if (!enterPressed) {
                // Show the dropdown only if Enter key was not pressed
                suggestionsContainerCommon.css('display', 'block');
            }
            enterPressed = false; // Reset the flag when key is released

            if (nameValue.length >= 1) {
                $.ajax({
                    url: '/itemdynamicsearchajax/',
                    method: 'GET',
                    data: {
                        'nameValue': nameValue
                    },
                    success: function (response) {
                        function escapeRegExp(string) {
                            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        }
                        const searchedItemData = response.searched_item_name_dict;
                        const searchQuery = nameValue.toLowerCase();
                        const escapedSearchQuery = escapeRegExp(searchQuery);
                        const regex = new RegExp('(' + escapedSearchQuery + ')', 'gi');
                        const filteredOptions = Object.entries(searchedItemData).filter(([key, value]) => value.toLowerCase().includes(searchQuery));

                        suggestionsContainerCommon.empty();

                        $.each(filteredOptions, function (index, [key, value]) {
                            let highlightedTexts = value;
                            if (searchQuery) {
                                highlightedTexts = value.replace(regex, '<span class="highlight">$1</span>');
                            }
                            suggestionsContainerCommon.append(`<div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion" data-key="${key}">${highlightedTexts}</div>`);
                        });
                    },
                    error: function (xhr) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        if (xhr.status === 404 || xhr.status === 400) {
                            suggestionsContainerCommon.css('display', 'block');
                            suggestionsContainerCommon.empty();
                            suggestionsContainerCommon.append(`<div" class="itemName-div itemName-div-suggestion ">No item found</div>`);
                        }
                    }
                })

            } else {
                suggestionsContainerCommon.empty();
            }

            suggestionsContainerCommon.on('click', '.itemName-div-suggestion', function () {
                const currentRow = $(this).closest('tr');  
                const dataKey = $(this).attr('data-key');  // New row's data-key (item to be added)
                const errorShow =currentRow.find('.error-messagesorderCreate');  // Error display element
                const submitButton = $(this).closest('form').find('#id_submitForms');
                const commonItemInput = currentRow.find('[name$="Item_pks"]');
                var suggestionData = $(this).closest('.custom-dropdown-container').find('.commom_item_hidden');
            
                $(this).closest('.custom-dropdown-container').find('.commom_item').val($(this).text().trim());
                $(this).addClass('selected').siblings().removeClass('selected');
        
                // Find existing Item_pk values in the form
                const forms = $(this).closest('form').find('[name$="Item_pk"]').not(currentRow.find('[name$="Item_pk"]'));
                let isDuplicate = false;  // Flag to track duplicates
                forms.each(function () {
                    const dataValue = $(this).val();  // Existing Item_pk values
                    if (dataKey === dataValue) {  // Compare new dataKey with existing Item_pk
                        errorShow.text('Item already added');  // Show error if duplicate found
                        errorShow.show();
                        submitButton.attr('disabled', 'disabled');  // Disable submit button
                        commonItemInput.css('border', '1px solid red');
                        isDuplicate = true;
                        suggestionData.val('');
                       
                        return false;  // Exit the loop if a match is found
                    }
                });

                if (!isDuplicate) {
                    errorShow.text('');
                    errorShow.hide();
                    submitButton.removeAttr('disabled');
                    commonItemInput.css('border', '1px solid #ced4da');
                    suggestionData.val(dataKey);
                }

                // Hide suggestions dropdown
                if (dataKey) {
                    
                    suggestionsContainerCommon.css('display', 'none');
                }
            });

        })
  

        $(document).on('keydown', '[name^="product2itemcommonformset-"][name$="Item_pks"]', function (e) {
            const $inputFields = $(this);
            const $dropdownOptions = $inputFields.next('.s-suggestion-container');
            const $options = $dropdownOptions.find('.itemName-div');
            const optionsCount = $options.length - 1;
            const nameData = $inputFields.val().trim();
            const commomSugenstionHide = $inputFields.closest('.custom-dropdown-container').find(`#id_item_input_Name_${purchaseData}`);
            if (nameData === '') {
                index = 0;
                indexbool = false;
                return;
            }

            // Calculate available space and set max height
            const inputOffset = $inputFields.offset();
            const windowHeight = $(window).height();
            const inputHeight = $inputFields.outerHeight();
            const inputBottomOffset = inputOffset.top + inputHeight;
            const availableSpaceBelow = windowHeight - inputBottomOffset;
            const maxHeight = Math.max(availableSpaceBelow, 234);

            $dropdownOptions.css({
                'max-height': maxHeight + 'px',
                'overflow-y': 'auto'
            });


            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (index <= optionsCount) {

                    const selectedItem = $options.eq(index);
                    const nextItem = selectedItem.next();
                    const nameDataKey = selectedItem.text();
                    const nameKey = selectedItem.data('key');

                    $inputFields.closest('.custom-dropdown-container').find('.commom_item_hidden').val(nameKey);
                    $inputFields.attr('data-key', nameKey);
                    $inputFields.text(nameDataKey);

                    $options.removeClass('bg-highlight');
                    selectedItem.addClass("bg-highlight");

                    const itemOffsetTop = nextItem.position() ? nextItem.position().top : 0;
                    const itemHeight = nextItem.outerHeight();
                    const selectScrollTop = $dropdownOptions.scrollTop();
                    const selectHeight = $dropdownOptions.height();

                    if (itemOffsetTop + itemHeight > selectHeight) {
                        $dropdownOptions.scrollTop(selectScrollTop + itemHeight);

                    } else if (itemOffsetTop < 0) {
                        $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                    }

                    if (index !== optionsCount) {
                        index += 1;
                        indexbool = true;
                    }

                } else {
                    index = 0;
                }

            }
            if (e.key === 'ArrowUp') {
                event.preventDefault();
                if (index != 0 && indexbool == true) {
                    index = index - 1;
                }

                if (index <= optionsCount) {

                    const selectedItem = $options.eq(index);
                    const prevItem = selectedItem.prev();
                    const nameDataKey = selectedItem.text();
                    const nameKey = selectedItem.data('key');

                    $inputFields.closest('.custom-dropdown-container').find('.commom_item_hidden').val(nameKey);
                    $inputFields.attr('data-key', nameKey);
                    $inputFields.text(nameDataKey);

                    $options.removeClass('bg-highlight');
                    selectedItem.addClass("bg-highlight");

                    const itemOffsetTop = prevItem.position() ? prevItem.position().top : 0;
                    const itemHeight = prevItem.outerHeight();
                    const selectScrollTop = $dropdownOptions.scrollTop();
                    const selectHeight = $dropdownOptions.height();

                    if (itemOffsetTop < 0) {
                        $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                    } else if (itemOffsetTop + itemHeight > selectHeight) {
                        $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                    }
                }
                else {
                    index = 0;
                }
            }
            if (e.key === 'Enter') {
                e.preventDefault();
                const currentRows = $(this).closest('tr'); 
                // console.log('currentRows',currentRows)
                const nameValues = $inputFields.text().trim();
                const dataKey = $inputFields.attr('data-key');
                const errorShow = currentRows.find('.error-messagesorderCreate');
                const commonItemInputs = currentRows.find('[name$="Item_pks"]');
                const submitButton = $(this).closest('form').find('#id_submitForms');
           
                if ($inputFields.length > 0) {
                    $inputFields.closest('.custom-dropdown-container').find('.commom_item_hidden').val();
                    $inputFields.val(nameValues);
                    index = 0;
                    indexbool = false;
                    commomSugenstionHide.css('display', 'none'); // Hide the dropdown
                }
                const formsValid = $inputFields.closest('form').find('[name$="Item_pk"]').not(currentRows.find('[name$="Item_pk"]'));
                
                let isDuplicate = false; // Initialize the flag to track duplicate
                formsValid.each(function(){
           
                   var dataValue= $(this).val();
                   console.log('Duplicate item found:', dataValue);
                   if(dataKey === dataValue){
                    errorShow.text('Already Item Added');
                    errorShow.show();
                    submitButton.attr('disabled', 'disabled');
                 
                    isDuplicate = true;
                    return false;
                   }
                   
                   if(!isDuplicate){
                    errorShow.text('');
                    errorShow.hide();
                    submitButton.removeAttr('disabled');
            
                   }
                })
                enterPressed = true; // Set the flag to true when Enter is pressed
            }
        })
    })


</script>
<!--add a new row when click on add button using both the function unique and non unique-->

<script>
    // THis code are using a single row created by clicking add button
    document.addEventListener('DOMContentLoaded', function () {
   
    const addButtonValue = document.querySelectorAll('.add_btn_row');
    const tableBodys = document.querySelector('#mainProductForm tbody');
      // Function to update the visibility of add buttons
      function updateAddButtonVisibility() {
        // Iterate over each add button
        addButtonValue.forEach(function (button) {
            // Find the closest <tr> element
            const currentRow = button.closest('tr');
        
            // Get the id value from the corresponding input elementid_product2itemuniqueformset-0-id
            const idElement = currentRow.querySelector('[name^="product2itemuniqueformset-"][name$="-id"]');
          
            const idValue = idElement.value;
         
            // Show or hide the add button based on the id value
            if (idValue != '' && idValue != null) {
                button.style.display = 'block'; // Show button
            } else {
                button.style.display = 'none'; // Hide button
            }
        });
    }

    // Initial call to update the visibility when the page loads
    updateAddButtonVisibility();

    if(addButtonValue && tableBodys){
    addButtonValue.forEach(function (el) {
        el.addEventListener('click', function () {
            const currentRow = el.closest('tr');
            const inputValue = currentRow.querySelector('[name$="-no_of_rows"]').getAttribute('name');
            const mainForms = document.getElementById('id_product2itemuniqueformset-TOTAL_FORMS');
            const formsInsertValue = parseInt(mainForms.value);
            const formValue = inputValue.split('-')[1];
        
            const formsInsert = parseInt(formValue) + 2;
        
            const formDataValue = parseInt(formsInsertValue);
           
            const newRow = currentRow.cloneNode(true);

            newRow.querySelectorAll("input, select").forEach(function (e) {
                e.value = "";
            });

            const rowValue = newRow.querySelector('[id^="id_serial_no_unique-"]');
            rowValue.id = `id_serial_no_unique-${formDataValue}`;
            rowValue.value = formsInsert;

            const rowNumber = newRow.querySelector('[name^="product2itemuniqueformset-"][name$="-row_number"]');
            rowNumber.id = `id_product2itemuniqueformset-${formDataValue}-row_number`;
            rowNumber.name = `product2itemuniqueformset-${formDataValue}-row_number`;
            rowNumber.value = '';

            const newSelectElement = newRow.querySelector('select[name^="product2itemuniqueformset-"][name$="PProduct_pk"]');
            newSelectElement.id = `id_product2itemuniqueformset-${formDataValue}-PProduct_pk`;
            newSelectElement.name = `product2itemuniqueformset-${formDataValue}-PProduct_pk`;
            newSelectElement.value = '';

            const inputValueElement = newRow.querySelector('[name^="itemName_"]');
            inputValueElement.id = `id_itemName_${formDataValue}`;
            inputValueElement.name = `itemName_${formDataValue}`;
            inputValueElement.value = '';

            const hiddenValueName = newRow.querySelector('[name^="product2itemuniqueformset-"][name$="Item_pks"]');
            hiddenValueName.id = `id_product2itemuniqueformset-${formDataValue}-Item_pks`;
            hiddenValueName.name = `product2itemuniqueformset-${formDataValue}-Item_pks`;
            hiddenValueName.value = '';

            const selectValueName = newRow.querySelector('[name^="product2itemuniqueformset-"][name$="Item_pk"]');
            selectValueName.id = `id_product2itemuniqueformset-${formDataValue}-Item_pk`;
            selectValueName.name = `product2itemuniqueformset-${formDataValue}-Item_pk`;
            selectValueName.value = '';

            const inputElement = newRow.querySelector('input[name^="product2itemuniqueformset-"][name$="no_of_rows"]');
            inputElement.id = `id_product2itemuniqueformset-${formDataValue}-no_of_rows`;
            inputElement.name = `product2itemuniqueformset-${formDataValue}-no_of_rows`;
            inputElement.value = '1';

            const grandElement = newRow.querySelector('input[name^="product2itemuniqueformset-"][name$="grand_total"]');
            grandElement.id = `id_product2itemuniqueformset-${formDataValue}-grand_total`;
            grandElement.name = `product2itemuniqueformset-${formDataValue}-grand_total`;
            grandElement.value = '0';

            const inputRemark = newRow.querySelector('input[name^="product2itemuniqueformset-"][name$="Remark"]');
            inputRemark.id = `id_product2itemuniqueformset-${formDataValue}-Remark`;
            inputRemark.name = `product2itemuniqueformset-${formDataValue}-Remark`;
            inputRemark.value = '';

            const deleteElement = newRow.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="DELETE"]');
            deleteElement.id = `id_product2itemuniqueformset-${formDataValue}-DELETE`;
            deleteElement.name = `product2itemuniqueformset-${formDataValue}-DELETE`;
            deleteElement.value = '';
            deleteElement.checked = false;

            const addButtonElement = newRow.querySelector('[name^="product2itemuniqueformset-"][name$="-add_btn"]');
            addButtonElement.id = `id_product2itemuniqueformset-${formDataValue}-add_btn`;
            addButtonElement.name = `product2itemuniqueformset-${formDataValue}-add_btn`;
            addButtonElement.value = '+';
            addButtonElement.style.display = 'none';

            
            const mainId = newRow.querySelector('[name^="product2itemuniqueformset-"][name$="-id"]');
            mainId.id = `id_product2itemuniqueformset-${formDataValue}-id`;
            mainId.name = `product2itemuniqueformset-${formDataValue}-id`;
            mainId.value = '';
            

            // Insert the new row after the current row
            currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);

            // Re-bind delete functionality after adding a new 
            deleteRowSingle();
            updateAddButtonVisibility();
            // Update the total forms count
            mainForms.value = formsInsertValue + 1;
    
        });
    });
    }

    function deleteRowSingle() {
        document.querySelectorAll('.delete-btn').forEach(function (button) {
            button.addEventListener('click', function () {
                const row = this.closest('tr');
                const checkRow = row.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="-DELETE"]');
                const rowValue = row.querySelector('.product_row[name^="product2itemuniqueformset-"][name$="-no_of_rows"]');

                if (checkRow) {
                    checkRow.checked = true;
                    checkRow.value = 'true';
                    rowValue.required = false;
                    row.style.display = 'none';
                } else {
                    console.error("Checkbox for deletion not found in this row");
                }
                    submitFormRowNumber();
            });
        });
    };

    // Bind delete functionality on initial load
    deleteRowSingle();


});

    

    // add a new row to the common product2itemUniqueformset and delete the last row
    document.addEventListener('DOMContentLoaded', function () {
        const addFormButton = document.getElementById('addForm');
        const tableBody = document.querySelector('#mainProductForm tbody');
      
        if (addFormButton && tableBody) {
            addFormButton.addEventListener('click', function () {
                let addInputRow = parseInt(document.getElementById('id_productNoRow').value, 10);
               

                if (isNaN(addInputRow) || addInputRow <= 0) {
                    addInputRow = 1;
                    return;
                }
                let lastVisibleRow = null;
                tableBody.querySelectorAll('tr').forEach(row => {
                    if (window.getComputedStyle(row).display !== 'none') {
                        lastVisibleRow = row;
                    }
                });
                if (lastVisibleRow) {
                    const forms = document.getElementById('id_product2itemuniqueformset-TOTAL_FORMS');
                

                    for(let i = 0; i<addInputRow; i++){
                    const newFormCount = parseInt(forms.value);
                    const formValue = newFormCount + 1;
                    const newTable = lastVisibleRow.cloneNode(true);
                    newTable.querySelectorAll("input select").forEach(function (e) {
                        e.value = "";
                    });


                    const rowValue = newTable.querySelector('[id^="id_serial_no_unique-"]');
                    rowValue.id = `id_serial_no_unique-${newFormCount}`;
                    rowValue.value = formValue;

                    const numberRow = newTable.querySelector('[name^="product2itemuniqueformset-"][name$="row_number"]');
                    numberRow.id = `id_product2itemuniqueformset-${newFormCount}-row_number`;
                    numberRow.name = `product2itemuniqueformset-${newFormCount}-row_number`;
                    numberRow.value = '';

                    const newSelectElement = newTable.querySelector('select[name^="product2itemuniqueformset-"][name$="PProduct_pk"]');
                    newSelectElement.id = `id_product2itemuniqueformset-${newFormCount}-PProduct_pk`;
                    newSelectElement.name = `product2itemuniqueformset-${newFormCount}-PProduct_pk`;
                    newSelectElement.value = '';

                    const inputValueElement = newTable.querySelector('[name^="itemName_"]');
                    inputValueElement.id = `id_itemName_${newFormCount}`;
                    inputValueElement.name = `itemName_${newFormCount}`;
                    inputValueElement.value = '';

                    const hiddenValueName = newTable.querySelector('[name^="product2itemuniqueformset-"][name$="Item_pks"]');
                    hiddenValueName.id = `id_product2itemuniqueformset-${newFormCount}-Item_pks`;
                    hiddenValueName.name = `product2itemuniqueformset-${newFormCount}-Item_pks`;
                    hiddenValueName.value = '';

                    const selectValueName = newTable.querySelector('[name^="product2itemuniqueformset-"][name$="Item_pk"]');
                    selectValueName.id = `id_product2itemuniqueformset-${newFormCount}-Item_pk`;
                    selectValueName.name = `product2itemuniqueformset-${newFormCount}-Item_pk`;
                    selectValueName.value = '';

                    const inputElement = newTable.querySelector('input[name^="product2itemuniqueformset-"][name$="no_of_rows"]');
                    inputElement.id = `id_product2itemuniqueformset-${newFormCount}-no_of_rows`;
                    inputElement.name = `product2itemuniqueformset-${newFormCount}-no_of_rows`;
                    inputElement.value = '1';

                    const grandElement = newTable.querySelector('input[name^="product2itemuniqueformset-"][name$="grand_total"]');
                    grandElement.id = `id_product2itemuniqueformset-${newFormCount}-grand_total`;
                    grandElement.name = `product2itemuniqueformset-${newFormCount}-grand_total`;
                    grandElement.value = '0';

                    const inputRemark = newTable.querySelector('input[name^="product2itemuniqueformset-"][name$="Remark"]');
                    inputRemark.id = `id_product2itemuniqueformset-${newFormCount}-Remark`;
                    inputRemark.name = `product2itemuniqueformset-${newFormCount}-Remark`;
                    inputRemark.value = '';

                    const deleteElement = newTable.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="DELETE"]');
                    deleteElement.id = `id_product2itemuniqueformset-${newFormCount}-DELETE`;
                    deleteElement.name = `product2itemuniqueformset-${newFormCount}-DELETE`;
                    deleteElement.value = '';
                    deleteElement.checked = false;

                    const addButtonElement = newTable.querySelector('[name^="product2itemuniqueformset-"][name$="-add_btn"]');
                    addButtonElement.id = `id_product2itemuniqueformset-${newFormCount}-add_btn`;
                    addButtonElement.name = `product2itemuniqueformset-${newFormCount}-add_btn`;
                    addButtonElement.value = '+';
                    addButtonElement.style.display = 'none';

                    const addIdValue = newTable.querySelector('[name^="product2itemuniqueformset-"][name$="-id"]');
                    addIdValue.id = `id_product2itemuniqueformset-${newFormCount}-id`;
                    addIdValue.name = `product2itemuniqueformset-${newFormCount}-id`;
                    addIdValue.value = '';

                    forms.value = newFormCount + 1;

                    tableBody.appendChild(newTable);
                    submitFormRowNumber();
                    }
                    document.getElementById('id_productNoRow').value = '1';
                    deleteRow();
                   
                    // updateAddButtonVisibility();
               
                } else {
                    console.error("No visible rows found to clone.");
                }
            });
        }

        function deleteRow() {
            // Add click event listener to all delete buttons
            document.querySelectorAll('.delete-btn').forEach(function (button) {
                button.addEventListener('click', function () {
                    // Find the row containing the clicked delete button
                    const row = this.closest('tr');
                    const checkRow = row.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="-DELETE"]');
                    const rowValue = row.querySelector('.product_row[name^="product2itemuniqueformset-"][name$="-no_of_rows"]');
                 
                    if (checkRow) {
                        checkRow.checked = true; // Mark as checked
                        checkRow.value = 'true'; // Set the value to 'true'
                        rowValue.required = false;
                        row.style.display = 'none';

                    } else {
                        console.error("Checkbox for deletion not found in this row");
                    }
                    submitFormRowNumber();
                });
            });
        };
        deleteRow();
     
    });



</script>

<!-- product2itemcommonformset -->
<script>
    
document.addEventListener('DOMContentLoaded', function () {
        const addButtonValues = document.querySelectorAll('.add_btn_CommonForm');
        const tableBodys = document.querySelector('#myProduct tbody');

        function updateAddButton() {
        // Iterate over each add button
        addButtonValues.forEach(function (button) {
            // Find the closest <tr> element
            const currentRow = button.closest('tr');

            // Get the id value from the corresponding input element
            const idElement = currentRow.querySelector('[name^="product2itemcommonformset-"][name$="-id"]');
            const idValue = idElement ? idElement.value : '';

            // Show or hide the add button based on the id value
            if (idValue !== '') {
                button.style.display = 'block'; // Show button
            } else {
                button.style.display = 'none'; // Hide button
            }
        });
     }
    
      // Initial call to update the visibility when the page loads
      updateAddButton();

        addButtonValues.forEach(function (el){
            el.addEventListener('click',function(){
             
              
                const currentRow = el.closest('tr');
     
                const inputValue = currentRow.querySelector('[name$="-no_of_rows"]').getAttribute('name');
      
                const mainForms = document.getElementById('id_product2itemcommonformset-TOTAL_FORMS');
          
                const formsInsertValue = parseInt(mainForms.value);
          
                const formValue = inputValue.split('-')[1];
                
                const formsInsert = parseInt(formValue) + 2;
                const formDataValues = formsInsertValue;

                const newRow = currentRow.cloneNode(true);
     
               
                newRow.querySelectorAll("input select").forEach(function (e) {
                        e.value = "";
                });

                    const SerialNo = newRow.querySelector('[id^="id_serial_no-"]');
                    SerialNo.id = `id_serial_no-${formDataValues}`;
                    SerialNo.value = formsInsert ;

                    const Numbers = newRow.querySelector('[name^="product2itemcommonformset-"][name$="-row_number"]');
                    Numbers.id = `id_product2itemcommonformset-${formDataValues}-row_number`;
                    Numbers.name = `product2itemcommonformset-${formDataValues}-row_number`;
                    Numbers.value = '';

                    const inputnameElement = newRow.querySelector('[name^="item_input_Name_"]');
                    inputnameElement.id = `id_item_input_Name_${formDataValues}`;
                    inputnameElement.name = `item_input_Name_${formDataValues}`;
                    inputnameElement.value = '';

                    const hiddenElement = newRow.querySelector('[name^="product2itemcommonformset-"][name$="Item_pks"]');
                    hiddenElement.id = `id_product2itemcommonformset-${formDataValues}-Item_pks`;
                    hiddenElement.name = `product2itemcommonformset-${formDataValues}-Item_pks`;
                    hiddenElement.value = "";

                    const selectElement = newRow.querySelector('[name^="product2itemcommonformset-"][name$="Item_pk"]');
                    selectElement.id = `id_product2itemcommonformset-${formDataValues}-Item_pk`;
                    selectElement.name = `product2itemcommonformset-${formDataValues}-Item_pk`;
                    selectElement.value = '';

                    const inputNameValue = newRow.querySelector('input[name^="product2itemcommonformset-"][name$="no_of_rows"]');
                    inputNameValue.id = `id_product2itemcommonformset-${formDataValues}-no_of_rows`;
                    inputNameValue.name = `product2itemcommonformset-${formDataValues}-no_of_rows`;
                    inputNameValue.value = '1';

                    const grandTotalElement = newRow.querySelector('input[name^="product2itemcommonformset-"][name$="grand_total"]');
                    grandTotalElement.id = `id_product2itemcommonformset-${formDataValues}-grand_total`;
                    grandTotalElement.name = `product2itemcommonformset-${formDataValues}-grand_total`;
                    grandTotalElement.value = '0';

                    const inputElement = newRow.querySelector('input[name^="product2itemcommonformset-"][name$="Remark"]');
                    inputElement.id = `id_product2itemcommonformset-${formDataValues}-Remark`;
                    inputElement.name = `product2itemcommonformset-${formDataValues}-Remark`;
                    inputElement.value = '';


                    const deleteElement = newRow.querySelector('.product_deleteId[name^="product2itemcommonformset-"][name$="DELETE"]');
                    deleteElement.id = `id_product2itemcommonformset-${formDataValues}-DELETE`;
                    deleteElement.name = `product2itemcommonformset-${formDataValues}-DELETE`;
                    deleteElement.value = '';
                    deleteElement.checked = false;

                    const addButtonElement = newRow.querySelector('[name^="product2itemcommonformset-"][name$="-add_btns"]');
                    addButtonElement.id = `id_product2itemcommonformset-${formDataValues}-add_btns`;
                    addButtonElement.name = `product2itemcommonformset-${formDataValues}-add_btns`;
                    addButtonElement.value = '+';
                    addButtonElement.style.display = 'none';

                    const mainId = newRow.querySelector('[name^="product2itemcommonformset-"][name$="-id"]');
                    mainId.id = `id_product2itemcommonformset-${formDataValues}-id`;
                    mainId.name = `product2itemcommonformset-${formDataValues}-id`;
                    mainId.value = '';
            
                currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
                // Update the prefix of the rows below the newly added row
       
            mainForms.value = formDataValues + 1;
                 deletedRowCommonRow();
                 updateAddButton();
            })
           
        })
        function deletedRowCommonRow() {
            // Add click event listener to all delete buttons
            document.querySelectorAll('.deleteButton').forEach(function (button) {
                button.addEventListener('click', function () {
                    // Find the row containing the clicked delete button
                    const row = this.closest('tr');
                    const checkRow = row.querySelector('.product_deleteId[name^="product2itemcommonformset-"][name$="-DELETE"]');
                    const rowValues = row.querySelector('.product_row[name^="product2itemcommonformset-"][name$="-no_of_rows"]');
                   
                    if (checkRow) {
                        checkRow.checked = true; // Mark as checked
                        checkRow.value = 'true'; // Set the value to 'true'
                        rowValues.required = false;
                        row.style.display = 'none';

                  
                    } else {
                        console.error("Checkbox for deletion not found in this row");
                    }
                    submitFormRowNumber();
                });
            });
        };
        deletedRowCommonRow();

    })
    // add a new row to the common product2itemcommonformset and delete the last row
    document.addEventListener('DOMContentLoaded', function () {
        const addNewButton = document.getElementById('addNewRow');
        const tableBody = document.querySelector('#myProduct tbody');
     

        if (addNewButton && tableBody) {
            addNewButton.addEventListener('click', function () {
             
                let newRowsForm = parseInt(document.getElementById('id_commonNoRow').value ,10)
                let lastVisibleRow = null;
                tableBody.querySelectorAll('tr').forEach(row => {
                    if (window.getComputedStyle(row).display !== 'none') {
                        lastVisibleRow = row;
                    }
                });
                if(isNaN(newRowsForm) || newRowsForm<= 0){
                    newRowsForm = 1;
                }
                if (lastVisibleRow) {
                    const tableRow = document.getElementById('id_product2itemcommonformset-TOTAL_FORMS');
                    
                    for(let i=0; i<newRowsForm; i++){
                        const newCount = parseInt(tableRow.value);
                        const tableValue = newCount  + 1;
                        const lastRow = lastVisibleRow.cloneNode(true);
                        lastRow.querySelectorAll("input select").forEach(function (e) {
                            e.value = "";
                    });


                    const SerialNo = lastRow.querySelector('[id^="id_serial_no-"]');
                    SerialNo.id = `id_serial_no-${newCount}`;
                    SerialNo.value = tableValue;

                    const Serial = lastRow.querySelector('[name^="product2itemcommonformset-"][name$="-row_number"]');
                    Serial.id = `id_product2itemcommonformset-${newCount}-row_number`;
                    Serial.name = `product2itemcommonformset-${newCount}-row_number`;
                    Serial.value = '';

                    const inputnameElement = lastRow.querySelector('[name^="item_input_Name_"]');
                    inputnameElement.id = `id_item_input_Name_${newCount}`;
                    inputnameElement.name = `item_input_Name_${newCount}`;
                    inputnameElement.value = '';

                    const hiddenElement = lastRow.querySelector('[name^="product2itemcommonformset-"][name$="Item_pks"]');
                    hiddenElement.id = `id_product2itemcommonformset-${newCount}-Item_pks`;
                    hiddenElement.name = `product2itemcommonformset-${newCount}-Item_pks`;
                    hiddenElement.value = "";

                    const selectElement = lastRow.querySelector('[name^="product2itemcommonformset-"][name$="Item_pk"]');
                    selectElement.id = `id_product2itemcommonformset-${newCount}-Item_pk`;
                    selectElement.name = `product2itemcommonformset-${newCount}-Item_pk`;
                    selectElement.value = '';

                    const inputNameValue = lastRow.querySelector('input[name^="product2itemcommonformset-"][name$="no_of_rows"]');
                    inputNameValue.id = `id_product2itemcommonformset-${newCount}-no_of_rows`;
                    inputNameValue.name = `product2itemcommonformset-${newCount}-no_of_rows`;
                    inputNameValue.value = '1';

                    const grandTotalElement = lastRow.querySelector('input[name^="product2itemcommonformset-"][name$="grand_total"]');
                    grandTotalElement.id = `id_product2itemcommonformset-${newCount}-grand_total`;
                    grandTotalElement.name = `product2itemcommonformset-${newCount}-grand_total`;
                    grandTotalElement.value = '0';

                    const inputElement = lastRow.querySelector('input[name^="product2itemcommonformset-"][name$="Remark"]');
                    inputElement.id = `id_product2itemcommonformset-${newCount}-Remark`;
                    inputElement.name = `product2itemcommonformset-${newCount}-Remark`;
                    inputElement.value = '';


                    const deleteElement = lastRow.querySelector('.product_deleteId[name^="product2itemcommonformset-"][name$="DELETE"]');
                    deleteElement.id = `id_product2itemcommonformset-${newCount}-DELETE`;
                    deleteElement.name = `product2itemcommonformset-${newCount}-DELETE`;
                    deleteElement.value = '';
                    deleteElement.checked = false;

                    const addButtonElement = lastRow.querySelector('[name^="product2itemcommonformset-"][name$="-add_btns"]');
                    addButtonElement.id = `id_product2itemcommonformset-${newCount}-add_btns`;
                    addButtonElement.name = `product2itemcommonformset-${newCount}-add_btns`;
                    addButtonElement.value = '+';
                    addButtonElement.style.display = 'none';

                    const addButtonId = lastRow.querySelector('[name^="product2itemcommonformset-"][name$="-id"]');
                    addButtonId.id = `id_product2itemcommonformset-${newCount}-id`;
                    addButtonId.name = `product2itemcommonformset-${newCount}-id`;
                    addButtonId.value = '';

                    tableRow.value = newCount + 1;
                 
                    tableBody.appendChild(lastRow);
                    submitFormRowNumber();
                    }
                    document.getElementById('id_commonNoRow').value = '1';
                    deletedRow();
                 
            

                } else {
                    console.error("No visible rows found to clone.");
                }
            });
        }

        function deletedRow() {
            // Add click event listener to all delete buttons
            document.querySelectorAll('.deleteButton').forEach(function (button) {
                button.addEventListener('click', function () {
                    // Find the row containing the clicked delete button
                    const row = this.closest('tr');
                    const checkRow = row.querySelector('.product_deleteId[name^="product2itemcommonformset-"][name$="-DELETE"]');
                    const rowValues = row.querySelector('.product_row[name^="product2itemcommonformset-"][name$="-no_of_rows"]');
                    console.log(checkRow)
                    if (checkRow) {
                        checkRow.checked = true; // Mark as checked
                        checkRow.value = 'true'; // Set the value to 'true'
                        rowValues.required = false;
                        row.style.display = 'none';

                  
                    } else {
                        console.error("Checkbox for deletion not found in this row");
                    }
                });
            });
        };
    
        deletedRow();
    });


function submitFormRowNumber(){
    var uniqueValue = 0;
    var uniqueTotalForm = document.getElementById('id_product2itemuniqueformset-TOTAL_FORMS');
        var uniqueTotal = parseInt(uniqueTotalForm.value);
 
       var unique = uniqueTotal + 1;
       var uniquerowNumberValue = document.querySelector('#mainProductForm tbody').querySelectorAll('[name$="-row_number"]');
           uniquerowNumberValue.forEach(input =>{
               input.value = uniqueValue + 1;
               uniqueValue++;
           })
        var commonRowNumber = document.querySelector('#myProduct tbody').querySelectorAll('[name$="-row_number"]');
        commonRowNumber.forEach(ele =>{
            ele.value = unique ;
            unique++;
        })       
}


submitFormRowNumber();

// Call the function on page load
document.addEventListener('DOMContentLoaded', function() {
    submitFormRowNumber();
 
});

// Update the row numbers when an "Add" button is clicked
document.querySelectorAll('.add_btn_row').forEach(function(addBtn) {
    addBtn.addEventListener('click', function() {
        submitFormRowNumber();
  
    });
});

document.querySelectorAll('.add_btn_CommonForm').forEach(function(addBtn) {
    addBtn.addEventListener('click', function() {
        submitFormRowNumber();
       
    });
});

document.querySelector('#myProductForm').addEventListener('submit', function() {
  
        submitFormRowNumber();
});
 
</script>
{% endblock body %}