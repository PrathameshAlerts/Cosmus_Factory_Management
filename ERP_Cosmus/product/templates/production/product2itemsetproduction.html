{% extends 'misc/navbar_popup.html' %}
{% load static %}
{% block body %}
<h4 class="mb-3">Add Unique Product</h3>

   <h5 class="me-5">Product Refrence No : <span class="text-capitalize text-danger">{{product_refrence_no}}</span></h5>
   <form method="post" enctype="multipart/form-data">

    {% csrf_token %}

 
    <table class="table table-responsive table-striped table-bordered" id="mainProductForm">
        <thead>
            <tr>
                <th>No</th>
                <th>Product Sku</th>
                <th>Item Name</th>
                <th>Rows</th>
                <th>Remark</th>
                <th>Delete</th>
            </tr>
        </thead>
       
        <tbody class="mainTableList">
            {{formset_single.management_form}}
            {% for form in formset_single %}
            {{ form.id }}
            <tr>
                <td><span>{{forloop.counter}}</span></td>
               
                <td>
                    <select class=" product2Select" name="{{form.prefix}}-PProduct_pk" id="id_{{form.prefix}}-PProduct_pk">
                        <option value="{{form.instance.PProduct_pk.PProduct_SKU}}">{{form.instance.PProduct_pk.PProduct_SKU}} &nbsp; &nbsp; {{form.instance.PProduct_pk.PProduct_color}}</option>
                        {% for product in Products_all %}
                        <option value="{{product.PProduct_SKU}}">{{product.PProduct_SKU}} &nbsp; &nbsp;{{product.PProduct_color}}</option>
                        {% endfor %}
                    </select>

                </td>
                <td>
                    <div class="custom-dropdown-container">
                            <input  type="text" name="itemName_{{forloop.counter0}}" id="id_itemName_{{forloop.counter0}}" class="product2Select input_text"  placeholder="Item Name" autocomplete="off" value="{% if form.instance.id %}{{ form.instance.item_shade.items.item_name }}{% endif %}"  > 
                            <div name="{{form.prefix}}-Item_pk" id="id_{{form.prefix}}-Item_pk" class="item-select item-name s-suggestion-container" style="display: none; height: 130px;" dir="auto" spellcheck="false" tabindex="0" aria-label="Item Name" >
                            
                        
                        </div>
                    </div> 
                </td>  
                <td> <input type="text" class="product_row" name="{{form.prefix}}-no_of_rows" value="{{form.instance.no_of_rows}}" maxlength="255" id="id_{{form.prefix}}-no_of_rows"></td>
                <td> <input type="text" class="product_remark" name="{{form.prefix}}-Remark" value="{{form.instance.Remark | default_if_none:''}}"  maxlength="255" id="id_{{form.prefix}}-Remark"></td>
                <td><span class="delete border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="product_Item_deleteId px-2" style="display: none;"  name="{{form.prefix}}-DELETE" id="id_{{form.prefix}}-DELETE" value="" ></i></span></td>
            </tr>
            {% endfor %}
        </tbody>
        
    </table>
    <button type="button" class="add_btn mb-4" id="addForm">Add</button>  
  
    <div>
        <h4 class="mb-3">Add common Items</h3>
            <table class="table table-responsive table-striped table-bordered" id="myProduct">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Item Name</th>
                        <th>Rows</th>
                        <th>Remark</th>
                        <th>Delete</th>
                    </tr>
                </thead>
               
                <tbody class="mainTable">
                   {{formset_common.management_form}}
                   {% for forms in formset_common %}
                   {{ forms.id }}
        
                    <tr>
                        <td><span>{{forloop.counter}}</span></td>
                        <td>
                            <div class="custom-dropdown-container">
                                    <input  type="text" name="item_input_Name_{{forloop.counter0}}" id="id_item_input_Name_{{forloop.counter0}}" class="product2Select commom_item"  placeholder="Item Name" autocomplete="off" value="{% if forms.instance.id %}{{ forms.instance.item_shade.items.item_name }}{% endif %}"  > 
                                    <div name="{{forms.prefix}}-Item_pk" id="id_{{forms.prefix}}-Item_pk" class="item-select item-name s-suggestion-container" style="display: none; height: 130px;" dir="auto" spellcheck="false" tabindex="0" aria-label="Item Name" >
                                    
                                
                                    </div>
                            </div> 
                        </td>                     
                        <td> <input type="text" class="product_row" name="{{forms.prefix}}-no_of_rows" value="{{forms.instance.no_of_rows}}"  maxlength="255" id="id_{{forms.prefix}}-no_of_rows" ></td>
                      
                        <td> <input type="text" class="product_remark" name="{{forms.prefix}}-Remark" value="{{forms.instance.Remarks}}"  maxlength="255" id="id_{{forms.prefix}}-Remark" ></td>
                        <td><span class="delete border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="product_deleteId px-2" style="display: none;"  name="{{forms.prefix}}-DELETE" id="id_{{forms.prefix}}-DELETE" value="" ></i></span></td>
                    </tr>
                    {% endfor %} 
                </tbody>
                
            </table>
            
                    
        <button type="button" class="add_btn mb-3" id="addNewRow">Add</button>  
    </div>
    
<div>
    <input type="submit" class="add_btn" >
</div>

</form>

<script>
   
$(document).ready( function() {

// this ajax reuest to product to uniuque item list
$(document).on ('keyup ','input[name^="itemName_"]', function(){
    var newValueKey = $(this).attr('name').match(/\d+/)[0];
    var nameValue = $(this).val().trim();
    var suggestionsContainerUniqueId = $(`#id_product2itemuniqueformset-${newValueKey}-Item_pk`);
  

   if(nameValue === '') {

        suggestionsContainerUniqueId.css('display', 'none');
        $(this).attr('data-key', '');
        return;
   }

   $.ajax({
    url:'/itemdynamicsearchajax/',
    method: 'GET',
    data:{
        'nameValue': nameValue
    },
    success:function(response){
        var searchData = response.searched_item_name_dict;
        var searchQuery = nameValue.toLowerCase();
        var filteredOptions = Object.entries(searchData).filter(([key, value]) => value.toLowerCase().includes(searchQuery));
        
        suggestionsContainerUniqueId.empty();

        $.each(filteredOptions, function(index, [key, value]) {
            suggestionsContainerUniqueId.append(`<div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion " data-key="${key}">${value}</div>`);
        });
        if (filteredOptions.length > 0) {
            suggestionsContainerUniqueId.show();
        } else {
            suggestionsContainerUniqueId.hide();
        }

    },
     error:function(xhr){
            console.log(xhr.status + ": " + xhr.responseText);
                if (xhr.status === 404 || xhr.status === 400) {
                    
                    suggestionsContainerUniqueId.hide();
                }

        }
   })

   suggestionsContainerUniqueId.on('click', '.itemName-div-suggestion', function() {
       
       $(this).closest('.custom-dropdown-container').find('.input_text').val($(this).text().trim());
       $(this).addClass('selected').siblings().removeClass('selected');
       suggestionsContainerUniqueId.hide();
   })


})  

$(document).on('click', '.input_text',function(){
        var selectValue = $(this).next('.s-suggestion-container');
        selectValue.hide();
    })

var index = 0; //  index outside of the event listener
   var indexbool = false;
$(document).on('keydown','input[name^="itemName_"]',function(e){
         var nameDataKey;
        var nameKey;
        var selectValue = $(this).next('.s-suggestion-container');
    
        var selectLength = selectValue.find('.itemName-div').length-1;
        var nameData = $(this).val().trim();
      
        if(nameData === ''){
            selectValue.hide();
            index = 0;
            indexbool = false;
            return;
        }

    if(e.key=== 'ArrowDown'){

        e.preventDefault();

        if(index <= selectLength){
            var selectedItem = selectValue.find('#itemName-div_' + index);
            var nextItem = selectedItem.next();
             nameDataKey= selectedItem.text();
            
             nameKey = selectedItem.data('key');
           
            $(this).attr('data-key', nameKey);
            $(this).text(nameDataKey);
            selectValue.find('.itemName-div').removeClass("bg-highlight");
            selectedItem.addClass("bg-highlight");
 
            var itemOffsetTop = nextItem.position() ? nextItem.position().top : 0;
            var itemHeight = nextItem.outerHeight();
            var selectScrollTop = selectValue.scrollTop();
            var selectHeight = selectValue.height();

            if (itemOffsetTop + itemHeight > selectHeight) {
                selectValue.scrollTop(selectScrollTop + itemHeight);

            } else if (itemOffsetTop < 0) {
                selectValue.scrollTop(selectScrollTop - itemHeight);
            }
           
            if(index != selectLength ){
                index += 1; 
             indexbool = true;        
            }     
               
       }else{
           index = 0;
       }

    }
    if(e.key === 'ArrowUp'){
           event.preventDefault();
           if (index != 0 && indexbool == true)
           {           
                index = index - 1;
           }
          
           if(index <= selectLength){
         
            var selectedItem = selectValue.find('#itemName-div_' + index);
            var prevItem = selectedItem.prev();
             nameDataKey= selectedItem.text();
              nameKey = selectedItem.data('key');
        
            $(this).attr('data-key', nameKey);
            $(this).text(nameDataKey);
            selectValue.find('.itemName-div').removeClass("bg-highlight");
            selectedItem.addClass("bg-highlight");
           
          
            var itemOffsetTop = prevItem.position() ? prevItem.position().top : 0;
            var itemHeight = prevItem.outerHeight();
            var selectScrollTop = selectValue.scrollTop();
            var selectHeight = selectValue.height();

            if (itemOffsetTop < 0) {
                selectValue.scrollTop(selectScrollTop - itemHeight);
            } else if (itemOffsetTop + itemHeight > selectHeight) {
                selectValue.scrollTop(selectScrollTop + itemHeight);
            }
            }
            else{
                    index = 0;
            }   
        }
        if(e.key === 'Enter'){
            e.preventDefault();
        var selectedItem = $(this).text().trim();
       
        if (selectedItem.length > 0) {
            $(this).val(selectedItem);
         
        }
        selectValue.hide();
        index = 0;
        indexbool = false;
        }
})  
  
    
$(document).on('keyup', 'input[name^="item_input_Name_"]', function () {

    var purchaseData = $(this).attr('name').match(/\d+/)[0]; // Extract the numeric value from the input name
    var nameValue = $(this).val().trim();
   var suggestionsContainerCommon= $(`#id_product2itemcommonformset-${purchaseData}-Item_pk`);
 
   
    if(nameValue === '') {
             
        suggestionsContainerCommon.css('display', 'none');
        $(this).attr('data-key', '');
        return;
    }

    $.ajax({
        url:'/itemdynamicsearchajax/',
        method: 'GET',
        data:{
            'nameValue': nameValue
        },
        success:function(response){
          var searchedItemData = response.searched_item_name_dict;
         
          
          var searchQuery = nameValue.toLowerCase();
                var filteredOptions = Object.entries(searchedItemData).filter(([key, value]) => value.toLowerCase().includes(searchQuery));
         
                // Clear and repopulate options
                suggestionsContainerCommon.empty();
             

                $.each(filteredOptions, function(index, [key, value]) {
                    suggestionsContainerCommon.append(`<div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion " data-key="${key}">${value}</div>`);
                });
                
                if (filteredOptions.length > 0) {
                    suggestionsContainerCommon.show();
                   
                } else {
                    suggestionsContainerCommon.hide();
                    
                }
        },
        error:function(xhr){
            console.log(xhr.status + ": " + xhr.responseText);
                if (xhr.status === 404 || xhr.status === 400) {
                    
                    suggestionsContainerCommon.hide();
                }

        }
    })

    suggestionsContainerCommon.on('click', '.itemName-div-suggestion', function() {
       
        $(this).closest('.custom-dropdown-container').find('.commom_item').val($(this).text().trim());
        $(this).addClass('selected').siblings().removeClass('selected');
        suggestionsContainerCommon.hide();
    })



})
$(document).on('click', '.commom_item',function(){
        var selectValue = $(this).next('.s-suggestion-container');
        selectValue.hide();
    })

   var index = 0; //  index outside of the event listener
   var indexbool = false;
$(document).on('keydown','input[name^="item_input_Name_"]',function(e){
        var nameDataKey;
         var nameKey;
        var selectValue = $(this).next('.s-suggestion-container');
     
        var selectLength = selectValue.find('.itemName-div').length-1;
        var nameData = $(this).val().trim();
     
        if(nameData === ''){
            selectValue.hide();
            index = 0;
            indexbool = false;
            return;
        }

    if(e.key=== 'ArrowDown'){

        e.preventDefault();

        if(index <= selectLength){
            var selectedItem = selectValue.find('#itemName-div_' + index);
            var nextItem = selectedItem.next();
             nameDataKey= selectedItem.text();
            
             nameKey = selectedItem.data('key');
           
            $(this).attr('data-key', nameKey);
            $(this).text(nameDataKey);
            selectValue.find('.itemName-div').removeClass("bg-highlight");
            selectedItem.addClass("bg-highlight");
 
            var itemOffsetTop = nextItem.position() ? nextItem.position().top : 0;
            var itemHeight = nextItem.outerHeight();
            var selectScrollTop = selectValue.scrollTop();
            var selectHeight = selectValue.height();

            if (itemOffsetTop + itemHeight > selectHeight) {
                selectValue.scrollTop(selectScrollTop + itemHeight);

            } else if (itemOffsetTop < 0) {
                selectValue.scrollTop(selectScrollTop - itemHeight);
            }
           
            if(index != selectLength ){
                index += 1; 
             indexbool = true;        
            }     
               
       }else{
           index = 0;
       }

    }
    if(e.key === 'ArrowUp'){
           event.preventDefault();
           if (index != 0 && indexbool == true)
           {           
                index = index - 1;
           }
          
           if(index <= selectLength){
         
            var selectedItem = selectValue.find('#itemName-div_' + index);
            var prevItem = selectedItem.prev();
             nameDataKey= selectedItem.text();
              nameKey = selectedItem.data('key');
        
            $(this).attr('data-key', nameKey);
            $(this).text(nameDataKey);
            selectValue.find('.itemName-div').removeClass("bg-highlight");
            selectedItem.addClass("bg-highlight");
           
          
            var itemOffsetTop = prevItem.position() ? prevItem.position().top : 0;
            var itemHeight = prevItem.outerHeight();
            var selectScrollTop = selectValue.scrollTop();
            var selectHeight = selectValue.height();

            if (itemOffsetTop < 0) {
                selectValue.scrollTop(selectScrollTop - itemHeight);
            } else if (itemOffsetTop + itemHeight > selectHeight) {
                selectValue.scrollTop(selectScrollTop + itemHeight);
            }
            }
            else{
                    index = 0;
            }   
        }
        if(e.key === 'Enter'){
            e.preventDefault();
        var selectedItem = $(this).text().trim();
        
        if (selectedItem.length > 0) {
            $(this).val(selectedItem);
         
        }
        selectValue.hide();
        index = 0;
        indexbool = false;
        }
})

})
   

</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        function deletedRow(){
document.querySelectorAll('.delete').forEach(function(button) {
    button.addEventListener('click', function() {
        // Find the row containing the clicked delete button
        var row = this.closest('tr');
         // Handle common formset deletion
                var commonDeleteCheckbox = row.querySelector('.product_deleteId[name^="product2itemcommonformset-"][name$="-DELETE"]');
                if (commonDeleteCheckbox) {
                    commonDeleteCheckbox.checked = true; // Mark as checked
                    commonDeleteCheckbox.value = 'true'; // Set the value to 'true'
                    row.style.display = 'none'; // Hide the row
                }

                // Handle unique formset deletion
                var uniqueDeleteCheckbox = row.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="-DELETE"]');
                if (uniqueDeleteCheckbox) {
                    uniqueDeleteCheckbox.checked = true; // Mark as checked
                    uniqueDeleteCheckbox.value = 'true'; // Set the value to 'true'
                    row.style.display = 'none'; // Hide the row
                }

                if (!commonDeleteCheckbox && !uniqueDeleteCheckbox) {
                    console.error("Checkbox for deletion not found in this row");
                }
    });
});

};
 
        const addFormButton = document.getElementById('addForm');
        const tableBody = document.querySelector('#mainProductForm tbody');

        if( addFormButton && tableBody) {
        addFormButton.addEventListener('click', function() {
        let lastVisibleRow = null;
        tableBody.querySelectorAll('tr').forEach(row => {
            if (window.getComputedStyle(row).display !== 'none') {
                lastVisibleRow = row;
            }
        });
        if (lastVisibleRow) {
            var forms = document.getElementById('id_product2itemuniqueformset-TOTAL_FORMS');
            var newFormCount = parseInt(forms.value) ;
            console.log(newFormCount);
            var newTable = lastVisibleRow.cloneNode(true);
            newTable.querySelectorAll("input select").forEach(function(e) {
            e.value= "";
          });

         
         
            const newSelectElement = newTable.querySelector('select[name^="product2itemuniqueformset-"][name$="PProduct_pk"]');
            newSelectElement.id = `id_product2itemuniqueformset-${newFormCount}-PProduct_pk`;
            newSelectElement.name = `product2itemuniqueformset-${newFormCount}-PProduct_pk`;
            newSelectElement.value = '';

            const inputValueElement = newTable.querySelector('[name^="itemName_"]');
            inputValueElement.id = `id_itemName_${newFormCount}`;
            inputValueElement.name = `itemName_${newFormCount}`;
            inputValueElement.value = '';
            const selectValueName = newTable.querySelector('[name^="product2itemuniqueformset-"][name$="Item_pk"]');
            selectValueName.id = `id_product2itemuniqueformset-${newFormCount}-Item_pk`;
            selectValueName.name = `product2itemuniqueformset-${newFormCount}-Item_pk`;
            selectValueName.value = '';


            const inputElement = newTable.querySelector('input[name^="product2itemuniqueformset-"][name$="no_of_rows"]');
            inputElement.id = `id_product2itemuniqueformset-${newFormCount}-no_of_rows`;
            inputElement.name = `product2itemuniqueformset-${newFormCount}-no_of_rows`;
            inputElement.value = '';

            const inputRemark = newTable.querySelector('input[name^="product2itemuniqueformset-"][name$="Remark"]');
            inputRemark.id = `id_product2itemuniqueformset-${newFormCount}-Remark`;
            inputRemark.name = `product2itemuniqueformset-${newFormCount}-Remark`;
            inputRemark.value = '';


            const deleteElement = newTable.querySelector('.product_Item_deleteId[name^="product2itemuniqueformset-"][name$="DELETE"]');
            deleteElement.id = `id_product2itemuniqueformset-${newFormCount}-DELETE`;
            deleteElement.name = `product2itemuniqueformset-${newFormCount}-DELETE`;
            deleteElement.value = '';
            deleteElement.checked = false;


            forms.value = newFormCount + 1;

            tableBody.appendChild(newTable);
            deletedRow();

        }else {
            console.error("No visible rows found to clone.");
        }   
        });
    }

        const addNewButton = document.getElementById('addNewRow');
        const tableNewBody = document.querySelector('#myProduct tbody');

        if( addNewButton && tableNewBody) {
            addNewButton.addEventListener('click', function() {
        let lastVisibleRow = null;
        tableNewBody.querySelectorAll('tr').forEach(row => {
            if (window.getComputedStyle(row).display !== 'none') {
                lastVisibleRow = row;
            }
        });
        if (lastVisibleRow) {
            var tableRow = document.getElementById('id_product2itemcommonformset-TOTAL_FORMS');
            console.log(tableRow);
            var newCount = parseInt(tableRow.value) ;
            var lastRow = lastVisibleRow.cloneNode(true);
            lastRow.querySelectorAll("input select").forEach(function(e) {
            e.value= "";
          });

           const inputnameElement = lastRow.querySelector('input[name^="item_input_Name_"]');
           inputnameElement.id = `id_item_input_Name_"${newCount}`;
           inputnameElement.name = `item_input_Name_"${newCount}`;
           inputnameElement.value = '';

            const selectElement = lastRow.querySelector('.item-name[name^="product2itemcommonformset-"][name$="Item_pk"]');
            selectElement.id = `id_product2itemcommonformset-${newCount}-Item_pk`;
            selectElement.name = `product2itemcommonformset-${newCount}-Item_pk`;
            selectElement.value = '';


            const inputNameValue = lastRow.querySelector('input[name^="product2itemcommonformset-"][name$="no_of_rows"]');
            inputNameValue.id = `id_product2itemcommonformset-${newCount}-no_of_rows`;
            inputNameValue.name = `product2itemcommonformset-${newCount}-no_of_rows`;
            inputNameValue.value = '';


            const inputElement = lastRow.querySelector('input[name^="product2itemcommonformset-"][name$="Remark"]');
            inputElement.id = `id_product2itemcommonformset-${newCount}-Remark`;
            inputElement.name = `product2itemcommonformset-${newCount}-Remark`;
            inputElement.value = '';

            const deleteElement = lastRow.querySelector('.product_deleteId[name^="product2itemcommonformset-"][name$="DELETE"]');
            deleteElement.id = `id_product2itemcommonformset-${newCount}-DELETE`;
            deleteElement.name = `product2itemcommonformset-${newCount}-DELETE`;
            deleteElement.value = '';
            deleteElement.checked = false;


            tableRow.value = newCount + 1;

            tableNewBody.appendChild(lastRow);
            deletedRow();

        }else {
            console.error("No visible rows found to clone.");
        }   
        });
    }
    deletedRow();
    });

</script>


    {% endblock body %} 