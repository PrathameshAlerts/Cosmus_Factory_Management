{% extends 'product/base.html' %}
{% load static %}
{% block body %}


<h2 class="mt-3 mb-4">{{title}}</h2>
<div class="row">
<div class="col-lg-4">
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="d-flex mb-3">
      {% if not form.instance.id %}
      <label for="id_item-to-clone" class="item-form">Clone Item: </label>
      <div class="custom-dropdown-container">
        <input type="text" class="product2Select" name="item-to-clone"  id="id_item-to-clone" maxlength="255" placeholder="Item Name" autocomplete="off" value="{% if form.instance.id %}{{ form.instance.Item_pk.item_name }}{% endif %}" data-key="">
        <div class="item-select item-name s-suggestion-container" id="search-results" style="display: none; height: auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Item Name">

        </div>
      </div>
      {% endif %}
    </div>
    <div class=" d-flex my-3">
      <label for="id_item_name" class="item-form">Name:</label>
      <input type="text" class="item-select" value="{{form.instance.item_name}}" name="item_name" maxlength="255"
        required id="id_item_name">
    </div>

    <!-- {{form.instance.fab_grp }} - from a function def fab_grp(self): return self.Fabric_Group.fab_grp_name -->

    <div class="d-flex my-3">
      <label for="id_Fabric_Group" class="item-form">Fabric Group:</label>
      <select class="item-select" name="Fabric_Group" required id="id_Fabric_Group">
          {% if form.instance.id %}
              <option value="{{ form.instance.Fabric_Group.id }}">{{ form.instance.fab_grp }}</option>
              {% for x in fab_grp %}
                  <option value="{{ x.id }}">{{ x.fab_grp_name }}</option>
              {% endfor %}
          {% elif not form.instance.id %}
              <option value=""></option>
              {% for x in fab_grp %}
                  <option value="{{ x.id }}">{{ x.fab_grp_name }}</option>
              {% endfor %}
          {% endif %}
      </select>
  </div>

    <div class=" d-flex my-3">
      <label for="id_Item_Color" class=" item-form">Color:</label>
      <select class="item-select" name="Item_Color" required id="id_Item_Color" required>

        <!-- form.instance.Color_Name got from (def Color_Name(self):) which returns Item_Color.color_name the actual color
                  When you access a foreign key field in Django templates, by default, it returns the related object, not just its ID.
                  To access the ID of the related object, you need to use the dot notation to access the ID attribute explicitly.
                  {{ form.instance.Item_Color.id }} -->

        {% if form.instance.id %}
        <option value="{{ form.instance.Item_Color.id}}">{{form.instance.Color_Name}}</option>
        {% for x in colors %}
        <option value="{{x.id}}">{{x.color_name}}</option>
        {% endfor %}
        {% elif not form.instance.id %}
        <option value=""></option>
        {% for x in colors %}
        <option value="{{x.id}}">{{x.color_name}}</option>
        {% endfor %}
        {% endif %}
      </select>

    </div>
    {% if form.instance.id %}
    <div class="d-flex mb-3">
      <label for="id_Item_shades" class="item-form">Shades:</label>
      <!-- Render reverse related relationship fields dynamically using formset factory  -->
      <div class="mx-3 mb-3">
        <table class="table table-striped table-hover table-responsive rounded-3" id="shadeTable">
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Shade Name</th>
            <th>Opening Qty</th>
            <th>Delete</th>
          </tr>
          {{ formset.management_form }}
          {% for shade_form in formset %}
          {{ shade_form.id }}
            <tr>
             <input type="hidden" name="{{ shade_form.prefix }}-openingValue" id="{{ shade_form.prefix }}-openingValue" value="">
              <!-- Render each field manually -->
              <td>
                <!-- item_name_rank -->
                {% if forloop.first %}
                <input type="number" class="item-select" name="{{ shade_form.prefix }}-item_name_rank"
                  id="{{ shade_form.prefix }}-item_name_rank" value="{{ shade_form.instance.item_name_rank }}"readonly>
                  <!-- <td>{{shade_form.item_name_rank}}</td> -->
                {% else %}
                 <input type="number" class="item-select" name="{{ shade_form.prefix }}-item_name_rank"
                  id="{{ shade_form.prefix }}-item_name_rank" value="{{ shade_form.instance.item_name_rank | default_if_none:''}}">
                  <!-- <td>{{shade_form.item_name_rank}}</td> -->
                {% endif %}

              </td>        
                   <td>
                <!-- item_shade_name -->
              {% if forloop.first %}
              <input type="text" class="item-select" name="{{ shade_form.prefix }}-item_shade_name"
                id="{{ shade_form.prefix }}-item_shade_name" value="{{ shade_form.instance.item_shade_name }}" readonly>
                {% else %}
              <input type="text" class="item-select" name="{{ shade_form.prefix }}-item_shade_name"
                id="{{ shade_form.prefix }}-item_shade_name" value="{{ shade_form.instance.item_shade_name | default_if_none:'' }}">
              {% endif %}
            </td>
            <td>
              {% if shade_form.instance.item_color_image %}
              <img src="{{ shade_form.instance.item_color_image.url }}" alt="Image Preview" style="max-width: 150px; max-height: 150px;">
            {% endif %}
            <div>
              <input type="file" class="pt-1 itemQty" style="width: 250px;" name="{{ shade_form.prefix }}-item_color_image" accept="image/*" id="{{ shade_form.prefix }}-item_color_image">
            </div>
              </td>
            <td><button type="button" class="add_btn itemQty" id="{{ shade_form.prefix }}-opening_qty" name="{{ shade_form.prefix }}-opening_qty" >Add</button></td>
              
              <td><span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="shade_deleteId px-2" style="display: none;"  name="{{shade_form.prefix}}-DELETE" id="{{shade_form.prefix}}-DELETE" value="" ></i></span></td>
            </tr>
          
          {% endfor %}
        </table>
      </div>
    </div>
    {% endif %}

    <div class=" d-flex my-3">
      <label for="id_Material_code" class="item-form">Material Code:</label>
      <input type="text" class="item-select" name="Material_code" value="{{form.instance.Material_code}}"
        maxlength="255" required id="id_Material_code">
    </div>
    <div class=" d-flex my-3">
      <label for="id_Item_Packing" class="item-form">Packing:</label>
      <select name="Item_Packing" class="item-select" required id="Item_Packing">

        {% if form.instance.id %}
        <option value="{{form.instance.Item_Packing.id}}">{{form.instance.Packaging_Material}}</option>
        
        {% elif not form.instance.id %}
        <option value=""></option>
        {% endif %}

        {% for package_m in packaging_material_all  %}
        <option value="{{package_m.id}}">{{package_m.packing_material}}</option>
        {% endfor %}

      </select>
    </div>
    <div class=" d-flex my-3">
      <label for="id_unit_name_item" class="item-form">Unit Name:</label>
      <select name="unit_name_item" class="item-select" required id="id_unit_name_item">

        {% if form.instance.id %}
        <option value="{{ form.instance.unit_name_item.id }}">{{ form.instance.Unit_Name}}</option>
        {% for x in unit_name %}
        <option value="{{x.id}}">{{x.unit_name}}</option>
        {% endfor %}
        {% elif not form.instance.id %}
        <option value=""></option>
        {% for x in unit_name %}
        <option value="{{x.id}}">{{x.unit_name}}</option>
        {% endfor %}
        {% endif %}

      </select>
    </div>
    <div class=" d-flex my-3">
      <label for="id_Units" class=" item-form">Units:</label>
      <input type="number" class="item-select" name="Units" value="{{form.instance.Units}}" step="0.01" required id="id_Units">
    </div>

    <div class=" d-flex my-3">
      <label for="id_Panha" class=" item-form">Panha:</label>
      <input type="number" class="item-select" name="Panha" value="{{form.instance.Panha}}" step="0.01" required
        id="id_Panha">
    </div>
    <div class=" d-flex my-3">
      <label for="id_Fabric_nonfabric" class=" item-form">Fabric/Non Fabric:</label>
      <select name="Fabric_nonfabric" class="item-select" required id="id_Fabric_nonfabric">
        <option value="{{form.instance.Fabric_nonfabric}}">{{form.instance.Fabric_nonfabric}}</option>
        <option value="Fabric">Fabric</option>
        <option value="Non Fabric">Non Fabric</option>
      </select>
    </div>
    <div class="d-flex my-3">
      <label for="id_Item_Fabric_Finishes" class="item-form">Fabric Finishes:</label>
      <select name="Item_Fabric_Finishes" class="item-select" required id="id_Item_Fabric_Finishes">

        {% if form.instance.id %}
        <option value="{{form.instance.Item_Fabric_Finishes.id}}">{{form.instance.Fab_Finishes}}</option>
        {% elif not form.instance.id %}
        <option value=""></option>
        {% endif %}
        {% for fab_finish in fab_finishes %}
        <option value="{{fab_finish.id}}">{{fab_finish.fabric_finish}}</option>
        {% endfor %}

      </select>
    </div>
    <div class="d-flex my-3">
      <label for="id_GST" class="item-form">GST:</label>
      <select name="Item_Creation_GST" class="item-select" required id="id_Item_Creation_GST">

        {% if form.instance.id %}
        <option value="{{ form.instance.Item_Creation_GST.id }}">{{ form.instance.Item_GST}}</option>
        {% elif not form.instance.id %}
        <option value=""></option>
        {% endif %}
        {% for gst in gsts %}
        <option value="{{gst.id}}">{{gst.gst_percentage}}</option>
        {% endfor %}
      
      </select>
    </div>
    <div class="d-flex my-3">
      <label for="id_HSN_Code" class="form-label item-form">HSN Code:</label>
      <input type="text" class="item-select" name="HSN_Code" value="{{form.instance.HSN_Code}}" required
        id="id_HSN_Code">
    </div>
    <div class="d-flex my-3">
      <label for="id_status" class="form-label item-form">Status:</label>
      <select name="status" class="item-select" required id="id_status">
        <option value="{{form.instance.status}}">{{form.instance.status}}</option>
        <option value="Used">Used</option>
        <option value="Unused">Unused</option>
        <option value="Slow Moving">Slow Moving</option>
        <option value="Dead">Dead</option>
      </select>
    </div>
    {% if not form.instance.id %}
    <div class="d-flex my-3">
      <diV>
        <label for="id_status" class="form-label item-form">Image:</label>
      </diV>
      
      <div class="">
        <img id="iFrame" src="..." class="py-1" alt="..." style="width: 10rem; height: 10rem;">
        <input type="file" class=" " style="width: 201px;" name="item_shade_image" id="item_shade_image" onchange="preview()">
      </div>
      
      
    </div>
    {% endif %}
    <input type="submit" class="newProductCreateBtn" name="save" value="Save">
  </form>
</div>

{% if not form.instance.id %}
<div class="col-lg-1">
    <div class="">
      <button class="fab_btn" onclick="openFabPopup()">+</button>
    </div>
    <div class="">
      <button class="col_btn"  onclick="opencolorPopup()">+</button>
    </div>
    <div class="">
      <button class="package_btn"  onclick="openPackagePopup()">+</button>
    </div>
    <div class="">
      <button class=" unit_btn"  onclick="openunitPopup()">+</button>
    </div>
    <div class="">
      <button class="finish_btn"  onclick="openFabricFinishPopup()">+</button>
    </div>
    <div class="">
      <button class="gst_btn"  onclick="openGstPopup()">+</button>
    </div>
   
    
</div>

{% endif %}
</div>
<script>
 window.addEventListener('message', function(event) {
    const data = event.data;

    if (data.gst_updated) {
        populateDropdown(data.gst_updated, '#id_Item_Creation_GST', 'gst_percentage', 'Select GST');
    }

    if (data.color_all) {
        populateDropdown(data.color_all, '#id_Item_Color', 'color_name', 'Select Color');
    }
    if (data.Fabric_Group_all) {
        populateDropdown(data.Fabric_Group_all, '#id_Fabric_Group', 'fab_grp_name', 'Select Fabric Group');
    }
    if (data.packaging_all_values) {
        populateDropdown(data.packaging_all_values, '#Item_Packing', 'packing_material', 'Select Packaging');
    }
    if (data.Unit_Name_all_values) {
        populateDropdown(data.Unit_Name_all_values, '#id_unit_name_item', 'unit_name', 'Select Unit');
    }
    if (data.fabric_finishes_all) {
        populateDropdown(data.fabric_finishes_all, '#id_Item_Fabric_Finishes', 'fabric_finish', 'Select Fabric Finishes');
    }
});

function populateDropdown(items, dropdownSelector, valueKey, defaultText) {
    const dropdown = $(dropdownSelector);
    dropdown.empty();
    dropdown.append('<option value="">' + defaultText + '</option>');

    items.forEach(item => {
        dropdown.append('<option value="' + item.id + '">' + item[valueKey] + '</option>');
    });
}



  </script>


<script>
  //This script is to ajax reuest send the data and highlight the searched item in the dropdown and the suggestion will be shown on the screen
  $(document).ready(function () {
    var enterValue = false;
    var index = 0; //  index outside of the event listener
   var indexbool = false;
   var isHighlighted = false; // flag to track if an item is highlighted

   var suggestions = $('#search-results')
    $(document).on('keyup','#id_item-to-clone',function(){

      var nameValue = $(this).val().trim();
     
    
      
   if(nameValue === '') {
    suggestions.css('display', 'none');
        $(this).attr('data-key', '');
        return;
   }
   if(!enterValue){             // Show the dropdown only if Enter key was not pressed
    suggestions.css('display', 'block');
    }
    enterValue = false;
    
   
    if(nameValue.length >= 3){
 
      $.ajax({
            url: '/itemdynamicsearchajax/',
            method: 'GET',
            data: {
                'nameValue': nameValue
            },
            success: function (response) {
             var searchData = response.searched_item_name_dict
              function escapeRegExp(string) {
                       return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
               }

                var searchQuery = nameValue.toLowerCase();
                var escapedSearchQuery = escapeRegExp(searchQuery); // Escape special characters in search query
                var regex = new RegExp('(' + escapedSearchQuery + ')', 'gi');

                var filteredOptions = Object.entries(searchData).filter(([key, value]) => value.toLowerCase().includes(searchQuery));
       

                suggestions.empty();
                $.each(filteredOptions, function(index, [key, value]) {
                  var highlightedText = value;
        
                if (searchQuery) {
                    highlightedText = value.replace(regex, '<span class="highlight">$1</span>');
                }
                  
                  suggestions.append(`<div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion " data-key="${key}">${highlightedText}</div>`);
                
                });
              
            },
            error:function(xhr){
            console.log(xhr.status + ": " + xhr.responseText);
                if (xhr.status === 404 || xhr.status === 400) {
                  suggestions.css('display', 'block');
                  suggestions.empty();
                  suggestions.append(`<div" class="itemName-div itemName-div-suggestion ">No item found</div>`);
                }
        }
        });
    }else{
        suggestions.empty();
    }
      
     
        suggestions.on('click', '.itemName-div-suggestion', function() {
       
       $(this).closest('.custom-dropdown-container').find('.product2Select').val($(this).text().trim());
       $(this).addClass('selected').siblings().removeClass('selected');

       var itemValue = $(this).attr('data-key');
      
       $.ajax({
            url: '/itemcreatecloneajax/',
            method: 'GET',
            data: {
                'itemValue': itemValue
            },
            success: function (response) {
                item_data_response = response.response_data
                console.log(item_data_response)
              
                var r_fab_group = item_data_response.fabric_group
                var r_color = item_data_response.color
                var r_m_code = item_data_response.material_code
                var r_packing = item_data_response.packing
                var r_unit_name = item_data_response.unit_name
                var r_panha = item_data_response.panha
                var r_fab_non_fab = item_data_response.fab_non_fab
                var r_fab_finishes = item_data_response.fab_finishes
                var r_gst = item_data_response.gst
                var r_hsn_code = item_data_response.hsn_code
                var r_status = item_data_response.status
              
                $('#id_Fabric_Group').val(r_fab_group.fab_g_key);
            
                $('#id_Item_Color').val(r_color.color_key);
                
                $('#id_Material_code').val(r_m_code);

                $('#Item_Packing').val(r_packing.packing_key);
  
                $('#id_unit_name_item').val(r_unit_name.unit_name_key);

                $('#id_Panha').val(r_panha);
              
                $('#id_Fabric_nonfabric').val(r_fab_non_fab);
              
                $('#id_Item_Fabric_Finishes').val(r_fab_finishes.fab_finishes_key);
              
                $('#id_Item_Creation_GST').val(r_gst.gst_key);
              
                $('#id_HSN_Code').val(r_hsn_code);

                $('#id_status').val(r_status);

              
                
            },
            error: function (xhr, errmsg, err) {
                console.log('Error sending value to the backend');
            }
        })

        suggestions.css('display', 'none');
        
   })

    })
    $('#id_item-to-clone').on('keyup', function() {
    if ($(this).val().length === 0) {
      suggestions.empty();
    }
  });

    
$(document).on('click', '.product2Select',function(){
        var selectValue = $(this).next('.s-suggestion-container');
        selectValue.css('display', 'none');
        selectValue.empty();
    })

    $(document).on('keydown', '[name^="item-to-clone"]', function (e) {
      var nameDataKey;
        var nameKey;
        var selectValue = $(this).next('.s-suggestion-container');

        var selectedItems = selectValue.find(`#itemName-div_${index}`);
        var selectLength = selectValue.find('.itemName-div').length-1;
       
        var nameData = $(this).val().trim();

        if(nameData === ''){
         
         index = 0;
         indexbool = false;
         return;
     }

     if(e.key=== 'ArrowDown'){

          e.preventDefault();

            // Remove highlight from previously selected item
        selectValue.find('.bg-highlight').removeClass('bg-highlight');

          if(index <= selectLength){
              var selectedItem = selectValue.find(`#itemName-div_${index}`);
              var nextItem = selectedItem.next();

                // Add highlight to the currently selected item
                isHighlighted = true; // Set the flag to true when an item is highlighted
                selectedItem.addClass('bg-highlight');
              
              nameDataKey= selectedItem.text();
              nameKey = selectedItem.data('key');
              $(this).attr('data-key', nameKey);
              $(this).text(nameDataKey);
           

              var itemOffsetTop = nextItem.position() ? nextItem.position().top : 0;
              var itemHeight = nextItem.outerHeight();
              var selectScrollTop = selectValue.scrollTop();
              var selectHeight = selectValue.height();

              if (itemOffsetTop + itemHeight > selectHeight) {
                  selectValue.scrollTop(selectScrollTop + itemHeight);

              } else if (itemOffsetTop < 0) {
                  selectValue.scrollTop(selectScrollTop - itemHeight);
              }
             
              selectedItem.toggleClass('bg-highlight', true);
              if(index != selectLength ){
                  index += 1; 
              indexbool = true;        
              }     
                
          }else{
            index = 0;
          }
      
          }
          if(e.key === 'ArrowUp'){
            event.preventDefault();

             selectValue.find('.bg-highlight').removeClass('bg-highlight');
        
            if (index != 0 && indexbool == true)
            {           
                  index = index - 1;
            }
            
            if(index <= selectLength){
          
              var selectedItem = selectValue.find(`#itemName-div_${index}`);
              var prevItem = selectedItem.prev();

                // Add highlight to the currently selected item
                isHighlighted = true;
                selectedItem.addClass('bg-highlight');
        
              nameDataKey= selectedItem.text();
              nameKey = selectedItem.data('key');

              $(this).attr('data-key', nameKey);
              $(this).text(nameDataKey);

      
          
              var itemOffsetTop = prevItem.position() ? prevItem.position().top : 0;
              var itemHeight = prevItem.outerHeight();
              var selectScrollTop = selectValue.scrollTop();
              var selectHeight = selectValue.height();

              if (itemOffsetTop < 0) {
                  selectValue.scrollTop(selectScrollTop - itemHeight);
              } else if (itemOffsetTop + itemHeight > selectHeight) {
                  selectValue.scrollTop(selectScrollTop + itemHeight);
              }
              }
              else{
                      index = 0;
              }   
               // Set the flag to true when an item is highlighted
          }
          if(e.key === 'Enter'){
          e.preventDefault();
          var commomSugenstionHide = $(this).closest('.custom-dropdown-container').find(`#search-results`);
          var selectedItem = $(this);
          var nameValues = $(this).text().trim();
          var itemValue = selectedItem.attr('data-key');
          
          if (selectedItem.length > 0) {
              
              $(this).val(nameValues);
           
            $.ajax({           // this ajax reuest is to send the data and show the all the option will filed once click on the suggestion on the screen
            url: '/itemcreatecloneajax/',
            method: 'GET',
            data: {
                'itemValue': itemValue
            },
            success: function (response) {
              var item_data_response = response.response_data
          
              
                var r_fab_group = item_data_response.fabric_group
                var r_color = item_data_response.color
                var r_m_code = item_data_response.material_code
                var r_packing = item_data_response.packing
                var r_unit_name = item_data_response.unit_name
                var r_panha = item_data_response.panha
                var r_fab_non_fab = item_data_response.fab_non_fab
                var r_fab_finishes = item_data_response.fab_finishes
                var r_gst = item_data_response.gst
                var r_hsn_code = item_data_response.hsn_code
                var r_status = item_data_response.status
              
                $('#id_Fabric_Group').val(r_fab_group.fab_g_key);
            
                $('#id_Item_Color').val(r_color.color_key);
                
                $('#id_Material_code').val(r_m_code);

                $('#Item_Packing').val(r_packing.packing_key);
  
                $('#id_unit_name_item').val(r_unit_name.unit_name_key);

                $('#id_Panha').val(r_panha);
              
                $('#id_Fabric_nonfabric').val(r_fab_non_fab);
              
                $('#id_Item_Fabric_Finishes').val(r_fab_finishes.fab_finishes_key);
              
                $('#id_Item_Creation_GST').val(r_gst.gst_key);
              
                $('#id_HSN_Code').val(r_hsn_code);

                $('#id_status').val(r_status);

              
                
            },
            error: function (xhr, errmsg, err) {
                console.log('Error sending value to the backend');
            }
        })
           
          }

          index = 0;
          indexbool = false;
          enterValue = true; // Set the flag to true when Enter is pressed
          commomSugenstionHide.css('display', 'none'); // Hide the dropdown
          commomSugenstionHide.empty();

          }    

    })

})


</script>

<script>

  document.addEventListener('DOMContentLoaded', function() {
    // Add click event listener to all delete buttons
    document.querySelectorAll('.delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            // Find the row containing the clicked delete button
            var row = this.closest('tr');
            var checkRow = row.querySelector('.shade_deleteId[name^="shades-"][name$="-DELETE"]');
            if (checkRow) {
                checkRow.checked = true; // Mark as checked
                checkRow.value = 'true'; // Set the value to 'true'

                row.style.display = 'none';

            } else {
                console.error("Checkbox for deletion not found in this row");
            }
        });
    });

   
});

function receiveData(openingValue){
     var totalForm = document.getElementById('id_shades-TOTAL_FORMS');
    console.log(totalForm)
      var popupData = openingValue;
      console.log(popupData)
      for(var i = 0 ; i<totalForm ; i++){
        document.getElementById('shades-'+i+'openingValue').value = popupData;
      }
      
     
    }
</script>

<script>
  $(document).ready(function(){
    var newPopup = null;
    var itemValue;

    $(document).on ('click','button.itemQty',function(button){
      var itemId = $(this).closest('tr').find('input[name$="item_name_rank"]').attr('name');
       itemValue = itemId.split('-')[1];
      var primaryKey = document.getElementById('id_shades-'+itemValue+'-id');
      var primary_key_id = primaryKey.value;
    
      if (newPopup === null || newPopup.closed) { // Check if no popup is open or the existing one is closed
                    var minWidth = 800;
                    var minHeight = 600;
      $.ajax({
        url: '{% url "opening-godown-qty-ajax" %}',
        type: 'GET',
        data:{
          itemValue:itemValue,
          primary_key_id:primary_key_id
        },
        success: function (response){
          console.log('Data sent successfully')
          popupWindow = window.open(response.popup_url, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
        },
        error: function (xhr, errmsg, err) {
                            console.log('Error getting popup URL');
        }
      })
      }
    })

  })
  


  </script>



<script>

  var popUpWindow = null;


  function openFabPopup(button) {
    if (popUpWindow === null || popUpWindow.closed) {
      newPopUpwindow(button, '{% url "fabric-popup" %}');
    } else {
      popUpWindow.focus();
    }
  }

  function opencolorPopup(button) {
    if (popUpWindow === null || popUpWindow.closed) {
      newPopUpwindow(button, '{% url "color-popup" %}');
    } else {
      popUpWindow.focus();
    }
  }

  function openunitPopup(button) {
    if (popUpWindow === null || popUpWindow.closed) {
      newPopUpwindow(button, '{% url "unit-name-popup" %}');
    } else {
      popUpWindow.focus();
    }
  }
  function openGstPopup(button) {
    if (popUpWindow === null || popUpWindow.closed) {
      newPopUpwindow(button, '{% url "gst-popup" %}');
    } else {
      popUpWindow.focus();
    }
  }
  function openPackagePopup(button) {
    if (popUpWindow === null || popUpWindow.closed) {
      newPopUpwindow(button,'{% url "packaging-popup" %}');
    } else {
      popUpWindow.focus();
    }
  }

  function openFabricFinishPopup(button) {
    if (popUpWindow === null || popUpWindow.closed) {
      newPopUpwindow(button, '{% url "fabric-finishes-popup" %}');
    } else {
      popUpWindow.focus();
    }
  }


  
  function newPopUpwindow(button, path) {
    // Specify minimum height and width
    var minWidth = 800; // minimum width
    var minHeight = 600; // minimum height

    // Open new page with specified dimensions
    popUpWindow = window.open( path, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
 
    // Listen for messages from the popup window
    window.addEventListener('message', function (event) {
      if (event.data === 'popupClosed'|| event.data === 'submit') {
        // Close the popup window
    
        // Reload parent page when popup window is closed
        location.reload();
      }
    });
  }


  document.querySelector('input[type="file"]').addEventListener('change', function(event) {
      var imgPreview = document.getElementById('iFrame');
      var file = event.target.files[0];
      var reader = new FileReader();

      reader.onload = function() {
        imgPreview.src = reader.result;
      }

      if (file) {
        reader.readAsDataURL(file);
      }
    });
</script>



{% endblock body %}