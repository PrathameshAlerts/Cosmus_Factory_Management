{% extends 'product/base.html' %} 
{% load static %} 
{% block body %}

<h2 class="mb-3 mt-4">Create Product</h2>
  <button class="add_btn" onclick="openNewColor()">Add Color +</button>
<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  
  <div class="d-flex mt-4 mb-4">
    <label for="id_Product_Refrence_ID" class="item-form fw-bold">Refrence ID :
    </label>
    <input type="number" name="Product_Refrence_ID" id="Product_Refrence_ID" value="{{ref_id | default_if_none:''}}">
  </div>
 
  <div class="d-flex flex-wrap">
    {{formset.management_form}}
    {% for form in formset %}
    {{form.id}}
    <div id="cardContainer">
      <div class="card card-clone" style="width: 15rem;">
        <button type="button" value="cancel" class="cancel-btn"><i class="fa-solid fa-xmark"></i></button>
        <img id="frame-{{forloop.counter}}" src="" class="card-img-top card-img p-1" alt="..." />
       
      
        <div class="card-body card-input">
          <div class="mb-2 d-flex">
            <label for="id_{{form.prefix}}-PProduct_image" class="form-label">Image</label>
            <input type="file" class="px-2 rounded-3" name="{{form.prefix}}-PProduct_image"  id="id_{{form.prefix}}-PProduct_image" value="{{form.instance.PProduct_image}}" />
          </div>
          <div class="mb-2 d-flex">
            <label for="id_{{form.prefix}}-PProduct_color" class="form-label me-1">Color</label>
            <select required name="{{form.prefix}}-PProduct_color" id="id_{{form.prefix}}-PProduct_color" class="rounded-3">
              <option value="-" selected>---------</option>
              {%for c in color %}
              <option value="{{ c.id }}">{{c.color_name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-2 d-flex">
            <label for="id_{{form.prefix}}-PProduct_SKU" class="form-label pe-4">SKU</label>
            <input type="number" name="{{form.prefix}}-PProduct_SKU" min="-9223372036854775808" max="9223372036854775807" id="id_{{form.prefix}}-PProduct_SKU" class="rounded-3 w-75 px-2" value="{{form.instance.PProduct_SKU}}" />
          </div>
          <div class="mb-2 d-flex">
            <label for="id_{{form.prefix}}-Product_EANCode" class="form-label pe-4">EANCode</label>
            <input type="number" name="{{form.prefix}}-Product_EANCode" maxlength="100" id="id_{{form.prefix}}-Product_EANCode" class="rounded-3 w-75 px-2" value="{{form.instance.Product_EANCode}}" />
          </div>
        </div>
        
      </div>
    </div>
    {% endfor %}
    <span style="padding-top: 100px;" class="add-button-container">
      <button type="button" id="addNewProductButton" class="add_btn">Add +</button>
    </span>

  </div>


  <div><input type="submit" class="newProductCreateBtn mt-5" name="save" value="Save"></div>

</form>

<script>

document.addEventListener("DOMContentLoaded", function () {
    // Counter to keep track of added cards

    // Event listener for adding new cards
    document.getElementById("addNewProductButton").addEventListener("click", function () {
        createCard();
    });

    function createCard() {
      const form  = document.getElementById('id_productdetails-TOTAL_FORMS');
      let totalForms = parseInt(form.value);
      console.log(totalForms);
        const cardContainer = document.getElementById("cardContainer");
      
        const cardClone = document.querySelector(".card-clone");

        // Clone the card clone element
        const newCard = cardClone.cloneNode(true);

        // Display the new card
         newCard.style.display = "block";
        const cardFile = newCard.querySelector('input[type="file"]');
        cardFile.id = `id_productdetails-${totalForms}-PProduct_image`;
        cardFile.setAttribute("name", `productdetails-${totalForms}-PProduct_image`);
        newCard.querySelector('input[name$="-PProduct_image"]').value = "";

        const cardColor = newCard.querySelector('select[name$="-PProduct_color"]');
        cardColor.id = `id_productdetails-${totalForms}-PProduct_color`;
        cardColor.setAttribute("name", `productdetails-${totalForms}-PProduct_color`);
        cardColor.selectedIndex = 0;

        const cardSKU = newCard.querySelector('input[name$="-PProduct_SKU"]');
        cardSKU.id = `id_productdetails-${totalForms}-PProduct_SKU`;
        cardSKU.setAttribute("name", `productdetails-${totalForms}-PProduct_SKU`);
        cardSKU.value = "";

        const cardEANCode = newCard.querySelector('input[name$="-Product_EANCode"]');
        cardEANCode.id = `id_productdetails-${totalForms}-Product_EANCode`;
        cardEANCode.setAttribute("name", `productdetails-${totalForms}-Product_EANCode`);
        cardEANCode.value = "";

        // newCard.querySelector('input[type="file"]').value = "";
        // newCard.querySelector('input[name$="-PProduct_SKU"]').value = "";
        // newCard.querySelector('select[name$="-PProduct_color"]').selectedIndex = 0;
        // newCard.querySelector('input[name$="-Product_EANCode"]').value = "";

        // Update input names with dynamic counters
        // newCard.querySelectorAll("input, select").forEach(function (element) {
        //     const name = element.getAttribute("name");
        //     element.setAttribute("name", name.replace(/-0-/, `-${cardCounter}-`));
        // });

        // Event listener for image preview
        newCard.querySelector('input[type="file"]').addEventListener("change", function (event) {
            const imgPreview = newCard.querySelector(".card-img-top");
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function () {
                imgPreview.src = reader.result;
            };

            if (file) {
                reader.readAsDataURL(file);
            }
        });

        // Event listener for canceling the card
        newCard.querySelector(".cancel-btn").addEventListener("click", function (event) {
            const card = event.target.closest(".card");
            card.parentNode.removeChild(card);
            form.value = totalForms - 1; // Decrement the counter
        });

        form.value = totalForms + 1;
        cardContainer.appendChild(newCard);
         // Increment the counter
    }
   
    // Initial image preview setup for existing cards
    document.querySelectorAll('.card-clone').forEach(function (card, index) {
        const imageInput = card.querySelector('input[type="file"]');
        if (imageInput && imageInput.value) {
            const imgPreview = card.querySelector(".card-img-top");
            imgPreview.src = imageInput.value;
        }
    });

});
</script>

<script>
  let popUpWindow = null;
  function openNewColor(button) {
    if (popUpWindow === null || popUpWindow.closed) {
      newPopUpwindow(button, '{% url "color-popup" %}');
    } else {
      popUpWindow.focus();
    }
  }

  function newPopUpwindow(button, path) {
    // Specify minimum height and width

    $('body').addClass('popup-open');
    $('body').append('<div class="popup-overlay"></div>');
    const minWidth = 800; // minimum width
    const minHeight = 600; // minimum height

    // this will generate http://127.0.0.1:8000/ 
    const baseUrl = "{{ request.scheme }}://{{ request.get_host }}";
    popUpWindow = window.open(baseUrl + path, "_blank", "width=" + minWidth + ", height=" + minHeight + ", resizable=yes");

    window.addEventListener('message', function(event){
      if (event.data.message === 'close') {
        $('body').removeClass('popup-open');
        $('.popup-overlay').remove();
          popUpWindow.close();
      }
    });
        
     // Listen for messages from the popup window
    window.addEventListener('click', function(event) {
      handleOutside(event);
    });
  }

  function handleOutside(event) {
    const popUpRect = document.querySelector('body').getBoundingClientRect();
    const clickX = event.clientX;
    const clickY = event.clientY;

      // Check if the click is outside the popup window
      if ( clickX > popUpRect.left || clickX <= popUpRect.right || clickY > popUpRect.top || clickY <= popUpRect.bottom) {
    
        popUpWindow.focus();  
      }
  }
</script>

{% endblock body %}