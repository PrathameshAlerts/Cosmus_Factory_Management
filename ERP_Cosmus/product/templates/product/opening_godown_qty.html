{% extends 'misc/navbar_popup.html' %}
{% load static %} 

{% block body %} 

<h2>Shade Name :</h2>

<form class="mt-5" action="" method="POST">
    {% csrf_token %}  

    <table id="tableItem" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Godown Name</th>
                <th>Opening Qty</th>
                <th>Rate</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody class="mainTableList">
            {{formset.management_form}}
            {% for form in formset %}
            {{ form.id }}
            <tr>
                <input type="hidden" class="old-qty" value="" id ="{{form.prefix}}-old_opening_quantity" name="{{form.prefix}}-old_opening_quantity">
                <td>
                    <select name="{{form.prefix}}-opening_godown_id" id="{{form.prefix}}-opening_godown_id" class="purchase-input godown-select">
                    {% if form.instance.id %}
                    <option value="{{form.instance.opening_godown_id.id}}">{{form.instance.opening_godown_id.godown_name_raw}}</option>
                    {% for godown in godowns %}
                    <option value="{{godown.id}}">{{godown.godown_name_raw}}</option>
                    {% endfor %}
                    {% elif not form.instance.id %}
                    <option value=""></option>
                    {% for godown in godowns %}
                    <option value="{{godown.id}}">{{godown.godown_name_raw}}</option>
                    {% endfor %}
                    {% endif %}
                </select>

                </td>

                <td>
                    <input type="number" class="purchase-amount item-qty" name="{{form.prefix}}-opening_quantity" value="{{form.instance.opening_quantity | default_if_none:''}}" id="{{form.prefix}}-opening_quantity">
                </td>
                <td>
                    <input type="number" class="purchase-amount item-rate" name="{{form.prefix}}-opening_rate" value="{{form.instance.opening_rate | default_if_none:''}}" id="{{form.prefix}}-opening_rate">
                </td>
                <td>
                    <input type="checkbox" name="{{form.prefix}}-DELETE" id="{{form.prefix}}-DELETE" class="godown_delete">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div>
        <button type="button" class="create-btn ms-3 mb-3" id="addRow">Add +</button>
    </div>
   

    <input type="submit"  onsubmit="" class="create-btn ms-5 mt-4" name="save" value="Save">
</form>

<script>

   document.addEventListener('DOMContentLoaded', function () {
    const addItem = document.getElementById('addRow');
    const tableId = document.querySelector('#tableItem tbody');
 
    if(addItem && tableId){
        addItem.addEventListener('click',function(){

            var newTableRate = tableId.lastElementChild;
            console.log('newTableRate',newTableRate)
    
            var newRates = newTableRate.querySelector('.item-rate[name^="opening_shade_godown_quantity_set-"][name$="-opening_rate"]').value;
       

           console.log(newRates)
            const index = document.getElementById('id_opening_shade_godown_quantity_set-TOTAL_FORMS');
            const indexValue = parseInt(index.value);
           
            const rows = tableId.lastElementChild.cloneNode(true);
            const rateValue = rows.querySelector('.item-rate[name^="opening_shade_godown_quantity_set-"][name$="-opening_rate"]').value;
            console.log('rateValue',rateValue);

            rows.querySelectorAll('input ,select').forEach(element => {
                element.value ='';
            });

            const itemElement = rows.querySelector('.godown-select[name^="opening_shade_godown_quantity_set-"]');
            itemElement.name = `opening_shade_godown_quantity_set-${indexValue}-opening_godown_id`;
            itemElement.id = `opening_shade_godown_quantity_set-${indexValue}-opening_godown_id`;
           
            
            const qtyElement = rows.querySelector('.item-qty[name^="opening_shade_godown_quantity_set-"][name$="-opening_quantity"]');
            qtyElement.name = `opening_shade_godown_quantity_set-${indexValue}-opening_quantity`;
            qtyElement.id = `opening_shade_godown_quantity_set-${indexValue}-opening_quantity`;
            qtyElement.value = '';

            const newQtyElement = rows.querySelector('.old-qty[name^="opening_shade_godown_quantity_set-"][name$="-old_opening_quantity"]');
            newQtyElement.name = `opening_shade_godown_quantity_set-${indexValue}-old_opening_quantity`;
            newQtyElement.id = `opening_shade_godown_quantity_set-${indexValue}-old_opening_quantity`;
            newQtyElement.value = '';

            const rateElement = rows.querySelector('.item-rate[name^="opening_shade_godown_quantity_set-"][name$="-opening_rate"]');
            rateElement.name = `opening_shade_godown_quantity_set-${indexValue}-opening_rate`;
            rateElement.id = `opening_shade_godown_quantity_set-${indexValue}-opening_rate`;
            rateElement.value= rateValue;
            rateElement.setAttribute('readonly', true);

        

            const deleteElement = rows.querySelector('.godown_delete[name^="opening_shade_godown_quantity_set-"][name$="-DELETE"]');
            deleteElement.name = `opening_shade_godown_quantity_set-${indexValue}-DELETE`;
            deleteElement.id = `opening_shade_godown_quantity_set-${indexValue}-DELETE`;

            tableId.appendChild(rows);
            index.value = indexValue + 1;


       
         
            
        })
    }

   })
</script>
{% endblock body %}