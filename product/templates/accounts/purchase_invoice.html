{% extends 'product/base.html' %} 
{% load static %} 
{% block body %} 
<div>
    <!-- <h2>Purchase invoice</h2> -->
    <form class="mt-4" action=""method="POST" autocomplete="off" id="newForm">
        
        {% csrf_token %}
        <div class="">
            <div class="d-flex mb-3">
                <span id="purchaseError" class="error-messages"></span>
                <div class="d-flex ">
                    <label for="id_purchase_number"  class="me-3">Purchase No :</label>
                    {% if master_form.instance.id %}
                    <input type="text" class="item-select" name="purchase_number" id ="id_purchase_number" value="{{master_form.instance.purchase_number}}" maxlength="255" required readonly>
                    {% elif not master_form.instance.id %}
                    <input type="text" class="item-select" name="purchase_number" id ="id_purchase_number" value="{{master_form.purchase_number.initial}}" maxlength="255" required>
                    {% endif %}
                </div>
                <div class="d-flex ms-3">
                    <label for="id_supplier_invoice_number" class="item-form" >Supplier Invoice No :</label>
                    <input type="text" class="item-select" name="supplier_invoice_number" id ="id_supplier_invoice_number" value="{{master_form.instance.supplier_invoice_number}}" maxlength="255" required >
                </div>
                <div class="d-flex ms-3">
                    <label for="id_GST_numbers" class="item-form" >Company GST No :</label>
                    <input type="text" class="item-select" name="GST_numbers" id ="id_company_GST_numbers" value="27AAACG20210238" maxlength="50" readonly >
                </div>
            </div>
            <div class="d-flex">
                <div class="d-flex mb-3">
                    <label for="id_ledger_type" class="me-3" >ledger Type :</label>
                    <input type="text" class="item-select" name="ledger_type" id ="id_ledger_type" value="{{master_form.instance.ledger_type}}" maxlength="50" default='Purchase' readonly required placeholder="Purchase" >
                </div>
                <div class="d-flex ms-3">
                    <label for="id_party_name" class="me-3" >Party A/C Name :</label>
                    <select class="product2Select" name="party_name" required id="id_party_name">
                        {% if master_form.instance.id %}
                        {% for x in party_names %}
                        <option value="{{x.id}}">{{x.name}}</option>
                        {% endfor %}
                        {% elif not master_form.instance.id %}
                        <option value=""></option>
                        {% for x in party_names %}
                        <option value="{{x.id}}">{{x.name}}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                    <button type="button" class="itemCreate_btn popup-trigger" onclick="openPurchasePartyPopup()">+</button>
                </div>
                <div class="d-flex ms-3">
                    <label for="id_GST_number" class="me-2" >Party GST No :</label>
                    <input type="text" class="item-select" name="GST_number" id ="id_GST_number"  value="{% if master_form.instance.id %}{{ master_form.instance.party_name.Gst_no }}{% endif %}" maxlength="15" readonly required>
                </div>
            
            </div>
        </div>

        <table id="myTable" class="table table-striped table-hover table-responsive">
            <thead class="name_absolute">
                <th>No</th>
                <th colspan="2">Item Name</th>
                <th style="padding-left: 25px;">Colour</th>
                <th style="padding-left: 20px;">Shade</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Units</th>
                <th>Tax</th>
                <th>GST %</th>
                <th>CGST</th>
                <th>SGST/IGST</th>
                <th>Total Amount</th>
                <th>DELETE</th>
            </thead>
            <tbody class="mainTableList">
                {{items_formset.management_form}}
                {% for forms in items_formset %}
                {{ forms.id }}
                
                <tr>
                    <input type="hidden" id="{{forms.prefix}}-popupData" name="{{forms.prefix}}-popupData" value="">    
                    <input type="hidden" id="{{forms.prefix}}-jsonDataInputquantity" value="" name="{{forms.prefix}}-jsonDataInputquantity">
                    <input type="hidden" class="unique-id" name="item_unique_id_{{forloop.counter0}}" value='' id="item_unique_id_{{forloop.counter0}}">
                    <input type="hidden" id="{{forms.prefix}}-deleteJsonData" value="" name="{{forms.prefix}}-deleteJsonData">
                    <input type="hidden" id="{{forms.prefix}}-old_item_shade" value="{{forms.instance.item_shade.id}}" name="{{forms.prefix}}-old_item_shade">
                    <input type="hidden" id="{{forms.prefix}}-old_item_shade_for_dropdown_change" value="{{forms.instance.item_shade}}" name="{{forms.prefix}}-old_item_shade_for_dropdown_change">
                    
                    
                    <td><input type="number" class="rowNo purchase-mark bg-transparent border-0" name="rowNo_{{forloop.counter0}}" id="rowNo_{{forloop.counter0}}" value="{{forloop.counter}}"></td>
                    <td colspan="2">
                        <div class="custom-dropdown-container">
                            <input  type="text" name="item_name_{{forloop.counter0}}" id="item_name_{{forloop.counter0}}" class="product2Selectpurchase search-input"  placeholder="Item Name" autocomplete="off" value="{% if forms.instance.id %}{{ forms.instance.item_shade.items.item_name }}{% endif %}"  > 
                            <div name="select_item_name_{{forloop.counter0}}" class="product2Selectpurchase item-name s-suggestion-container item-select_input" id="select_item_name_{{forloop.counter0}}" style="display: none; height:auto;" dir="auto" spellcheck="false" tabindex="0" aria-label="Item Name" >
                              
                           
                             </div>
                        </div> 
                    </td>
                    <td><input type="text" name="item_color_{{forloop.counter0}}" id="item_color_{{forloop.counter0}}" value="{% if forms.instance.id %}{{ forms.instance.item_shade.items.Item_Color.color_name }}{% endif %}" class="purchase-input" style="margin-left: 10px;" readonly></td>
                    <td>
                        <input type="hidden" id="id_item_checkshade-{{forloop.counter0}}" name="item_checkshade-{{forloop.counter0}}" value=""> 
                        <span name="input_item_shade_{{forloop.counter0}}" id="input_item_shade_{{forloop.counter0}}" class="purchase-select" style="border: none ;color: #000; background-color: transparent; display: none; outline: none;" readonly value=""></span>
                        <select name="{{forms.prefix}}-item_shade" class="purchase-select item-shade" placeholder="Item Shades"  id="{{forms.prefix}}-item_shade">

                             {% if forms.instance.id %} 
                             <option value="{{forms.instance.item_shade.id}}">{{forms.instance.item_shade.item_shade_name}}</option>

                             {% elif not forms.instance.id %}
                             <option value=""></option>
                             {% endif %}

                        </select>
                       
                    </td>
                    <td><input type="number" id="{{forms.prefix}}-quantity_total" class="purchase-input purchase-qunatity" name="{{forms.prefix}}-quantity_total" value="{{forms.instance.quantity_total | default_if_none:'' }}" readonly></td>
                    <td><input type="number" id="{{forms.prefix}}-rate" class="purchase-input purchase-rate" name="{{forms.prefix}}-rate" value="{{forms.instance.rate | default_if_none:''}}" readonly></td>
                    <td style="width: 50px;"><input type="text" name="item_per_{{forloop.counter0}}" id="item_per_{{forloop.counter0}}" value="{% if forms.instance.id %}{{ forms.instance.item_shade.items.unit_name_item.unit_name }}{% endif %}" class="purchase-mark" readonly></td>
                    <td>
                        <input type="number" id="{{forms.prefix}}-amount" class="purchase-amount total-amount" name="{{forms.prefix}}-amount" value="{{forms.instance.amount | default_if_none:''}}" readonly>
                    </td>
                    <td>
                        <input type="number" id="{{forms.prefix}}-gst" class="purchase-mark purchase-gst" name="{{forms.prefix}}-gst" value="{{ forms.instance.item_shade.items.Item_Creation_GST.gst_percentage}}" readonly >
                    </td>
                    <td>
                        <input type="number" id="{{forms.prefix}}-cgst" class="purchase-input purchase-cgst" name="{{forms.prefix}}-cgst" value=""readonly >
                    </td>
                    <td>
                        <input type="number" id="{{forms.prefix}}-sgst" class="purchase-input purchase-sgst" name="{{forms.prefix}}-sgst" value=""readonly >
                    </td>
                    <td><input type="number" id="{{forms.prefix}}-total_amount" class="purchase-amount purchase-total" name="{{forms.prefix}}-total_amount" value="" readonly></td>
                    <td><span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="godown_deleteId px-2" style="display: none;"  name="{{forms.prefix}}-DELETE" id="{{forms.prefix}}-DELETE" value="" ></i></span></td>
                    
                </tr>   
                {% endfor %}
            </tbody>
            <tbody>
                <tr>
                    <td class="text-center" ><label style="padding-left: 20px;">Total</label></td>
                    <td colspan="4"></td>
                    <td> <input type="number" class="purchase-input" style="border: 1px solid red;" name="grand_quantity" id ="id_grand_quantity" value="" maxlength="50" step=".01" readonly></td>
                    <td colspan="2"></td>
                    <td><input type="number" class="purchase-amount" style="border: 1px solid red;"  name="grand_taxableAmount" id ="id_grand_taxableAmount" value="" maxlength="50" step=".01" readonly ></td>
                    <td></td>
                    <td><input type="number" class="purchase-input" style="border: 1px solid red;" name="grand_cgst" id ="id_grand_cgst" value="" maxlength="50" step=".01" readonly></td>
                    <td><input type="number" class="purchase-input" style="border: 1px solid red; " name="grand_Sgst" id ="id_grand_sgst" value="" maxlength="50" step=".01" readonly > </td>
                    <td> <input type="number" class="purchase-amount" style="border: 1px solid red;" name="grand_amount" id ="id_grand_amount" value="" maxlength="50" step=".01" readonly></td>
                </tr>
            </tbody>

        </table>
       
    <div class="row">
        <div class="col-lg-9">
            <div class="ms-2">
                <input type="number" class="product_row" name="productRow" id="id_productRow" value="1">
                <button type="button" class="item-btn mb-3" id="addRowButton">Add +</button>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="mb-4">
                <div class=" mb-3">
                    <label  class="purchase-lable fw-bold">Gross total</label>
                    <span class="purchase-span">
                        <input type="number" class="purchaseTableLabel-Gtotal  purchase-amounts" name="gross_total" id ="id_gross_total" value="{{master_form.instance.gross_total | default_if_none:''}}" maxlength="50" step=".01" readonly >
                    </span>           
                </div>
                <div class=" mb-3">
                    <label class="purchase-lable fw-bold">Fright & Transport</label>
                    <span class="purchase-span">
                        <input type="number" class="purchaseTableLabel-transport  purchase-amounts" name="fright_transport" id ="id_fright_transport" value="{{master_form.instance.fright_transport | default_if_none:'0'}}" maxlength="50" step=".01" required >
                    </span>
                </div>
                <div class=" mb-3">
                    <input type="hidden" id="temp_grand_total" value="">
                    <label class="purchase-lable fw-bold">Round Of </label>
                    <span class="purchase-span">
                        <input type="number" class="purchaseTableLabel-roundOf  purchase-amounts" name="round_off" id ="id_round_off" value="" maxlength="50" step=".01" readonly required>
                    </span> 
                </div>
            
                <div class=" mb-3">
                    <label class="purchase-lable fw-bold">Grand total</label>
                    <span class="purchase-span"><input type="number" class="purchaseTableLabel-total purchase-amounts" name="grand_total" value="{{master_form.instance.grand_total | default_if_none:''}}" id="id_grand_total" step=".01" readonly required></span> 
                </div>
            </div>
        </div>
        
        
        
    </div>
      <button type="submit" class="ms-5 newProductCreateBtn" id="parentFormClick">Submit</button>
    </form>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
      <div class="modal-body justify-content-center text-center">
        <img src="../../../static/images/Cosmus.png" alt="loading..." height="120px" width="120px" class="spinner_image">
        </div>
        </div>
    </div> 
</div>


<!--This script use for party name add which use in ledger create popup-->
<script>
      document.body.appendChild(document.getElementById('exampleModal'));
      $('#newForm').off('submit').on('submit', function(e) {
            var $submitButton = $('#id_submitPurchaseOrderCutting');  // The submit button
            var originalButtonValue = $('#exampleModal');  // Store original button text
            originalButtonValue.show();
        });

    var popUpNewWindow = null;
function openPurchasePartyPopup(button){
    openNewPopup(button, '{% url "ledger-popup-create" %}');
}

function openNewPopup(button, url){
    if (popUpNewWindow === null || popUpNewWindow.closed) {
        newPopUpwindow(button, url);
    } else {
  
        popUpNewWindow.focus();
    }
}

function newPopUpwindow(button, path){
    // Specify minimum height and width
  var minWidth = 1150; // minimum width
  var minHeight = 800; // minimum height

  $('body').addClass('popup-open');
  $('body').append('<div class="popup-overlay"></div>');

  // Open new page with specified dimensions
  popUpNewWindow = window.open(path, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
    // Ensure only one event listener is attached
  
    window.addEventListener('message', function(event){
        if (event.data.message === 'close') {
                $('body').removeClass('popup-open');
                $('.popup-overlay').remove();
                popUpNewWindow.close();
                
             }
           });


    // Listen for messages from the popup window
    window.addEventListener('click', function(event) {
    handleOutsideClick(event);
  });
}
function handleOutsideClick(event) {
var popUpRect = document.querySelector('body').getBoundingClientRect();
var clickX = event.clientX;
var clickY = event.clientY;
 
  // Check if the click is outside the popup window
  if (
    clickX > popUpRect.left || clickX <= popUpRect.right ||
    clickY > popUpRect.top || clickY <= popUpRect.bottom
  ) {
   
    popUpNewWindow.focus();
    
  }

}

window.addEventListener('message', function(event) {
    const data = event.data;
    console.log(data.ledger_labour);
    if (data.ledger_labour) {
        populateDropdownLedger(data.ledger_labour, '#id_party_name', 'name', 'Select Name');
    }
});

function populateDropdownLedger(items, dropdownSelector, valueKey, defaultText) {
    const dropdown = $(dropdownSelector);
    dropdown.empty();
    dropdown.append('<option value="">' + defaultText + '</option>');

    items.forEach(item => {
        dropdown.append('<option value="' + item.id + '">' + item[valueKey] + '</option>');
    });
}
</script>

<script>
    $(document).ready(function(){
        $('#id_purchase_number').on('focusout',function(){
            var purchase_number = $(this).val();
           
            var purchase = $("#id_purchase_number");
            var errorElement = $('#purchaseError'); // The error message element
            var submitForm = $('#parentFormClick');
            $.ajax({
                url: '/uniquevalidcheckajax/',
                method: 'GET',
                data: {
                    'purchase_number': purchase_number,
                    
                },
                success: function (data) {
                    if(data.validation_flag === true){
                       purchase.css('border', '1px solid red');
                        errorElement.text('*Purchase number already exists');
                        errorElement.show();
                        submitForm.prop('disabled', true);
                       
                    }else {
                        
                        purchase.css('border', '1px solid black');
                        errorElement.text('');
                        errorElement.hide();
                        submitForm.prop('disabled', false);
                    }
                   
                },
                error: function (error) {   
                    console.log(error);
                }

            })
        })
    })
 $(document).ready(function(){

        $('#id_challan_no').on('focusout',function(){
            var challanNo = $(this).val();
            var challanId = $("#id_challan_no");
            var errorElement = $('#challanError'); // The error message element
            var submitButton = $('#id_submitLabourWorkOut');
            var formId = $('#labourTable').find('#id_labour_workout_cutting_items_set-0-id').val();
      
            if(formId == ""){
                $.ajax({
                url: '/uniquevalidcheckajax/',
                method: 'GET',
                data: {
                    'labour_workout_challan_no': challanNo,
                    
                },
                success: function (data) {
                    if(data.validation_flag === true){
                        challanId.css('border', '1px solid red');
                        errorElement.text('*Challan number already exists');
                        errorElement.show();
                        submitButton.attr('disabled', 'disabled');
                    }else {
                        challanId.css('border', '1px solid black'); 
                        errorElement.text('');
                        errorElement.hide();
                        submitButton.removeAttr('disabled');
                    }
                   
                },
                error: function (error) {   
                    console.log(error);
                }

            })
            }
            
        })
    
    })
  
    window.addEventListener('message', receiveMessage, false);
    function receiveMessage(event) {
        const dataWithPrefix = event.data;
        const convertedData = {};

        if (typeof dataWithPrefix === 'object' && Object.keys(dataWithPrefix).length > 0) {
            const datalength = Object.values(dataWithPrefix)[0]
            const dataId =Object.keys(dataWithPrefix)[0];
            var datasId;
            if (dataId) {
                 datasId = dataId.split('_')[1];
                    // Use datasId as needed
            } else {
                    // Handle the case where dataId is undefined
                 console.log('No dataId found');
            }
            if(datalength){
                for (let i = 0; i < datalength.length; i++) {
                    const name = datalength[i].name;
                    const value = datalength[i].value;
                    const original_value = datalength[i].original_value || null;
                    const changeData = datalength[i].change_type
               
                    if (convertedData.hasOwnProperty(name)) {
                        if (!Array.isArray(convertedData[name])) {
                            convertedData[name] = [convertedData[name]]; // Convert to array
                        }
                        convertedData[name].push(value); // Push new value to array
                    } else {
                        convertedData[name] = value; // Set the initial value
                    } 
                }
            }else {
                // Handle the case where dataId is undefined
                console.log('No dataId found');
            }

        }
             // Set the popupData with convertedData
        if(datasId != ''){
        var data = document.getElementById('purchase_voucher_items_set-' + datasId + '-popupData');
         data.value = JSON.stringify(convertedData);
        }
    }

</script>


 <script>
// this code contain the popup window for on submit button send to to parent window 
// this function retrive the data and compare with same unquie id and update the table data

//pefix value on item-shade change 
    function updateFormData(newSessionData){
       // const newId = newSessionData.newUniqueId;
        const newQty = newSessionData.newTotalQty;
        const newRate = newSessionData.newTotalRate;
        //const primaryKey = newSessionData.newPrimaryKey;
        const prefixId = newSessionData.prefixValue;
        const oldQty =  document.getElementById('purchase_voucher_items_set-'+ prefixId + '-quantity_total')
        const oldRate =  document.getElementById('purchase_voucher_items_set-'+ prefixId + '-rate')  
        oldQty.value = newQty
        oldRate.value = newRate
        calculateTotalAmount()
        calculateOtherTotal()
    }
 
// This function access for child popup window data on submit button. this data will be reflated to the main godown qunatity with the godown name 
    function BackendQuantityjson(jsonString){
        const jsonData = JSON.parse(jsonString);
        const row_prefix_child = jsonData.parent_row_prefix_id;
        // const all_rate_child = jsonData.all_Rate;
        // const godown_data = jsonData.newRow; 
        const updateJsonData= document.getElementById('purchase_voucher_items_set-'+ row_prefix_child + '-jsonDataInputquantity');

            updateJsonData.value = JSON.stringify(jsonData);
    }
    

// This function use for comparing the company gst with party gst no and calculate the cgst,sgst and igst 
function getGstNo() {
    let partyGstValue = document.getElementById('id_GST_number').value;
    let comapnyGst = document.getElementById('id_company_GST_numbers').value;

        comapnyGst = comapnyGst.toString();
        partyGstValue = partyGstValue.toString();

    const newCompanyGst = comapnyGst.slice(0,2);
    const newPartyGst = partyGstValue.slice(0,2);
    return newCompanyGst === newPartyGst;
}

</script>
 <script>
//this ajax is for gst no 
    $(document).ready(function () {

        $(document).on('change', 'select[name^="party_name"]', function () {

            const selected_party_name = $(this).val()
            const int_selected_party_name = parseInt(selected_party_name)

            $.ajax({
                url: '/purchasevouchercreate/',
                method: 'GET',
                data: {
                    'selected_party_name': selected_party_name,
                },
                success: function (response) {
                    const party_gst_no_response = response.party_gst_no
                    const gst_no_input = document.getElementById('id_GST_number')
                    gst_no_input.value = party_gst_no_response
                    getGstNo()
                    calculateTotalAmount()
                },
                error: function (xhr, errmsg, err) {
                    console.log('Error sending value to the backend');
                }
            })
        })
    })

    // this function gereate a randow uuid and store the value in unique id
function randomValue (){
    var itemShadeIdValue;
    const itemName = document.querySelector('select[name^="purchase_voucher_items_set-"]').closest('tr');
    const selectElement = itemName.querySelector('select[name^="purchase_voucher_items_set-"]');
    const itemShadeName = selectElement.getAttribute('name');
    const totalForms = document.getElementById('id_purchase_voucher_items_set-TOTAL_FORMS').value;
 
    itemShadeIdValue = itemShadeName.split('-')[1];

    for( let i =0; i<totalForms ; i++){
    const uuid = uuidv4();
    const primeId = document.getElementById('id_purchase_voucher_items_set-' +i+ '-id').value;
    if(primeId == ''){
        const uniqueId = document.getElementById('item_unique_id_' + i);
        uniqueId.value = uuid;   
    }
   }
 }
  randomValue();

 </script>

 <script>
    //This ajax call is to populate the shade and color based on the selected item once retrive the value
    // When click the item name then append the shades with the color, per 
    $(document).ready(function () {
        var itemName;
        var uniqueIdValue;
        var purchaseValue;
        var selectName;
        var searchedItemNameDic; 
        var enterPressed = false;

         // perfix value on item-name change
        $(document).on('click input keyup focus keydown', 'input[name^="item_name_"]', function () {
        itemName = $(this).closest('tr').find('select[name^="purchase_voucher_items_set-"]').attr('name');
        purchaseValue = itemName.split('-')[1];
                
        });

        $(document).on('change','select[name^="purchase_voucher_items_set-"]', function () {
        var newData = document.getElementById('purchase_voucher_items_set-'+purchaseValue+'-jsonDataInputquantity').value;
        var itemShade = document.querySelector('#input_item_shade_'+ purchaseValue);
        var itemShadeValue = document.querySelector('#purchase_voucher_items_set-'+purchaseValue+'-old_item_shade_for_dropdown_change')
        var selectElementValue = itemShadeValue.value;
       
        if(newData == ''){
            itemShade.textContent = selectElementValue;
            itemShade.style ="display: none";
        }

        });
        
        // This ajax request for a input type value send to the backend and show the input name 
        $(document).on('input', 'input[name^="item_name_"]', function(e) {
            var purchaseValue = $(this).attr('name').match(/\d+/)[0]; // Extract the numeric value from the input name
            var nameValue = $(this).val().trim();
            var selectNameValue = `select_item_name_${purchaseValue}`;
            var suggestionsContainer = $(`#${selectNameValue}`);
            var purchaseData = $(`#purchase_voucher_items_set-${purchaseValue}-popupData`).val();
            var jsonData = $(`#purchase_voucher_items_set-${purchaseValue}-jsonDataInputquantity`).val();
            var uniqueValue = $(`#item_unique_id_${purchaseValue}`).val();
        
            if (nameValue === 'None') {
                var selectNameValue = $(this).closest('tr').find('[name^="select_item_name_"]');
                    
                selectNameValue.css('display', 'none');
                $(this).attr('data-key', '');
                return;
            }

            if(!enterPressed){
                suggestionsContainer.css('display', 'block');
            }
            enterPressed = false;
        
            if ((purchaseData === '' && uniqueValue !== '') || (purchaseData === '' && uniqueValue === '' && jsonData === '')) {
                if(nameValue.length >= 1){
                    $.ajax({
                    url: '/itemdynamicsearchajax/',
                    method: 'GET',
                    data: { 'nameValue': nameValue },
                    success: function (response) {

                        // Function to escape special characters in the search query
                        function escapeRegExp(string) {
                            return string.replace(/[.*+?^${}()|[\]\\,]/g, '\\$&');
                        }
                        searchedItemNameDict = response.searched_item_name_dict;
                        var searchQuery = nameValue.toLowerCase();
                        var escapedSearchQuery = escapeRegExp(searchQuery); // Escape special characters in search query
                        console.log('escapedSearchQuery',searchedItemNameDict)
                        var regex = new RegExp('(' + escapedSearchQuery + ')', 'gi');
                        var filteredOptions = Object.entries(searchedItemNameDict).filter(([key, value]) => value.toLowerCase().includes(searchQuery));
                        
                        // Clear and repopulate options
                        suggestionsContainer.empty();

                        $.each(filteredOptions, function(index, [key, value]) {
                            let highlightedText = value;
                            let colorStyle = '';
                            if (searchQuery) {
                                highlightedText = value.split("|")[0].replace(regex, '<span class="highlight">$1</span>');
                                const valueCalculate = value.split("|")[1].split(",")[0].trim(); 
                                const numberKey = value.split(/-?\d+(\.\d+)?,/)[2].trim();

                                // Initialize the color based on valueCalculate
                                
                                if (parseFloat(valueCalculate) > 0) {
                                    colorStyle = 'color: green; float: right;';
                                } else {
                                    colorStyle = 'color: red;  float: right;';
                                }

                                if(numberKey.includes(searchQuery)){
                                    numberKeyHighlighted = `<span class="highlight">M Code - ${numberKey}</span>`;
                                }else {
                                    numberKeyHighlighted = `M Code - ${numberKey}`;
                                }
                                suggestionsContainer.append(`<div id="itemName-div_${index}" class="itemName-div itemName-div-suggestion " data-key="${key}">${highlightedText} <span style="${colorStyle}">${valueCalculate}</span>
                                    <br>
                                    <span style="font-weight:bold">${numberKeyHighlighted}</span>
                                    </div>`);
                            } 
                            
                
                        });
                        
                    
                    },
                    error: function (xhr) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        if (xhr.status === 404) {
                            
                            suggestionsContainer.show();
                            suggestionsContainer.empty();
                            suggestionsContainer.append(`<div" class="itemName-div itemName-div-suggestion ">No item found</div>`);
                        }
                    }
                });
                }else{
                    suggestionsContainer.empty();
                }
                
            } else {
                var itemNameData = $(this).closest('tr').find('input[name^="item_name_"]');
                var shadeNameData = $(this).closest('tr').find('select[name^="purchase_voucher_items_set-"]');
                itemNameData.attr('readonly', true);
                shadeNameData.prop('disabled', true);
            }
        
            suggestionsContainer.on('click', '.itemName-div', function(e) {
                var item_value = $(this).data('key');
                var itemNamevaluesCheck = $(this).text();
             console.log('itemNamevaluesCheck',itemNamevaluesCheck)
                var newData = $('#purchase_voucher_items_set-' + purchaseValue + '-jsonDataInputquantity').val();
                var itemShade = $('#input_item_shade_' + purchaseValue);
                var itemShadeValue = $('#purchase_voucher_items_set-' + purchaseValue + '-old_item_shade_for_dropdown_change').val();
            
                $(this).closest('.custom-dropdown-container').find('.search-input').val(itemNamevaluesCheck);
                $(this).addClass('selected').siblings().removeClass('selected');

                if (newData == '' && itemShadeValue != '' && itemShadeValue != "None") {
                    itemShade.text(itemShadeValue);
                    itemShade.show();
                }
                handleSelection(purchaseValue,itemName, item_value)
                suggestionsContainer.css('display', 'none');
                
            });
        
        
        });

       // Function to handle the AJAX request and UI updates
        function handleSelection(purchaseValue,itemName, item_value) {

        if (item_value !== undefined) {
        var selectedValue = searchedItemNameDict[item_value];
        var namevalueCheck = selectedValue.match(/[a-zA-Z\s().]+/g).join('');
        var numberValue = selectedValue.match(/-?\d+(\.\d+)?/g)[0];
        var newnameValue = namevalueCheck.replace(/[\.\s]+$/, '');
        var valueKey = namevalueCheck + ' ' + numberValue ;
            
        $(`input[name^="item_name_${purchaseValue}"]`).val(newnameValue);

        $.ajax({
            url: '/purchasevouchercreate/',
            method: 'GET',
            data: {
                'item_value': item_value,
            },
            success: function (response) {
                var itemrownameid = itemName.split('-')[1];
                var differentShades = Object.keys(response.item_shade).length;
                
                var itemCheckshadeValue = document.querySelector('#id_item_checkshade-' + itemrownameid);
                itemCheckshadeValue.value = response.auto_popup_flag;
                    var itemcolorinput = document.querySelector('#item_color_' + itemrownameid);
                    var item_color = response.item_color;

                    var itemperinput = document.querySelector('#item_per_' + itemrownameid);
                    var itemperinput_response = response.item_per;

                    itemcolorinput.value = item_color;
                    itemperinput.value = itemperinput_response;

                    var itemgstinput = document.querySelector('#purchase_voucher_items_set-' + itemrownameid + '-gst');
                    var item_gst_value_response = response.item_gst_out;
                    itemgstinput.value = item_gst_value_response;

                if(differentShades > 1){
                    $('#' + itemName).empty().append('<option value="">Select Shade</option>');

                    
                    var item_shade_response = response.item_shade;
                    var item_shade__quantity = response.item_shades_total_quantity_dict;

                    $.each(item_shade_response, function (key, value) {
                        if (item_shade__quantity.hasOwnProperty(key)) {

                            var item_shade_qty = item_shade__quantity[key];
                            var optionHtml;

                            if (item_shade_qty > 0) {
                                optionHtml = '<option value="' + key + '" style="color: green;">' + value + '&nbsp;&nbsp;&nbsp;' +item_shade_qty + '</option>';
                            } else {
                                optionHtml = '<option value="' + key + '" style="color: red;">' + value + '&nbsp;&nbsp;&nbsp;' + item_shade_qty + '</option>';
                            }

                            var $option = $(optionHtml);
                            $('#' + itemName).append($option);

                            // Additional fallback for browsers that don't support <span> within <option>
                            if ($option.find('span').length === 0) {
                                $option.css('color', item_shade_qty > 0 ? 'green' : 'red');
                            }

                        } else {
                            $('#' + itemName).append('<option value="' + key + '">' + value + '</option>');
                        }
                    }); 
                }else{

                    $('#' + itemName).empty();
                    var item_shade_response = response.item_shade;
                    var item_shade__quantity = response.item_shades_total_quantity_dict;

                    $.each(item_shade_response, function (key, value) {
                        if (item_shade__quantity.hasOwnProperty(key)) {

                            var item_shade_qty = item_shade__quantity[key];
                            var optionHtml;

                            if (item_shade_qty > 0) {
                                optionHtml = '<option value="' + key + '" style="color: green;">' + value + '&nbsp;&nbsp;&nbsp;' +item_shade_qty + '</option>';
                            } else {
                                optionHtml = '<option value="' + key + '" style="color: red;">' + value + '&nbsp;&nbsp;&nbsp;' + item_shade_qty + '</option>';
                            }

                            var $option = $(optionHtml);
                            $('#' + itemName).append($option);

                            // Additional fallback for browsers that don't support <span> within <option>
                            if ($option.find('span').length === 0) {
                                $option.css('color', item_shade_qty > 0 ? 'green' : 'red');
                            }

                        } else {
                            $('#' + itemName).append('<option value="' + key + '">' + value + '</option>');
                        }
                    }); 

                }
                ajaxInProgress = false;
            },
            error: function (xhr, errmsg, err) {
                console.log('Error sending value to the backend');
                ajaxInProgress = false;
            }
        });
      }
      }

        $(document).on('click','[name^="item_name_"]', function(event) {

            event.preventDefault();
            // const  selectName = $(this).closest('tr').find('[id^="select_item_name_"]').attr('id');
            // const selectItem = $(`#${selectName}`);
            var purchaseData = $(`#purchase_voucher_items_set-${purchaseValue}-popupData`).val();
            //selectItem.css("display" ,"none");
            if(purchaseData != ""){
                var itemNames = $(this).closest('tr').find('input[name^="item_name_"]');
                var itemShade = $(this).closest('tr').find('select[name^="purchase_voucher_items_set-"]');
                itemNames.attr('readonly', true);
                itemShade.prop('disabled', true);
            }
            
        })

        var index = 0; // Declare index outside of the event listener
        var indexbool = true;

     $(document).on('keydown', 'input[name^="item_name_"]', function(event) {
        const $inputField = $(this);
        const $dropdownOptions = $inputField.next('.item-name');
        const $options = $dropdownOptions.find('.itemName-div');
        const optionsCount = $options.length - 1;
        const searchText = $inputField.val().trim();
        const hiddenValue = $inputField.closest('.custom-dropdown-container').find(`#select_item_name_${purchaseValue}`);
        if (searchText === '') {
            index = 0;
            return;
        }
        const newHeight = $inputField.offset();
        const windowHeight = $(window).height();
        const availableSpace = windowHeight - newHeight.top - $inputField.outerHeight();
        //  $dropdownOptions.css({
        // 'max-height': availableSpace + 'px',
        // 'overflow-y': 'auto'
        //  });

        if (event.key === 'ArrowDown') {
             event.preventDefault();

            if (index <= optionsCount) {
            
                const $selectedItem = $options.eq(index);
                const $nextItem = $selectedItem.next();
                const nameDataKey = $selectedItem.text();
                const nameKey = $selectedItem.data('key');

                $inputField.attr('data-key', nameKey);
             
                $selectedItem.addClass('bg-highlight').siblings().removeClass('bg-highlight');
                const itemOffsetTop = $nextItem.position().top;
                const itemHeight = $nextItem.outerHeight();
                const selectScrollTop = $dropdownOptions.scrollTop();
                const selectHeight = $dropdownOptions.height();

                if (itemOffsetTop + itemHeight > selectHeight) {
                    $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                } else if (itemOffsetTop < 0) {
                    $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                }
                $selectedItem.addClass('selected');
                if (index !== optionsCount) {
                    index += 1;
                    indexbool = true;
                }
            } else {
                index = 0;
            }
        }

        if (event.key === 'ArrowUp') {
             event.preventDefault();

            if (index != 0 && indexbool == true) {
                index -= 1;
            }

            if (index <= optionsCount) {
               
                const $selectedItem = $options.eq(index);
                const $prevItem = $selectedItem.prev();
                const nameDataKey = $selectedItem.text();
                const nameKey = $selectedItem.data('key');

                $inputField.attr('data-key', nameKey);
                
                $selectedItem.addClass('bg-highlight').siblings().removeClass('bg-highlight');
                
                const itemOffsetTop = $prevItem.position().top;
                const itemHeight = $prevItem.outerHeight();
                const selectScrollTop = $dropdownOptions.scrollTop();
                const selectHeight = $dropdownOptions.height();

                if (itemOffsetTop < 0) {
                    $dropdownOptions.scrollTop(selectScrollTop - itemHeight);
                } else if (itemOffsetTop + itemHeight > selectHeight) {
                    $dropdownOptions.scrollTop(selectScrollTop + itemHeight);
                }

                $selectedItem.addClass('selected');
            } else {
                index = 0;
            }
        }

        if (event.key === 'Enter') {
             event.preventDefault();
            const itemEnterValue = $(this);
            const item_value = itemEnterValue.attr('data-key');

            nameDataKey = '';
            nameKey = '';
            index = 0;
            indexbool = false;

            const newData = $('#purchase_voucher_items_set-' + purchaseValue + '-jsonDataInputquantity').val();
            const itemShade = $('#input_item_shade_' + purchaseValue);
            const itemShadeValue = $('#purchase_voucher_items_set-' + purchaseValue + '-old_item_shade_for_dropdown_change').val();
        

            if (newData == '' && itemShadeValue != '' && itemShadeValue != "None") {
                itemShade.text(itemShadeValue);
                itemShade.show();
            }else{

                itemShade.hide();
            }
            handleSelection(purchaseValue,itemName, item_value);
            enterPressed = true;
            hiddenValue.css("display" ,"none");
    
        }
   
     });


     // This ajax call then select item name value send to the backend and append the shade ,color,per gst data show in the table
        var popupWindow = null; // Variable to hold the reference to the popup window
        
        $(document).on('focusin', 'select[name^="purchase_voucher_items_set-"]', function () {
            var shadeValue = $('#id_item_checkshade-' + purchaseValue ).val();
    
          // Unbind any previously bound events before binding new ones
            $(document).off('change', 'select[name^="purchase_voucher_items_set-"]');
            $(document).off('keydown', 'select[name^="purchase_voucher_items_set-"]');
            if (shadeValue === "false") {
                handleShadeValueFalse();
            } else if (shadeValue === "true") {
                handleShadeValueTrue();
            }
        })

        function handleShadeValueFalse() {
            $(document).on('change', 'select[name^="purchase_voucher_items_set-"]', function () {
                const selectedShade = $(this).val();
                const uniqueIdValue = $(this).closest('tr').find('input[name^="item_unique_id_"]').val();
                handlePopup(selectedShade, uniqueIdValue);
            });
        }

        function handleShadeValueTrue() {
            $(document).on('keydown', 'select[name^="purchase_voucher_items_set-"]', function (event) {
                event.preventDefault();
                if (event.key === 'Enter') {
                    const row = $(this);
                    const selectedShade = $(this).val();
                    const uniqueIdValue = $(this).closest('tr').find('input[name^="item_unique_id_"]').val();
                    const itemShades = $(this).closest('tr').find('[name^="input_item_shade_"]');
                    $(this).attr('disabled', 'disabled');
                    itemShades.hide();
                    handlePopup(selectedShade, uniqueIdValue);
        
                    $(this).removeAttr('disabled');
                }
            });
        }

        function handlePopup(selectedShade, uniqueIdValue) {
            const purchaseId = $('#id_purchase_voucher_items_set-' + purchaseValue + '-id').val();

            const prefix_id = purchaseValue;
                let primary_id = null;
                
                if(purchaseId ){
                    primary_id = purchaseId

                    if (primary_id === "") {
                        primary_id = null
                    }

                }

                if (selectedShade !== "" && primary_id !== null ) {
                        if (popupWindow === null || popupWindow.closed) { // Check if no popup is open or the existing one is closed
                            const minWidth = 800;
                            const minHeight = 600;
                    
                            $.ajax({
                                // Use Django URL name to fetch the URL dynamically
                                url: '{% url "purchasevoucher-createpopup-ajax" %}',
                                method: 'GET',
                                data: {
                                    'selected_shade': selectedShade,
                                    'purchase_id': primary_id,
                                    'prefix_id':prefix_id, 
            
                                },
                                success: function (response) {
                                    // Open the dynamic URL received from the server
                                
                                    popupWindow = window.open(response.popup_url, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
                            
                                },
                                error: function (xhr, errmsg, err) {
                                    console.log('Error getting popup URL');
                                }
                            });
                        } else {
                            // If a popup window is already open, notify the user or take appropriate action
                            console.log('A popup window is already open');
                        }
                    
                    }else if (uniqueIdValue !== "" && selectedShade !== "" ) {
                        if (popupWindow === null || popupWindow.closed) { // Check if no popup is open or the existing one is closed
                            const minWidth = 800;
                            const minHeight = 600;
                        
                            $.ajax({
                                // Use Django URL name to fetch the URL dynamically
                                url: '{% url "purchasevoucher-createpopup-ajax" %}',
                                method: 'GET',
                                data: {
                                    'selected_shade': selectedShade,
                                    'unique_invoice_row_id': uniqueIdValue,
                                    'prefix_id':prefix_id,
                                    
                                },
                                success: function (response) {
                                    // Open the dynamic URL received from the server
                                    popupWindow = window.open(response.popup_url, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes');
                    
                                },
                                error: function (xhr, errmsg, err) {
                                    console.log('Error getting popup URL');
                                }
                            });
                        } else {
                            // If a popup window is already open, notify the user or take appropriate action
                            console.log('A popup window is already open');
                        }
                    }
        }
    });
</script>


<script>
    //This script is to calculate the purchase invoice amount and create a new row to added and append it to the table-->
    function calculateTotalAmount() {
        let total = 0; 
        let totalQty = 0;
        let newGst =0;
        let newCgst = 0;
        let totalCgst =0;
        let newSgst = 0;
        let totalSgst =0;
        let grandTotal = 0;
        let grandTotalAmount = 0;
        // Iterate through each row
        const rows = Array.from(document.querySelectorAll('.mainTableList tr'))
        .filter(row => row.style.display !== 'none');
        rows.forEach(function(row) {
            // Find the quantity, rate, and amount input fields for the current row
            const quantityInput = row.querySelector('.purchase-input[name^="purchase_voucher_items_set-"][name$="-quantity_total"]');
            const rateInput = row.querySelector('.purchase-input[name^="purchase_voucher_items_set-"][name$="-rate"]');
            const amountInput = row.querySelector('.total-amount[name^="purchase_voucher_items_set-"][name$="-amount"]');
            const gstValue = row.querySelector('.purchase-gst[name^="purchase_voucher_items_set-"][name$="-gst"]');
            const cgstValue= row.querySelector('.purchase-cgst[name^="purchase_voucher_items_set-"][name$="-cgst"]');
            const sgstValue= row.querySelector('.purchase-sgst[name^="purchase_voucher_items_set-"][name$="-sgst"]');
            const totalAmountInput = row.querySelector('.purchase-total[name^="purchase_voucher_items_set-"][name$="-total_amount"]');
         
            // Get the values of quantity and rate
            const quantity = parseFloat(quantityInput.value);
            const rate = parseFloat(rateInput.value);
            const gst = parseFloat(gstValue.value);
         
            // Calculate the amount for the current row
            const amount = quantity * rate;
            totalQty  += quantity;
            // This function use for comparing the company gst with party gst no and calculate the cgst,sgst and igst
            if(getGstNo()){ 
            newGst = amount * gst / 100;
            newCgst = newGst / 2;
            newSgst = newGst / 2;
           
            cgstValue.value = isNaN(newCgst) ? '' : newCgst.toFixed(2);
            sgstValue.value = isNaN(newSgst) ? '' : newSgst.toFixed(2);

            totalCgst +=  newCgst;
            totalSgst +=  newSgst;
          
            total += amount; 
            grandTotal = amount + newCgst + newSgst;

          
        
           }else{
            cgstValue.value = ''
            let newIgst = amount * gst / 100;

            sgstValue.value = isNaN(newIgst) ? '' : newIgst.toFixed(2);
            totalSgst += newIgst;
            total +=  amount;  
            grandTotal = amount + newIgst ;
        
        }
            amountInput.value = isNaN(amount) ? '' : amount.toFixed(2);
            totalAmountInput.value = isNaN(grandTotal) ? '' : grandTotal.toFixed(2); 
          
            grandTotalAmount += grandTotal; 
           
        }); 
     
            document.getElementById('id_grand_taxableAmount').value = isNaN(total) ? '' :total.toFixed(2);
            document.getElementById('id_grand_quantity').value = isNaN(totalQty) ? '' :totalQty.toFixed(2);
            document.getElementById('id_grand_cgst').value = isNaN(totalCgst) ? '' :totalCgst.toFixed(2);
            document.getElementById('id_grand_sgst').value = isNaN(totalSgst) ? '' : totalSgst.toFixed(2);
            document.getElementById('id_grand_amount').value =isNaN(grandTotalAmount) ? '' : grandTotalAmount.toFixed(2);      
    }
    function calculateOtherTotal(grandTotal) {

         const grandTotals = parseFloat(document.getElementById('id_grand_amount').value);
          let  grossTotal = grandTotals;      
    
        // Set the calculated gross total value to the gross total input field
        document.getElementById('id_gross_total').value =isNaN(grossTotal) ? '' : grossTotal.toFixed(2);

        const frightTransport = parseFloat(document.getElementById('id_fright_transport').value);

        let finalTotal = grossTotal + frightTransport;

        document.getElementById('temp_grand_total').value =isNaN(finalTotal) ? '' : finalTotal.toFixed(2);

          
        let finalTotals = Math.round(finalTotal)
        let roundOff = finalTotals - finalTotal;

        document.getElementById('id_round_off').value =isNaN(roundOff) ? '' : roundOff.toFixed(2);
        // Set the calculated grand total value to the grand total input field
        document.getElementById('id_grand_total').value = isNaN(finalTotals) ? '' : finalTotals.toFixed(2);
    }
    // Call the function initially to calculate total amount, GST, and grand total on page load
 
    // Add onchange event handler to id_fright_transport
    document.getElementById('id_fright_transport').addEventListener('input', calculateOtherTotal);
    document.getElementById('id_round_off').addEventListener('input', calculateOtherTotal);
     
    

  
    // Event listener for the add row button
    document.addEventListener('DOMContentLoaded', function () {
    const addButton= document.getElementById('addRowButton');
    const tableBody = document.querySelector('#myTable tbody'); // Clone the first row of the table
    
    if(addButton && tableBody){
        addButton.addEventListener('click', function() {
            let addInputRow = parseInt(document.getElementById('id_productRow').value, 10);

                if (isNaN(addInputRow) || addInputRow <= 0) {
                    addInputRow = 1;
                    return;
                }
                let lastVisibleRow = null;
                tableBody.querySelectorAll('tr').forEach(row => {
                    if (window.getComputedStyle(row).display !== 'none') {
                        lastVisibleRow = row;
                    }
            });
            if (lastVisibleRow) {
                const formCountInput = document.getElementById("id_purchase_voucher_items_set-TOTAL_FORMS");
               
                for(let i = 0; i<addInputRow; i++){
                    const formCount = parseInt(formCountInput.value); 
                    const formIndex = formCount;
                    const lastRow = lastVisibleRow.cloneNode(true);
                    lastRow.querySelectorAll("input select").forEach(function (e) {
                        e.value = "";
                    });

                    // update the input name,id and value of the last row   
                    const rowElement = lastRow.querySelector('.rowNo[name^="rowNo_"]');
                    rowElement.id = `rowNo_${formIndex}`;
                    rowElement.name = `rowNo_${formIndex}`;
                    rowElement.value = formIndex + 1 ;
                    rowElement.style.border="none";

                    const inputSelectElement = lastRow.querySelector('.search-input[name^="item_name_"]');
                    inputSelectElement.id = `item_name_${formIndex}`;
                    inputSelectElement.name = `item_name_${formIndex}`;
                    inputSelectElement.value="";
                    inputSelectElement.removeAttribute('readonly');
                    
                    const oldShadeElement = lastRow.querySelector('[name^="input_item_shade_"]');
                    oldShadeElement.id = `input_item_shade_${formIndex}`;
                    oldShadeElement.name =  `input_item_shade_${formIndex}`;
                    oldShadeElement.value="";
                    oldShadeElement.style.display = 'none';

                    const selectElement = lastRow.querySelector('.item-name[name^="select_item_name_"]');
                    selectElement.id = `select_item_name_${formIndex}`;
                    selectElement.name = `select_item_name_${formIndex}`;
                    selectElement.innerHTML = '';

                    // Update input name and id
                    const colorInputElement = lastRow.querySelector('.purchase-input[name^="item_color"]');
                    colorInputElement.id = `item_color_${formIndex}`;
                    colorInputElement.name = `item_color_${formIndex}`;
                    colorInputElement.value="";

                    const selectElementShade = lastRow.querySelector('.item-shade[name^="purchase_voucher_items_set-"][name$="-item_shade"]');
                    selectElementShade.id = `purchase_voucher_items_set-${formIndex}-item_shade`;
                    selectElementShade.name = `purchase_voucher_items_set-${formIndex}-item_shade`;
                    selectElementShade.innerHTML = '';
                    selectElementShade.removeAttribute('disabled');

                    const qunatityInputElement = lastRow.querySelector('.purchase-qunatity[name^="purchase_voucher_items_set-"][name$="-quantity_total"]');
                    qunatityInputElement.id = `purchase_voucher_items_set-${formIndex}-quantity_total`;
                    qunatityInputElement.name = `purchase_voucher_items_set-${formIndex}-quantity_total`;
                    qunatityInputElement.value="";

                    const rateInputElement = lastRow.querySelector('.purchase-rate[name^="purchase_voucher_items_set-"][name$="-rate"]');
                    rateInputElement.id = `purchase_voucher_items_set-${formIndex}-rate`;
                    rateInputElement.name = `purchase_voucher_items_set-${formIndex}-rate`;
                    rateInputElement.value="";

                    const perInputElement = lastRow.querySelector('.purchase-mark[name^="item_per"]');
                    perInputElement.id = `item_per_${formIndex}`;
                    perInputElement.name = `item_per_${formIndex}`;
                    perInputElement.value="";

                    const amountInputElement = lastRow.querySelector('.total-amount');
                    amountInputElement.id = `purchase_voucher_items_set-${formIndex}-amount`;
                    amountInputElement.name = `purchase_voucher_items_set-${formIndex}-amount`;
                    amountInputElement.value="";

                    const gstElement = lastRow.querySelector('.purchase-gst[name^="purchase_voucher_items_set-"][name$="-gst"]');
                    gstElement.id = `purchase_voucher_items_set-${formIndex}-gst`;
                    gstElement.name = `purchase_voucher_items_set-${formIndex}-gst`;
                    gstElement.value="";
                    
                    
                    const cgstElement = lastRow.querySelector('.purchase-cgst[name^="purchase_voucher_items_set-"][name$="-cgst"]');
                    cgstElement.id = `purchase_voucher_items_set-${formIndex}-cgst`;
                    cgstElement.name = `purchase_voucher_items_set-${formIndex}-cgst`;
                    cgstElement.value="";

                    const sgstElement = lastRow.querySelector('.purchase-sgst[name^="purchase_voucher_items_set-"][name$="-sgst"]');
                    sgstElement.id = `purchase_voucher_items_set-${formIndex}-sgst`;
                    sgstElement.name = `purchase_voucher_items_set-${formIndex}-sgst`; 
                    sgstElement.value="";

                    const TotalAmountElement = lastRow.querySelector('.purchase-total[name^="purchase_voucher_items_set-"][name$="-total_amount"]');
                    TotalAmountElement.id = `purchase_voucher_items_set-${formIndex}-total_amount`;
                    TotalAmountElement.name = `purchase_voucher_items_set-${formIndex}-total_amount`;
                    TotalAmountElement.value="";

                    const uniqueElement = lastRow.querySelector('.unique-id');
                    uniqueElement.id = `item_unique_id_${formIndex}`;
                    uniqueElement.name = `item_unique_id_${formIndex}`;
                    uniqueElement.value= uuidv4();

                    const backendQtyElement = lastRow.querySelector('input[name^="purchase_voucher_items_set-"][name$="-jsonDataInputquantity"]');
                    backendQtyElement.id = `purchase_voucher_items_set-${formIndex}-jsonDataInputquantity`;
                    backendQtyElement.name = `purchase_voucher_items_set-${formIndex}-jsonDataInputquantity`;
                    backendQtyElement.value= "";
                    
                    const popUpElement = lastRow.querySelector('input[name^="purchase_voucher_items_set-"][name$="-popupData"]');
                    popUpElement.id = `purchase_voucher_items_set-${formIndex}-popupData`;
                    popUpElement.name = `purchase_voucher_items_set-${formIndex}-popupData`;
                    popUpElement.value= "";


                    const deleteElement = lastRow.querySelector('input[name^="purchase_voucher_items_set-"][name$="-DELETE"]');
                    deleteElement.id = `purchase_voucher_items_set-${formIndex}-DELETE`;
                    deleteElement.name = `purchase_voucher_items_set-${formIndex}-DELETE`;
                    deleteElement.value= "";
                    
                    const deletedCheckBoxElement = lastRow.querySelector('input[name^="purchase_voucher_items_set-"][name$="-deleteJsonData"]');
                    deletedCheckBoxElement.id = `purchase_voucher_items_set-${formIndex}-deleteJsonData`;
                    deletedCheckBoxElement.name = `purchase_voucher_items_set-${formIndex}-deleteJsonData`;
                    deletedCheckBoxElement.value = '';

                    const olditemshadeElement = lastRow.querySelector('input[name^="purchase_voucher_items_set-"][name$="-old_item_shade"]');
                    olditemshadeElement.id = `purchase_voucher_items_set-${formIndex}-old_item_shade`;
                    olditemshadeElement.name = `purchase_voucher_items_set-${formIndex}-old_item_shade`;
                    olditemshadeElement.value = '';

                    const olditemshadeElementforupdate = lastRow.querySelector('input[name^="purchase_voucher_items_set-"][name$="-old_item_shade_for_dropdown_change"]');
                    olditemshadeElementforupdate.id = `purchase_voucher_items_set-${formIndex}-old_item_shade_for_dropdown_change`;
                    olditemshadeElementforupdate.name = `purchase_voucher_items_set-${formIndex}-old_item_shade_for_dropdown_change`;
                    olditemshadeElementforupdate.value = '';

                    const checkIdElement = lastRow.querySelector('input[name^="item_checkshade-"]');
                    checkIdElement.id = `id_item_checkshade-${formIndex}`;
                    checkIdElement.name = `item_checkshade-${formIndex}`;
                    checkIdElement.value= '';


                    formCountInput.value = formCount + 1; 
                    tableBody.appendChild(lastRow);
                
                }
                document.getElementById('id_productRow').value = '1';
                calculateTotalAmount();
                calculateOtherTotal();
                deleteRowData();
                inputCheck();
            }   
             
        });
        
    }else{
        console.error("Could not find addFormButton or table body element.");

    }


    });

   function deleteRowData(){
    // Add click event listener to all delete buttons
    document.querySelectorAll('.delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            // Find the row containing the clicked delete button
            const row = this.closest('tr');
            const checkRow = row.querySelector('.godown_deleteId[name^="purchase_voucher_items_set-"][name$="-DELETE"]');
            if (checkRow) {
                checkRow.checked = true; // Mark as checked
                checkRow.value = 'true'; // Set the value to 'true'

                row.style.display = 'none';
                calculateTotalAmount();
                calculateOtherTotal();
                inputCheck();
                
            } else {
                console.error("Checkbox for deletion not found in this row");
            }
        });
      
    });
 
  };
 deleteRowData();
 calculateTotalAmount();
 calculateOtherTotal();

</script>
<script>
    const form = document.getElementById("newForm");
    const submitButton = document.getElementById("parentFormClick");
  
    // Prevent Enter key from submitting the form
    form.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
      }
    });
  
    // Only submit the form when the submit button is clicked
    submitButton.addEventListener("click", function(event) {
      form.submit();
    });

    document.addEventListener("DOMContentLoaded", function () {
    const submitButton = document.getElementById("parentFormClick");
    const itemNameInputs = document.querySelectorAll("input[id^='item_name_']");
    const itemShadeSelects = document.querySelectorAll("select[id$='-item_shade']");

    function validateInputs() {
        let isValid = true;

        // Check all item name inputs
        itemNameInputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
            }
        });

        // Check all item shade selects
        itemShadeSelects.forEach(select => {
            if (!select.value.trim()) {
                isValid = false;
            }
        });

        // Enable or disable the submit button
        submitButton.disabled = !isValid;
        submitButton.style.cursor = 'not-allow'
    }

    // Attach event listeners to inputs and selects
    itemNameInputs.forEach(input => {
        input.addEventListener("input", validateInputs);
    });

    itemShadeSelects.forEach(select => {
        select.addEventListener("change", validateInputs);
    });

    
    // Initial validation on page load
    validateInputs();
    inputCheck();
});


function inputCheck(){
        const itemNameInputsid = document.querySelectorAll('[name^="item_name_"]');
    console.log(itemNameInputsid)
    // Loop through each input and add keydown event listener
    itemNameInputsid.forEach((input, index) => {
        input.addEventListener("keydown", function (event) {
            if (event.key === "Tab") {
                event.preventDefault(); // Prevent default tab behavior

                // Check if the current input has a value
                if (input.value.trim() !== "") {
                    // If not the last input, move focus to the next row's item name
                    if (itemNameInputsid[index + 1]) {
                        itemNameInputsid[index + 1].focus();
                    }
                } else {
                    // If current input is empty, refocus on it
                    input.focus();
                }
            }
        });
    });
    }
  </script>

{% endblock body %}