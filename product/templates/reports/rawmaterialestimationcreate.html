{% extends 'product/base.html' %}
{% block body %}

<div class="mt-2">
    <form method="POST">
        {% csrf_token %}
        <div class="mb-3">
            <label class="item-form">Material Godown Id :</label>
            <select type="text" class="item-select" name="raw_material_godown_id" id="id_raw_material_godown_id">
                {% if product_estimation_form.instance.id %}
                <option value="{{product_estimation_form.instance.raw_material_godown_id.id}}">{{product_estimation_form.instance.raw_material_godown_id.godown_name_raw}}</option>

                {% for x in godown_id %}
                <option value="{{x.id}}">{{x.godown_name_raw}}</option>
                {% endfor %}
                {% elif not product_estimation_form.instance.id %}
                <option value=""></option>
                {% for x in godown_id %}
                <option value="{{x.id}}">{{x.godown_name_raw}}</option>
                {% endfor %}
                {% endif %}
            </select>
            <input type="hidden" id="id_unique_Value" name="unique_id" value="{{product_estimation_form.instance.pk}}">
            {% if instance_exists_check %}
            <button class="create-btn mt-3" id="calculate" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="calteRawMaterial(this)">Calculate</button>
            {% endif %}
        </div>
        
<div class="row">
    <div class="col-lg-8">
        <table class="table table-striped table-hover table-bordered" id="rawmaterialId">
            <thead class="name_absolute sticky-top">
                <tr>
                    <th>No</th>
                    <th>Product Id</th>
                    <th>Product Qty </th>
                    <th>Purchase Order Estimation</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody class="mainTableList" >
                {{product_estimation_formset.management_form}}
                {% for form in product_estimation_formset %}
                {{ form.id }}
                <tr>
                    
                    <input type="hidden" id="id_{{form.prefix}}-newid" name="{{form.prefix}}-newid" value="{{form.instance.id}}" class="newIdInstance">
                    <td><span>{{forloop.counter}}</span></td>
                    <td>
                        <select type="text" class="item-select" name="{{form.prefix}}-product_id" id="id_{{form.prefix}}-product_id">
                            
                            {% if form.instance.id %}
                            <option value="{{form.instance.product_id.id}}">{{form.instance.product_id.Product_Name}}</option>

                            {% for x in product_all %}
                            <option value="{{x.id}}">{{x.Product_Name}}</option>
                            {% endfor %}
                            {% elif not form.instance.id %}
                            <option value=""></option>
                            {% for x in product_all %}
                            <option value="{{x.id}}">{{x.Product_Name}}</option>
                            {% endfor %}
                            {% endif %}


                        </select>
                    </td>
                    <td>
                        <input type="number" class="item-select" name="{{form.prefix}}-total_product_qty" value="{{form.instance.total_product_qty}}" id="id_{{form.prefix}}-total_product_qty">
                    </td>
                    <td>{% if form.instance.id %}
                        <button type="button" class="rounded px-3 py-1 bg-success text-white border-0" id="{{form.prefix}}-clickBtn" onclick="openRawMaterialPopup(this)">click</button>
                        {% if form.instance.raw_material_product_ref_itemss_p_2_i.exists %}
                        <span class="ms-3 text-success" id="{{form.prefix}}-icons"><i class="fa-solid fa-circle-check fs-4"></i></span>
                        {% endif %}
                        {% endif %}
                        
                    </td>
                    <td><span class="delete-btn border-0 bg-transparent" style="cursor: pointer;"><i class="fa-solid fa-trash text-danger px-3 py-2 fs-6"><input type="checkbox" class="stock_deleteId px-2" style="display: none;" name="{{form.prefix}}-DELETE"id="id_{{form.prefix}}-DELETE" value=""></i></span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div>
        <button type="button" class="item-btn" id="addRowMaterial">Add +</button>
    </div> 
</div>
        <button type="submit" class="create-btn mt-3">Submit</button>
    </form>


</div> 

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content" style="width: 136% !important">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Raw Material Estimation Calculation </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <table class="table table-striped table-hover table-bordered text-nowrap" >
                <thead class="name_absolute">
                    <tr>
                        <th>Product Name</th>
                        <th>Total Consump</th>
                        <th>Godown Stock</th>
                        <th>Balance Stock</th>
                    </tr>
                </thead>
                <tbody class="mainTableList calculateTable">
                    
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="add_btn rounded-2" data-bs-dismiss="modal">Close</button>
          <button type="button" class="modal-btn" onclick="dowunloadExel(this)">Download Excel</button>
        </div>
      </div>
    </div>
  </div>
<script>
     document.body.appendChild(document.getElementById('exampleModal'));
        function calteRawMaterial(button){
    
            var unique_id = document.getElementById('id_unique_Value').value;
            $.ajax({  
                url:"/rawmaterialestimationcalculate/",   
                type:"GET",   
                data:{'unique_id':unique_id},
    
                success:function(data){
                    var responseData = data.response_dict
                    var table = document.querySelector('.calculateTable');
    
                    table.innerHTML = ''; // Clear previous table rows
                    responseData.forEach(function(items){
                        var itemName = items.item_name || 'N/A';
                        var totalConsump = items.total_consump || 0;
                        var godownStock = items.godown_stock|| 0;
                        var balanceStock = items.balance_stock || 0;
    
                        var row = document.createElement('tr');

                        var cell1 = document.createElement('td');
                        cell1.textContent = itemName;
                
                        var cell2 = document.createElement('td');
                        cell2.textContent = totalConsump;
                        var cell3 = document.createElement('td');
                        if(godownStock < "0"){
                            cell3.style.color = "red";
                        }else{
                            cell3.style.color='green';
                        }
                        cell3.textContent = godownStock;
                        var cell4 = document.createElement('td');
                        if(balanceStock < "0"){
                            cell4.style.color='red';
                         
                        }else{
                            cell4.style.color='green';
                
                        }

                        cell4.textContent = balanceStock;
                     
                        row.appendChild(cell1);
                        row.appendChild(cell2);
                        row.appendChild(cell3);
                        row.appendChild(cell4);

                        table.appendChild(row);
                    })
                    
                }
    
            })
        }
    // calteRawMaterial()

    function dowunloadExel(click){
        var unique_id = document.getElementById('id_unique_Value').value;
        $.ajax({
            url:"//",   
            type:"GET",   
            data:{'unique_id':unique_id},
            success:function(data){
                console.log(data);
            }
        })
    }
    document.addEventListener('DOMContentLoaded', function () {

        const addnewButton = document.getElementById('addRowMaterial');
        const table = document.querySelector('.mainTableList');
        if (addnewButton && table) {
            addnewButton.addEventListener('click', function () {
                let lastVisibleRow = null;
                table.querySelectorAll('tr').forEach(row => {
                    if (window.getComputedStyle(row).display !== 'none') {
                        lastVisibleRow = row;
                    }
                });
                if(lastVisibleRow){
                    const newForm = document.getElementById('id_raw_material_production_estimations-TOTAL_FORMS');
                    const newFormCount = parseInt(newForm.value);
                    const newTable = lastVisibleRow.cloneNode(true);

                    newTable.querySelectorAll("input select").forEach(function (e) {
                        e.value = "";
                    });

                    const newIds = newTable.querySelector('[name^="raw_material_production_estimations-"][name$="-newid"]');
                    newIds.id = `id_raw_material_production_estimations-${newFormCount}-newid`;
                    newIds.name = `raw_material_production_estimations-${newFormCount}-newid`;
                    newIds.value = "";

                    const ids = newTable.querySelector('span');
                    ids.id = `id_raw_material_production_estimations-${newFormCount}`;
                    ids.textContent = newFormCount + 1;

                    const newProductId = newTable.querySelector('select[name$="-product_id"]');
                    newProductId.id = `id_raw_material_production_estimations-${newFormCount}-product_id`;
                    newProductId.name = `raw_material_production_estimations-${newFormCount}-product_id`;
                    newProductId.value = "";
                    // newProductId.innerHTML = "";

                    const newproductQty = newTable.querySelector('input[name$="-total_product_qty"]');
                    newproductQty.id = `id_raw_material_production_estimations-${newFormCount}-total_product_qty`;
                    newproductQty.name = `raw_material_production_estimations-${newFormCount}-total_product_qty`;
                    newproductQty.value = "";

                    const deleteElement = newTable.querySelector('input[name^="raw_material_production_estimations-"][name$="DELETE"]');
                    deleteElement.id = `id_raw_material_production_estimations-${newFormCount}-DELETE`;
                    deleteElement.name = `raw_material_production_estimations-${newFormCount}-DELETE`;
                    deleteElement.value = "";
                    deleteElement.checked = false;

                    const clickBtns = newTable.querySelector('button[id$="-clickBtn"]');
                    clickBtns.id = `id_raw_material_production_estimations-${newFormCount}-clickBtn`;
                    clickBtns.style.display = 'none';

                    const newIcons = newTable.querySelector('span[id$="-icons"]')
                    newIcons.id = `id_raw_material_production_estimations-${newFormCount}-icons`;
                    newIcons.style.display ='none';

                    
                    newForm.value = newFormCount + 1;

                    table.appendChild(newTable);
                    deleteRow();
                }

            })

        }

    })
    function deleteRow(){
        document.querySelectorAll('.delete-btn').forEach(function (button) {
        button.addEventListener('click',function(){
            var newRow = this.closest('tr');
            var checkList = newRow.querySelector('.stock_deleteId[name^="raw_material_production_estimations-"][name$="-DELETE"]');
            if(checkList){
                checkList.checked = true;
                checkList.value = 'true';
                newRow.style.display = 'none';
            }else {
                console.error("Checkbox for deletion not found in this row");
            }

        })
    })
    }
    deleteRow()

  

    var popUpNewWindow = null;
    function openRawMaterialPopup(button){
    openNewPopup(button, '/rawmaterialestimationpopup/');
}

function openNewPopup(button, url){
    if (popUpNewWindow === null || popUpNewWindow.closed) {
        newPopUpwindow(button, url);
    } else {
  
        popUpNewWindow.focus();
    }
}

function newPopUpwindow(button, path){
    // Specify minimum height and width
  var minWidth = 1150; // minimum width
  var minHeight = 800; // minimum height
  var instanceid = $(button).closest('tr').find('.newIdInstance').val();
  console.log(instanceid)     
    if(instanceid){
         // Open new page with specified dimensions
  popUpNewWindow = window.open(path + instanceid, '_blank', 'width=' + minWidth + ', height=' + minHeight + ', resizable=yes'); 
    }

    // Ensure only one event listener is attached
;
}
</script>


{% endblock %}
